-- SHASHANK

/****** Object:  StoredProcedure [dbo].[spPAY_RptVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptVacationDays]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[spPAY_RptVacationDays]
GO
/****** Object:  StoredProcedure [dbo].[spPAY_RptGetVacationLedger]    Script Date: 22-01-2026 15:28:11 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptGetVacationLedger]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[spPAY_RptGetVacationLedger]
GO
/****** Object:  StoredProcedure [dbo].[spPAY_GetRemainingVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_GetRemainingVacationDays]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[spPAY_GetRemainingVacationDays]
GO
/****** Object:  StoredProcedure [dbo].[spPAY_ExtGetVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_ExtGetVacationDays]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[spPAY_ExtGetVacationDays]
GO
/****** Object:  StoredProcedure [dbo].[spPAY_ExtGetVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_ExtGetVacationDays]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
--EXEC spPAY_ExtGetVacationDays ''01-jun-2017'',''30-jun-2017'',109,0,0
CREATE procedure [dbo].[spPAY_ExtGetVacationDays]
@FromDate DateTime,
@ToDate DateTime,
@EmpNode INT,
@DocID INT=0,
@OpBalDays Float,
@ParamExcDays FLOAT=0,
@Calcdays float=0,
@UserID Int=1,
@LangID Int=1
AS
BEGIN
SET NOCOUNT ON;

DECLARE @RoundOffVacDays BIT
SET @RoundOffVacDays=1

Declare @DimVacDays Float,@BelowSixmonthsDays Float,@BelowOneyearDays Float,@Calculatevacdayforvacationperiod Varchar(3),@ConsiderVacationdayforExcessVacationDays Varchar(3)
Declare @ExcludeWeeklyOffsasVacation Varchar(3),@ExcludeHolidaysasVacation Varchar(3),@ConsiderLOPwhilecalculatingcreditdays Varchar(3),@ConsiderExcessdaysasLOP Varchar(3)
Declare @Perdaysalarycalculations Varchar(50),@GradewiseVacationPref Varchar(5),@CreditDaysBasedOnMP Int,@LeaveType INT
Declare @NoOfHolidays Int,@WeeklyOffCount Int,@Grade Int,@Year Int,@ALStartMonth Int,@ALStartMonthYear DateTime,@ALEndMonthYear DateTime,@LstVacFromDate DateTime

DECLARE @MONTH111 DATETIME,@MONTH222 DATETIME
DECLARE @MONTH13 DATETIME,@MONTH14 DATETIME

Declare @Month1 DateTime,@Month2 DateTime,@Month3 DateTime,@Month4 DateTime,@Month5 DateTime,@Month6 DateTime
Declare @Month7 DateTime,@Month8 DateTime,@Month9 DateTime,@Month10 DateTime,@Month11 DateTime,@Month12 DateTime,@ActualVacDate DateTime,@ActDOJ DateTime  
Declare @Doj DateTime,@Dorj DateTime,@VacationMonthsDiff Float,@VacationPeriod Varchar(20),@VacDaysPerMonth Float,@VacDaysPeriod Varchar(20),@TMONTHS Int,@MonthlyNoofDays Float,@VacationStartMonth DateTime
Declare @OPLeavesAsOn DateTime,@OpVacDays Float, @LocID INT,@PayrollDate DATETIME,@VacDays Float,@INCREXC VARCHAR(50),@ProbationPeriodPref nvarchar(5)
Declare @TotalCreditedDays Float,@SumofOPandTotalCreditDays Float,@CalcVacDaysuptoLastMonth Varchar(5),@LOANFROMDATE DateTime,@DOConfirmation DateTime,@AccrueVacationDaysPref nvarchar(5)
Declare @CreditDaysCalculation Int,@LeaveTypeName NVARCHAR(500),@CalcFromLastVacFromDate NVARCHAR(10),@CalcCreditFromDOJ NVARCHAR(10),@LEAVESTAKENSUM FLOAT,@CNT INT
DECLARE @LEAVESTAKEN FLOAT,@LeavesTakenEncash FLOAT,@LeavesTakenEncashSUM FLOAT,@LastReJoinDate DATETIME,@DORESIGN FLOAT,@DORELIEVE FLOAT,@Calculatecreditdayduringnoticeperiod Varchar(3),@CalcLopFromDocsifPayrollNotProcessed NVARCHAR(10),@ConsiderCreditDaysforVacationPeriodonNextVacation nvarchar(6)

--VMDD
DECLARE @VacMgmtDocID INT, @IsDefineDaysExists BIT
CREATE TABLE #VMDD(FromMonth INT,ToMonth INT,DaysPerMonth FLOAT,ApplyToPrevMonths NVARCHAR(50),WEF DATETIME)
CREATE TABLE #VacMonthWiseAllotedDays(ID INT Identity(1,1),VacMonth DateTime,AllotedDays FLOAT,Yearly FLOAT)
--VMDD

SET @LeavesTakenEncashSUM=0
SET @LEAVESTAKENSUM=0

Declare @TABLOANDETAILS Table(SNO Int IDENTITY(1,1),LoanTypeID Int,LoanAmount Float)
Declare @MonthTab Table(ID INT Identity(1,1),STDATE DateTime,EDDATE DateTime)
Declare @MonthDays Table(ID INT Identity(1,1),FDATE DateTime,TDATE DateTime,TOTALDAYS FLOAT,ACTUALDAYS FLOAT,Days Float)
Declare @ComponentID Int,@COMPONENTIDSNO Int,@dcNumFiled Varchar(10),@syColName Varchar(15),@strQry NVarchar(max)
Declare @TAB Table(VacationDays Float,FromDate DateTime,TODATE DateTime,AppliedDays Float,ApprovedDays Float,PaidDays Float,CreditedDays Float,ExcessDays Float,RemainingDays Float,TotalTaken FLOAT,VActualDays Float)
Create Table #VacDayTab (VacDays Float,Payrolldate Datetime)--VDAYS

CREATE TABLE #TVacLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME)
CREATE TABLE #TLeaveLOP(ID INT IDENTITY(1,1),LeaveID BIGINT,FROMDATE DATETIME,TODATE DATETIME,NoOfDays FLOAT)
CREATE TABLE #TVacExcessLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME,PaidDays FLOAT,ExcessDays FLOAT)
DECLARE @TAB2 TABLE(ID INT IDENTITY(1,1),MONT1 DATETIME,MONT2 DATETIME,LEAVETYPEID BIGINT)

DECLARE @LOPRD DATETIME,@LOPFD DATETIME,@LOPTD DATETIME,@TVacLOPCNT INT ,@I INT,@dttmp1 DATETIME,@dttmp DATETIME,@ids FLOAT, @ConsiderLOPBasedOn NVARCHAR(500)
DECLARE @TLeaveLOPCNT INT,@K INT,@LeaveID INT,@CurrYearLeavestaken DECIMAL(9,2),@NOOFHOLIDAYS1 INT,@WEEKLYOFFCOUNT1 INT,@EXSTAPPLIEDENCASHDAYS DECIMAL(9,2),@STR NVARCHAR(MAX)
DECLARE @LOPEXRD DATETIME,@LOPEXFD DATETIME,@LOPEXTD DATETIME,@TVacEXLOPCNT INT ,@L INT,@EXPAIDDAYS FLOAT,@EXEXCESSDAYS FLOAT,@CNT3 INT,@Y INT,@LDAYS FLOAT,@LOPNoOfDays FLOAT

SELECT @ConsiderLOPBasedOn=ISNULL(Value,'''') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''ConsiderLOPBasedOn''

--SET TO FIRST DAY FOR THE GIVEN DATE
SET @PayrollDate=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@FromDate)),0)
--LOADING PREFERENCES
SELECT @CalcVacDaysuptoLastMonth=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''CalcVacDaysuptolastmonth''
SELECT @AccrueVacationDaysPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''AccrueVacationDays''
SELECT @RoundOffVacDays=ISNULL(VALUE,''True'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''RoundOffVacationCreditDays''

SELECT @DORESIGN=DORESIGN,@DORELIEVE=DORELIEVE FROM COM_CC50051 WITH(NOLOCK) WHERE NODEID=@EmpNode AND RESIGNSTATUS=''Posted''

IF(@ToDate>CONVERT(DATETIME,@DORELIEVE))
	SET @ToDate=@DORELIEVE

--START :GET DOJ,VACATIONPERIOD AND VACATION Days FROM EMPLOYEE
SELECT @OPLeavesAsOn=CONVERT(DateTime,OPLeavesAsOn),@OpVacDays=isnull(OpVacationDays,0),@Doj=CONVERT(DateTime,Doj),@VacationPeriod=VacationPeriod,@VacDaysPerMonth=ISNULL(VacDaysPerMonth,0),@VacDaysPeriod=VacDaysPeriod,@DOConfirmation=Convert(DateTime,DOConfirmation) 
FROM COM_CC50051 WITH(NOLOCK) WHERE NODEID=@EmpNode
SET @ActDOJ=@Doj

IF(convert(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'')
BEGIN
	SET @Doj=@OPLeavesAsOn
END
--END :GET DOJ,VACATIONPERIOD AND VACATION Days FROM EMPLOYEE	
IF((SELECT COUNT(CostCenterID) FROM ADM_CostCenterDef WITH(NOLOCK) WHERE CostCenterID=50051 and SysColumnName =''CCNID2'' and IsColumnInUse=1 and UserProbableValues=''H'')>0)
	SELECT @LocID=HistoryNodeID FROM COM_HistoryDetails WITH(NOLOCK) WHERE NodeID=@EmpNode AND CostCenterID=50051 AND HistoryCCID=50002 AND (FromDate<=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate))) AND (ToDate>=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate)) OR ToDate IS NULL)
ELSE
	SELECT @LocID=ISNULL(CC.CCNID2,1) FROM COM_CC50051 C51 WITH(NOLOCK),COM_CCCCDATA CC  WITH(NOLOCK) WHERE C51.NODEID=CC.NODEID AND C51.NODEID=@EmpNode AND CC.CostCenterID=50051

PRINT ''Loc''
PRINT @LocID	
--CHECKING FOR THE EMPLOYEE PROBATION PERIOD
IF(CONVERT(DATETIME,@FromDate)<=CONVERT(DATETIME,@DOConfirmation))
BEGIN
	SELECT @ProbationPeriodPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''DonotAllowVacationDuringProbationPeriod''
	IF (@ProbationPeriodPref=''True'')
		SELECT ''Employee is in probation period, cannot apply the vacation'' as ProbationPeriodMessage
	ELSE
		SELECT '''' as ProbationPeriodMessage
END	
ELSE
	SELECT '''' as ProbationPeriodMessage
--CHECKING FOR THE EMPLOYEE PROBATION PERIOD
--CHECKING DATES FOR APPLIED VACATION
IF((SELECT COUNT(ID.DocID)  FROM INV_DOCDETAILS ID WITH(NOLOCK) 
	JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
	JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
	WHERE  TD.tCOSTCENTERID=40072 AND CC.DCCCNID51=@EmpNode AND ID.DOCID<>@DocID AND isnull(TD.DCALPHA16,'''')=''No'' AND ID.DOCID<>@DocID AND  ID.STATUSID NOT IN (372,376) AND ISDATE(DCALPHA2)=1 AND ISDATE(DCALPHA3)=1 
		   AND (
			CONVERT(DateTime,dcAlpha2) between CONVERT(DateTime,@FromDate) and CONVERT(DateTime,@ToDate)
		   or (CASE WHEN dcAlpha1 IS NULL THEN DATEADD(D,1,CONVERT(DateTime,dcAlpha3)) ELSE DATEADD(D,-1,CONVERT(DateTime,dcAlpha1)) END  ) between CONVERT(DateTime,@FromDate) and CONVERT(DateTime,@ToDate)
		   or CONVERT(DateTime,@FromDate) between CONVERT(DateTime,dcAlpha2) and (CASE WHEN dcAlpha1 IS NULL THEN DATEADD(D,1,CONVERT(DateTime,dcAlpha3)) ELSE DATEADD(D,-1,CONVERT(DateTime,dcAlpha1)) END  )
		   or CONVERT(DateTime,@ToDate) between CONVERT(DateTime,dcAlpha2) and (CASE WHEN dcAlpha1 IS NULL THEN DATEADD(D,1,CONVERT(DateTime,dcAlpha3)) ELSE DATEADD(D,-1,CONVERT(DateTime,dcAlpha1)) END  )    ))>0 and ISNULL(@Calcdays,0)=0 and @docid<>-200)
BEGIN
	SELECT ''Vacation already applied between selected dates,Please select other dates'' as VacationDaysMessage
END
ELSE
BEGIN
	--START:LOADING PREFERENCES BASED ON GRADE
	SELECT @GradewiseVacationPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''GradeWiseVacation''
	IF (@GRADEWISEVACATIONPREF=''True'')
	BEGIN
		IF((SELECT COUNT(CostCenterID) FROM ADM_CostCenterDef WITH(NOLOCK) WHERE CostCenterID=50051 and SysColumnName =''CCNID53'' and IsColumnInUse=1 and UserProbableValues=''H'')>0)
			SELECT @Grade=ISNULL(HistoryNodeID,0) FROM COM_HistoryDetails WITH(NOLOCK) WHERE NodeID=@EmpNode AND CostCenterID=50051 AND HistoryCCID=50053 AND (FromDate<=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate))) AND (ToDate>=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate)) OR ToDate IS NULL)
		ELSE
			SELECT @Grade=ISNULL(CCNID53,0) FROM COM_CCCCDATA WITH(NOLOCK) WHERE COSTCENTERID=50051 AND NODEID=@EmpNode
	END
	
	IF ISNULL(@GRADE,0)=0
		SET @GRADE=1
		
	PRINT ''GRADE''
	PRINT @GRADE
	SELECT @BelowSixmonthsDays=ISNULL(TD.DCALPHA3,''0''),@BelowOneyearDays=ISNULL(TD.DCALPHA4,''0''),@Calculatevacdayforvacationperiod=ISNULL(TD.DCALPHA9,''NO''),@ConsiderVacationdayforExcessVacationDays=ISNULL(TD.DCALPHA19,''Yes''),
		   @ConsiderLOPwhilecalculatingcreditdays=ISNULL(TD.DCALPHA8,''NO''),@ConsiderExcessdaysasLOP=ISNULL(TD.DCALPHA15,''NO''), @Perdaysalarycalculations=ISNULL(TD.DCALPHA16,''(FIELD/30)'') ,@CreditDaysBasedOnMP=ISNULL(dcAlpha5,0),@LeaveType=isnull(TD.DCALPHA1,''0''),
		   @CreditDaysCalculation=ISNULL(TD.DCALPHA18,''1''),
		   @VacMgmtDocID=ID.DocID,@Calculatecreditdayduringnoticeperiod=ISNULL(TD.DCALPHA21,''Yes''),@LeaveTypeName=C52.Name, @CalcFromLastVacFromDate=ISNULL(TD.DCALPHA22,''No''),@CalcCreditFromDOJ=ISNULL(TD.DCALPHA23,''No''),@CalcLopFromDocsifPayrollNotProcessed=ISNULL(TD.DCALPHA24,''No''),@ConsiderCreditDaysforVacationPeriodonNextVacation=ISNULL(TD.dcAlpha22,''No'')
	FROM   INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.NodeID=CONVERT(BIGINT,TD.dcAlpha1)
	WHERE  TD.tCostCenterID=40061 AND CC.DCCCNID53=@Grade 
	
--SET @CreditDaysCalculation=3
--SET @RoundOffVacDays=0

	IF(@DocID=-200)
	BEGIN
		SET @CalculateVacDayforVacationPeriod=''Yes''
		SET @CalcFromLastVacFromDate=''No''
	END

	--VMDD
	SET @IsDefineDaysExists=0
	IF EXISTS (SELECT SeqNo FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID)
	BEGIN
		SET @IsDefineDaysExists=1
		INSERT INTO #VMDD
		SELECT FromMonth,ToMonth,DaysPerMonth,ApplyToPrevMonths ,WEF 
		FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID

		DECLARE @VacationDefBasedOn INT
		select @VacationDefBasedOn=ISNULL(PrefValue,1) from COM_DocumentPreferences WITH(NOLOCK) WHERE PrefName=''VacationDefBasedOn''

		declare @dtt1 datetime,@dtt2 datetime,@TotMon INT,@AllotedDays FLOAT,@MNo INT,@APM NVARCHAR(50),@YearlyVD FLOAT
		set @dtt1=dateadd(day,-datepart(day,@ActDOJ)+1,@ActDOJ)
		set @dtt2=dateadd(day,-datepart(day,@ToDate)+1,@ToDate)
		set @dtt2=DATEADD(year,1,@dtt2) -- adding extra 1 year to know the yearly vacation days
		SET @MNo=0
		WHILE(@dtt1<=@dtt2)
		BEGIN
			SET @MNo=@MNo+1

			IF(ISNULL(@VacationDefBasedOn,1)=1)
				SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WHERE @MNo BETWEEN FromMonth AND ToMonth
			ELSE
				SELECT TOP 1 @AllotedDays=DaysPerMonth/12,@APM=ApplyToPrevMonths FROM #VMDD WHERE WEF<=@dtt1 ORDER BY WEF DESC
			
			SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WHERE @MNo BETWEEN FromMonth AND ToMonth
			INSERT INTO #VacMonthWiseAllotedDays
			SELECT @dtt1,@AllotedDays,-1

			IF(@APM=''Yes'')
				UPDATE #VacMonthWiseAllotedDays SET AllotedDays=@AllotedDays

			IF(@MNo%12)=0
			BEGIN
				SELECT @YearlyVD=SUM(AllotedDays) FROM #VacMonthWiseAllotedDays WHERE Yearly=-1
				
				IF(@APM=''Yes'')
					UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD
				ELSE
					UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD WHERE Yearly=-1

			END

		 SET @dtt1=DATEADD(month,1,@dtt1)
		END

	END
	--SELECT * FROM #VacMonthWiseAllotedDays
	--VMDD
		
	--END:LOADING PREFERENCES BASED ON GRADE
	
	--SET @Calculatevacdayforvacationperiod=''Yes''
	--START: GET VACDAYS FIELD FROM MONTHLY PAYROLL
	SELECT @COMPONENTIDSNO=SNO FROM COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@CreditDaysBasedOnMP AND GRADEID=@Grade AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade)
	SET @syColName=''dcNum''+convert(Varchar,@COMPONENTIDSNO)
	
	IF(ISNULL(@syColName,'''')<>'''' AND ISNULL(@Doj,'''')<>'''' AND ISNULL(@ToDate,'''')<>'''')
	BEGIN
	
		SET @strQry=''INSERT INTO #VacDayTab 
						SELECT  ISNULL(''+ @syColName +'',0),CONVERT(DateTime,ID.DUEDATE)  FROM INV_DOCDETAILS ID WITH(NOLOCK) 
						JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID 
						JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
						WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@EmpNode) +'' AND ID.Vouchertype=11
								AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DUEDATE) BETWEEN CONVERT(DATETIME,''''''+ convert(Varchar,@Doj) +'''''') and CONVERT(DATETIME,''''''+ convert(Varchar,@ToDate)+'''''')''
	PRINT (@strQry)
		EXEC sp_executesql @STRQRY
		
	END
	--END: GET VACDAYS FIELD FROM MONTHLY PAYROLL		
					
	--START:FOR START DATE AND END DATE OF LEAVE YEAR
	EXEC [spPAY_EXTGetLeaveyearDates] @FromDate,@ALStartMonthYear OUTPUT,@ALEndMonthYear OUTPUT,@EmpNode
	
	--START : LOADING MONTHS BASED ON GIVEN DATE RANGE FROM FROMDATE AND TODATE

	SET @MONTH111 =dateadd(m,-2,@ALStartMonthYear)
	SET @MONTH222 =DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear),0))

	SET @Month1 =@ALStartMonthYear
	SET @Month2 =DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+2,0))
	SET @Month3 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+2,0)))
	SET @Month4 =DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+4,0))
	SET @Month5 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+4,0)))
	SET @Month6 = DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+6,0))
	SET @Month7 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+6,0)))
	SET @Month8 = DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+8,0))
	SET @Month9 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+8,0)))
	SET @Month10 = DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+10,0))
	SET @Month11 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+10,0)))
	SET @Month12 = DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+12,0))

	SET @MONTH13 = DATEADD(d,1,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+12,0)))
	SET @MONTH14 = DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ALStartMonthYear)+14,0))
				
	INSERT INTO @MONTHTAB VALUES(@MONTH111,@MONTH222)
	
	INSERT INTO @MonthTab VALUES(@Month1,@Month2)
	INSERT INTO @MonthTab VALUES(@Month3,@Month4)
	INSERT INTO @MonthTab VALUES(@Month5,@Month6)
	INSERT INTO @MonthTab VALUES(@Month7,@Month8)
	INSERT INTO @MonthTab VALUES(@Month9,@Month10)
	INSERT INTO @MonthTab VALUES(@Month11,@Month12)

	INSERT INTO @MONTHTAB VALUES(@MONTH13,@MONTH14)
	--END : LOADING MONTHS BASED ON GIVEN DATE RANGE FROM FROMDATE AND TODATE
	
	IF(@FromDate is not null and @ToDate is not null)
	BEGIN
		--START: FOR WEEKLY OFFS AND HOLIDAYS
		--START :CURRENT DATERANGE LEAVES TAKEN
			--START: LOADING DATES FROM @MonthTab Table	   
			Declare @DATESCOUNT Table (SNO INT Identity(1,1),ID INT ,DATE1 DateTime,DAYNAME Varchar(50),WEEKNO Int,COUNT Int,NOOFDAYS Float)
			Declare @STARTDATE1 DateTime,@ENDATE1 DateTime
			Declare @MRC AS Int,@MC AS Int,@MID Int
			
			SET @MC=1
			
			SELECT @MRC=COUNT(*) FROM @MonthTab
			WHILE (@MC<=@MRC)
			BEGIN
				SELECT @STARTDATE1=CONVERT(DateTime,STDATE),@ENDATE1=CONVERT(DateTime,EDDATE) FROM @MonthTab WHERE ID=@MC
				;WITH DATERANGE AS
				(
				SELECT @STARTDATE1 AS DT,1 AS ID
				UNION ALL
				SELECT DATEADD(DD,1,DT),DATERANGE.ID+1 FROM DATERANGE WHERE ID<=DATEDIFF("d",convert(Varchar,@STARTDATE1,101),convert(Varchar,@ENDATE1,101))
				)
				
				INSERT INTO @DATESCOUNT
				SELECT ROW_NUMBER() OVER (ORDER BY DT) AS ID,DT AS WEEKDATE,DATENAME(DW,DT) AS DAY,0,0,0 FROM DATERANGE	--WHERE (DATEPART(DW,DT)=1 OR DATEPART(DW,DT)=7)
			SET @MC=@MC+1
			END
			--END: LOADING DATES FROM @MonthTab Table
			
			--START: LOADING DATA BASED ON FROMDATE AND TODATE GIVEN 
			Declare @DATESAPPLIEDCOUNT Table (FDATE DateTime,TDATE DateTime,STODATE DateTime,EODATE DateTime,NOOFDAYS Float)
			INSERT INTO @DATESAPPLIEDCOUNT
			SELECT CONVERT(DateTime,dcAlpha2),CONVERT(DateTime,dcAlpha3),CONVERT(DateTime,@FromDate),CONVERT(DateTime,@ToDate),ISNULL(dcAlpha4,0) 
			FROM INV_DOCDETAILS ID WITH(NOLOCK) 
			JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
			JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
			WHERE  TD.tCostCenterID=40072 AND ID.STATUSID NOT IN (372,376) AND ID.DOCID!=@DocID AND CC.DCCCNID51=@EmpNode  
			
			--END: LOADING DATA BASED ON FROMDATE AND TODATE GIVEN				 
							  
			--START: UPDATING @DATESCOUNT Table ''COUNT'' COLUMN TO 1 FROM LIST OF @DATESAPPLIEDCOUNT Table
			Declare @RC AS Int,@IC AS Int,@TRC AS Int,@DTT AS DateTime,@Days Float
			SET @IC=1
			SELECT @TRC=COUNT(*) FROM @DATESCOUNT
			WHILE(@IC<=@TRC)
			BEGIN
				SELECT @DTT=DATE1 FROM @DATESCOUNT WHERE SNO=@IC
				
				SELECT @RC=COUNT(*) FROM @DATESAPPLIEDCOUNT WHERE CONVERT(DateTime,@DTT) between CONVERT(DateTime,FDATE) and CONVERT(DateTime,TDATE)
				UPDATE @DATESCOUNT SET count=ISNULL(@RC,0) WHERE CONVERT(DateTime,DATE1)=CONVERT(DateTime,@DTT)
			SET @IC=@IC+1
			END
			UPDATE DT SET  DT.NOOFDAYS=ISNULL(DAC.NOOFDAYS,0) FROM @DATESCOUNT DT INNER JOIN @DATESAPPLIEDCOUNT DAC ON DT.DATE1=DAC.FDATE AND ISNULL(DAC.NOOFDAYS,0)=0.5
			--END: UPDATING @DATESCOUNT Table ''COUNT'' COLUMN TO 1 FROM LIST OF @DATESAPPLIEDCOUNT Table
		--END :CURRENT DATERANGE LEAVES TAKEN		   

		--START WEEKLYOFF COUNT
			Declare @WEEKOFFCOUNT Table (ID INT ,WEEKDATE DateTime,DAYNAME Varchar(50),WEEKNO Int,COUNT Int,WEEKNOMANUAL Int)
			INSERT INTO @WEEKOFFCOUNT
			EXEC spPAY_GetVacationWeekoff @FromDate,@ToDATE,@EmpNode,0,1,1
		----------------------- 
		--END WEEKLYOFF COUNT
		--COUNTING WEEKLYOFFS IN GIVEN DATERANGE
		SELECT @WeeklyOffCount=COUNT(*) FROM @WEEKOFFCOUNT WHERE COUNT=1 and convert(DateTime,WEEKDATE) between CONVERT(DateTime,@FromDate) and CONVERT(DateTime,@ToDate)
		
		--START : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO ''3- FOR WEEKLYOFF'' 
			UPDATE DATESCOUNT SET DATESCOUNT.count=3 FROM @WEEKOFFCOUNT WEEKOFFCOUNT inner join @DATESCOUNT DATESCOUNT on CONVERT(DateTime,DATESCOUNT.date1)= CONVERT(DateTime,WEEKOFFCOUNT.weekdate) and WEEKOFFCOUNT.count=1
		--END : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO ''3- FOR WEEKLYOFF'' 
		
		--START-- HOLIDAY COUNT
			Declare @HOLIDAYCOUNT Table (ID int Identity(1,1),WEEKDATE Nvarchar(max),Remarks nvarchar(max))
			INSERT INTO @HOLIDAYCOUNT
			EXEC spPAY_GetVacationWeekoff @FromDate,@ToDATE,@EmpNode,1,1,1
		--END -- HOLIDAY COUNT

		--START : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
			UPDATE DATESCOUNT SET DATESCOUNT.count=4 FROM @DATESCOUNT DATESCOUNT 
			inner join @HOLIDAYCOUNT TD on CONVERT(DATETIME,DATESCOUNT.DATE1)=CONVERT(DATETIME,TD.WEEKDATE)
		--END : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
		
		
		
		--END: FOR WEEKLY OFFS AND HOLIDAYS
		
		--COUNTING HOLIDAYS IN GIVEN DATERANGE
		SELECT @NoOfHolidays=COUNT(*) FROM @DATESCOUNT 
		WHERE CONVERT(DATETIME,DATE1) between CONVERT(DATETIME,@FromDate) AND CONVERT(DATETIME,@ToDate) AND COUNT=4
		AND CONVERT(DATETIME,DATE1) NOT IN(select WEEKDATE from @WEEKOFFCOUNT WHERE COUNT=1 and convert(DateTime,WEEKDATE) between CONVERT(DateTime,@FromDate) and CONVERT(DateTime,@ToDate))
		--END HOLIDAYS COUNT

		
		DECLARE @TMP INT
		SET @TMP=0
		--START : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ
		IF (((SELECT count(id.DocID)  FROM INV_DOCDETAILS ID WITH(NOLOCK) 
		JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
		JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
			 WHERE TD.tCOSTCENTERID=40072 AND CC.DCCCNID51=@EmpNode AND ID.StatusID NOT IN(372,376) AND ID.DOCID<>@DocID AND LEN(TD.Dcalpha3)<=15 AND ISDATE(TD.Dcalpha3)=1
			 AND CONVERT(DateTime,TD.Dcalpha3)<@FromDate
			 --AND ISNULL(TD.DCALPHA2,'''')<>'''' AND ISNULL(TD.DCALPHA3,'''')<>'''' AND(ISNULL(TD.DCALPHA1,'''')<>'''' OR ISNULL(TD.DCALPHA14,'''')<>'''')
			 )>0 AND @CalcCreditFromDOJ=''No'' AND isnull(@CreditDaysBasedOnMP,0)=0 AND ISNULL(@Calcdays,0)=0) or @DocID=-200)
		BEGIN
			--DATE OF REJOING
			SELECT @VacationStartMonth=CONVERT(DateTime,TD.DCALPHA1),@LstVacFromDate=CONVERT(DateTime,TD.DCALPHA2) 
			FROM INV_DOCDETAILS ID WITH(NOLOCK) 
			JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
			JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID	
			WHERE TD.tCOSTCENTERID=40072 AND CC.DCCCNID51=@EmpNode AND ID.DOCID<>@DocID AND ID.StatusID NOT IN(372,376) AND LEN(TD.Dcalpha3)<=15
			AND ISDATE(TD.Dcalpha3)=1 AND ISDATE(TD.Dcalpha2)=1 AND ISDATE(TD.Dcalpha1)=1 
			AND CONVERT(DateTime,TD.Dcalpha3)<@FromDate
			--AND ISNULL(TD.DCALPHA2,'''')<>'''' AND ISNULL(TD.DCALPHA3,'''')<>'''' AND ISNULL(TD.DCALPHA1,'''')<>'''' 
			ORDER BY CONVERT(DateTime,TD.Dcalpha1) ASC
             print @VacationStartMonth 

			 set @LastReJoinDate=@VacationStartMonth

			 if(@CalcFromLastVacFromDate=''Yes'')
				set @VacationStartMonth=@LstVacFromDate

			--VACATION MONTHS DIFFERENCE
			SET @TMP=1
			IF (@CalcVacDaysuptoLastMonth=''False'')
				SET @VacationStartMonth=CONVERT(DATETIME,@VacationStartMonth)
			ELSE
				SET @VacationStartMonth=CONVERT(DATETIME,DATEADD(DAY,-DAY(@LstVacFromDate)+1,@LstVacFromDate))
				--SET @VacationStartMonth=CONVERT(DATETIME,DATEADD(MONTH,DATEDIFF(MONTH,-1,CONVERT(DATETIME,@VacationStartMonth))-2,0))	

			if(@DocID=-200)
				set @VacationStartMonth=@FromDate

			IF(@CalculateVacDayforVacationPeriod=''Yes'')					
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,0,@ToDate))+1	
			ELSE
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@FromDate))	+1
			
			SELECT @DimVacDays=ISNULL(VACDAYS,0) FROM #VACDAYTAB
			
			declare @VMD FLOAT,@VSM DATETIME
			SET @VSM=@ActDOJ
			--VACATION MONTHS DIFFERENCE
			IF(@CalculateVacDayforVacationPeriod=''Yes'')
				SET @VMD=  DATEDIFF(MONTH,@VSM,DATEADD(D,-1,@ToDate))+1
			ELSE
				SET @VMD=DATEDIFF(MONTH,@VSM,DATEADD(D,-1,@FromDate))+1

			--select @VMD
			--
			IF ISNULL(@DimVacDays,0)>0
			BEGIN
				SET @MonthlyNoofDays=@DimVacDays/12
			END
			ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD<=6
			BEGIN
				SET @MonthlyNoofDays=@BelowSixmonthsDays
			END
			ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD>6 And @VMD<=12 
			BEGIN
				SET @MonthlyNoofDays=@BelowOneyearDays
			END
			ELSE
			BEGIN
				IF @VACDAYSPERIOD=''Yearly''
				BEGIN
					SET @TMONTHS=12
				END
				ELSE
				BEGIN
					SET @TMONTHS=1
				END
				SET @MonthlyNoofDays=@VACDAYSPERMONTH/@TMONTHS
			END	
			print @MonthlyNoofDays	
			print @VacationMonthsDiff				
		END
		ELSE
		BEGIN--NO PREVIOUS VACATION FOUND
			--DATE OF JOINING
			SET @TMP=0
			
			SET @VacationStartMonth=@ActDOJ
			set @LastReJoinDate=@VacationStartMonth
			--VACATION MONTHS DIFFERENCE
			IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
			BEGIN
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@FromDate))+1
			END
			ELSE 
			BEGIN
			IF(@CalculateVacDayforVacationPeriod=''Yes'' AND @CalcFromLastVacFromDate=''No'' )
				SET @VacationMonthsDiff=  DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@ToDate))+1
			ELSE
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@FromDate))+1
			END

			IF(ISNULL(@CreditDaysBasedOnMP,0)=0)
			BEGIN
				--GET VacDays FROM MONTHLY PAYROLL
				SET @DimVacDays=(SELECT ISNULL(VacDays,0) FROM #VacDayTab)
			
				--PICKING THE PERMONTH DAYS
				IF ISNULL(@DimVacDays,0)>0
				BEGIN
					SET @MonthlyNoofDays=@DimVacDays/12
				END
				ELSE IF ISNULL(@DimVacDays,0)=0 AND @VacationMonthsDiff<=6
				BEGIN
					SET @MonthlyNoofDays=@BelowSixmonthsDays

					if(ISNULL(@Calcdays,0)=6)
					begin
						SET @MonthlyNoofDays=@BelowOneyearDays
					end

				END
				ELSE IF ISNULL(@DimVacDays,0)=0 AND @VacationMonthsDiff>6 And @VacationMonthsDiff<=12 
				BEGIN
					SET @MonthlyNoofDays=@BelowOneyearDays

					if(ISNULL(@Calcdays,0)=12)
					begin
						IF @VacDaysPeriod=''Yearly''
						SET @TMONTHS=12
						ELSE
							SET @TMONTHS=1
						SET @MonthlyNoofDays=@VacDaysPerMonth/@TMONTHS
					end
				END
				ELSE
				BEGIN
					IF @VacDaysPeriod=''Yearly''
						SET @TMONTHS=12
					ELSE
						SET @TMONTHS=1
				SET @MonthlyNoofDays=@VacDaysPerMonth/@TMONTHS
				END
			END
		END
		
		--END : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ	
		IF(convert(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'' AND (@TMP=0 OR convert(DateTime,@OPLeavesAsOn)>=convert(DateTime,@VacationStartMonth)))
		BEGIN
			SET @VacationStartMonth=@Doj
			set @LastReJoinDate=@VacationStartMonth
		END

		IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
		BEGIN
			SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@FromDate))
		END
		ELSE 
		BEGIN
			IF(@CalculateVacDayforVacationPeriod=''Yes'' AND @CalcFromLastVacFromDate=''No'')
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,0,@ToDate))
			ELSE
				SET @VacationMonthsDiff=DATEDIFF(MONTH,@VacationStartMonth,DATEADD(D,-1,@FromDate))
		end

		--START : CALCULATING PER MONTH DAYS
		DECLARE @RC1 INT,@MONT1 DATETIME,@MONT2 DATETIME
		SET @RC1=0
		WHILE(@RC1<=@VacationMonthsDiff)
		BEGIN
			IF (@RC1=0)
			BEGIN
				SET @MONT1=DATEADD(MONTH,@RC1,@VacationStartMonth)
				IF (@AccrueVacationDaysPref=''False'' AND ISNULL(@AccrueVacationDaysPref,'''')<>'''')
				BEGIN
					IF (@VacationMonthsDiff=0)
					BEGIN
						IF(@CalculateVacDayforVacationPeriod=''Yes'' AND @CalcFromLastVacFromDate=''No'')
							SET @MONT2=DATEADD(D,0,@ToDate)
						ELSE
							SET @MONT2=DATEADD(D,-1,@FromDate)
					END
					ELSE
						SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@VacationStartMonth)+1,0)))
				END					
				ELSE
				BEGIN
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
				END

			END
			ELSE IF (@RC1=@VacationMonthsDiff)
			BEGIN
				SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VacationStartMonth),0))

				IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
				BEGIN
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
				END
				ELSE IF (@AccrueVacationDaysPref=''False'')
				BEGIN
					IF(@CalculateVacDayforVacationPeriod=''Yes''  AND @CalcFromLastVacFromDate=''No'')
					SET @MONT2=DATEADD(D,0,@ToDate)
					ELSE
					SET @MONT2=DATEADD(D,-1,@FromDate)
				END
				ELSE
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@FromDate)+1,0)))
			END
			ELSE
			BEGIN
				SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VacationStartMonth),0))
				IF (@AccrueVacationDaysPref=''False'')
					SET @MONT2=DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0))
				ELSE
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))			

			END

			--IF(YEAR(@MONT1)=2019 AND MONTH(@MONT1)=8)
			--		BEGIN
			--			SELECT @RC1,@VacationMonthsDiff,@MONT1,@MONT2,@AccrueVacationDaysPref
			--		END
			
			
			---------------------------------------------------
				IF EXISTS ( 
				SELECT a.InvDocDetailsID
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tCostCenterID=40072 and a.StatusID=369  
				AND LEN(d.dcAlpha2)<=15 AND LEN(d.dcAlpha3)<=15 AND ISDATE(ISNULL(d.dcAlpha2,''''))=1 AND ISDATE(ISNULL(d.dcAlpha3,''''))=1 AND b.dcCCNID51=@Empnode
				AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
						CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 
					) 
				)
				BEGIN
					EXEC spPAY_GetVacationLeavesInfoNew @MONT1,@MONT2,@Empnode,1,1,0,@LEAVESTAKEN OUTPUT,@LeavesTakenEncash OUTPUT
				END
				ELSE
				BEGIN
					SET @LEAVESTAKEN=0	SET @LeavesTakenEncash=0
				END
				
				SET @LeavesTakenEncashSUM=@LeavesTakenEncashSUM+@LeavesTakenEncash

				
				if(@CalcCreditFromDOJ=''Yes'' OR isnull(@CreditDaysBasedOnMP,0)>0 OR ISNULL(@Calcdays,0)>0)
					SET @LEAVESTAKENSUM=@LEAVESTAKENSUM+@LEAVESTAKEN

---------------------------------------------------


			DECLARE @LOPDAYS FLOAT
			  set @LOPDAYS=0

			IF(@ConsiderLOPwhilecalculatingcreditdays=''Yes'' AND ISNULL(@CreditDaysBasedOnMP,0)=0)
			BEGIN
		SET @CNT=0

		SELECT @CNT=COUNT(ID.DOCID) 
		FROM COM_DOCTEXTDATA TD  WITH(NOLOCK)
		INNER JOIN INV_DOCDETAILS ID WITH(NOLOCK) ON TD.INVDOCDETAILSID=ID.INVDOCDETAILSID 
		Inner Join com_DocccData cc WITH(NOLOCK) on cc.invDocdetailsid=ID.invDocdetailsid 
		Where TD.tCostcenterID=40054 and cc.dcCCNID51=@EmpNode AND CONVERT(DATETIME,ID.DUEDATE) BETWEEN 	@MONT1 AND @MONT2
		
		IF(@CNT>0)-- CHECKING FROM MONTHLY PAYROLL
		BEGIN
			SELECT @LOPDAYS=CONVERT(FLOAT,TD.DCALPHA9) 
			FROM COM_DOCTEXTDATA TD  WITH(NOLOCK)
			INNER JOIN INV_DOCDETAILS ID WITH(NOLOCK) ON TD.INVDOCDETAILSID=ID.INVDOCDETAILSID 
			Inner Join com_DocccData cc WITH(NOLOCK) on cc.invDocdetailsid=ID.invDocdetailsid 
			Where TD.tCostcenterID=40054 and cc.dcCCNID51=@EmpNode AND CONVERT(DATETIME,ID.DUEDATE) BETWEEN 	@MONT1 AND @MONT2

			IF EXISTS(SELECT SeqNo FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EmpNode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0))
			BEGIN
				SELECT @LOPDAYS=ISNULL(@LOPDAYS,0) - ISNULL(Days,0) FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EmpNode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0)
			END

		END
		ELSE IF(@CalcCreditFromDOJ=''Yes'')--START-CHECKING FROM VACATION LATE REJOIN AND LOP LEAVE 
		BEGIN

			--START--VACATION LATE REJOIN LOP
			TRUNCATE TABLE #TVacLOP
			INSERT INTO #TVacLOP
			SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3)
			FROM INV_DocDetails a WITH(NOLOCK) 
			JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
			JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
			WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@Empnode
			AND ISNULL(D.DCALPHA1,'''')<>'''' AND CONVERT(DATETIME,D.DCALPHA1)>DATEADD(D,1,CONVERT(DATETIME,D.dcAlpha3))
			AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
					CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 )
					
			 
			SELECT @TVacLOPCNT=COUNT(*) FROM #TVacLOP WITH(NOLOCK)
			SET @I=1
			WHILE(@I<=@TVacLOPCNT)
			BEGIN
				SELECT @LOPRD=REJOIN,@LOPFD=FROMDATE,@LOPTD=TODATE FROM #TVacLOP WITH(NOLOCK) WHERE ID=@I
				SET @ids=0

				if (@LOPRD >= @MONT1)
                BEGIN
                    if (@LOPTD >= @MONT1 AND @LOPTD <= @MONT2)
                        SET @dttmp = DATEADD(D,1,@LOPTD)
                    else
                        SET @dttmp = @MONT1;

                    if (@LOPRD >= @MONT1 AND @LOPRD <= @MONT2)
                        SET @dttmp1 = @LOPRD;
                    else
                        SET @dttmp1 = DATEADD(D,1,@MONT2)

                    if (@LOPTD < @dttmp1)
                    BEGIN
                        while (@dttmp < @dttmp1)
                        BEGIN
                            SET @ids=@ids+1
                            SET @dttmp = DATEADD(D,1,@dttmp)
                        END
                    END
                END
					
				SET @LOPDAYS=@LOPDAYS+@ids
				SET @I=@I+1
			END
			--END--VACATION LATE REJOIN LOP

			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),CONVERT(FLOAT,d.dcAlpha7)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@Empnode)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@MONT1)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@MONT2)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR

					
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK)
				SET @K=1
				DECLARE @LCNT1 FLOAT
				WHILE(@K<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@LOPNoOfDays=NoOfDays FROM #TLeaveLOP WITH(NOLOCK) WHERE ID=@K

					SELECT @LCNT1=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK) WHERE LeaveID=@LeaveID AND ( CONVERT(Varchar,@MONT1) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(Varchar,@MONT2) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(DATETIME,FROMDATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) OR 
						CONVERT(DATETIME,TODATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) )

					IF(@LOPEXFD>=@MONT1 AND @LOPEXTD<=@MONT2 AND ISNULL(@LCNT1,0)<=1)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@LOPNoOfDays
					END
					ELSE
					BEGIN
						IF NOT EXISTS(SELECT * FROM @TAB2 WHERE LEAVETYPEID=@LeaveID AND MONT1=@MONT1 AND MONT2=@MONT2)
						BEGIN
							SET @CurrYearLeavestaken=0
							EXEC spPAY_GetCurrYearLeavesInfo @MONT1,@MONT2,@Empnode,@LeaveID,1,1,@MONT1,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT
							SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken
							INSERT INTO @TAB2
							SELECT @MONT1,@MONT2,@LeaveID
						END
					END
				SET @K=@K+1
				END
			END
			--END--LOP LEAVES

			--START--EXCESS DAYS AS LOP
			IF(@ConsiderExcessdaysasLOP=''Yes'')
			BEGIN
				TRUNCATE TABLE #TVacExcessLOP
				INSERT INTO #TVacExcessLOP	
				SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3),CONVERT(FLOAT,d.dcAlpha10),CONVERT(FLOAT,d.dcAlpha11)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@Empnode AND CONVERT(FLOAT,ISNULL(d.dcAlpha11,0))>0
				AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
						CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 )

					
				
				SELECT @TVacEXLOPCNT=COUNT(*) FROM #TVacExcessLOP WITH(NOLOCK)
				SET @L=1

				SELECT @INCREXC=ISNULL(INCLUDEREXCLUDE,'''') FROM COM_CC50054 WITH(NOLOCK) WHERE GRADEID=@Grade AND COMPONENTID=@LeaveType AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade)

				WHILE(@L<=@TVacEXLOPCNT)
				BEGIN
					SELECT @LOPEXRD=REJOIN,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@EXPAIDDAYS=PaidDays,@EXEXCESSDAYS=ExcessDays FROM #TVacExcessLOP WITH(NOLOCK) WHERE ID=@L	

					IF(@LOPEXFD>=@MONT1 AND @LOPEXTD<=@MONT2)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@EXEXCESSDAYS
					END
					ELSE
					BEGIN
						
						
					DECLARE @VACDatesRange TABLE (SNO INT IDENTITY(1,1),ID INT ,DATE1 DATETIME,DAYNAME VARCHAR(50),WEEKNO INT,COUNT INT,NOOFDAYS Float,FLAG INT,IncExc varchar(5),ExcessDays INT)
					Declare @WEEKOFFCOUNT1 Table (ID INT ,WEEKDATE DateTime,DAYNAME Varchar(50),WEEKNO Int,COUNT Int,WEEKNOMANUAL Int)

				;WITH DATERANGE1 AS
				(
				SELECT @LOPEXFD AS DT,1 AS ID
				UNION ALL
				SELECT DATEADD(DD,1,DT),DATERANGE1.ID+1 FROM DATERANGE1 WHERE ID<=DATEDIFF("d",convert(varchar,@LOPEXFD,101),convert(varchar,@LOPEXTD,101))
				)
		
				INSERT INTO @VACDatesRange
				SELECT ROW_NUMBER() OVER (ORDER BY DT) AS ID,DT AS WEEKDATE,DATENAME(DW,DT) AS DAY,0,1,0,1,'''',1 FROM DATERANGE1
			
				--START WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
				INSERT INTO @WEEKOFFCOUNT1
				EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@Empnode,0,1,1

				--select * from @WEEKOFFCOUNT1
				UPDATE DATESCOUNT SET DATESCOUNT.count=3 FROM @WEEKOFFCOUNT1 WEEKOFFCOUNT inner join @VACDatesRange DATESCOUNT on CONVERT(DateTime,DATESCOUNT.date1)= CONVERT(DateTime,WEEKOFFCOUNT.weekdate) and WEEKOFFCOUNT.count=1
			
				--START-- HOLIDAY COUNT
					Declare @HOLIDAYCOUNT1 Table (ID int Identity(1,1),WEEKDATE Nvarchar(max),Remarks nvarchar(max))
					INSERT INTO @HOLIDAYCOUNT1
					EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@Empnode,1,1,1
				--END -- HOLIDAY COUNT

				--START : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
					UPDATE DATESCOUNT SET DATESCOUNT.count=4 FROM @VACDatesRange DATESCOUNT 
					inner join @HOLIDAYCOUNT1 TD on CONVERT(DATETIME,DATESCOUNT.DATE1)=CONVERT(DATETIME,TD.WEEKDATE)
				--END : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
				--END WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
			
				SET @IC=1
				SELECT @TRC=COUNT(*) FROM @VACDatesRange
				WHILE(@IC<=@TRC)
				BEGIN

					SELECT @DTT=DATE1 FROM @VACDatesRange WHERE id=@IC
					
					
					IF ISNULL(@INCREXC,'''')=''IncludeHolidays'' OR ISNULL(@INCREXC,'''')=''ExcludeWeeklyOffs''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EW'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=3
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeWeeklyOffs'' OR ISNULL(@INCREXC,'''')=''ExcludeHolidays''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EH'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=4
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeBoth''
						UPDATE @VACDatesRange SET FLAG=1 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) 
					ELSE IF ISNULL(@INCREXC,'''')=''ExcludeBoth''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EB'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) AND COUNT IN (3,4)

				SET @IC=@IC+1
				END
			
				SELECT @CNT3=COUNT(*) FROM @VACDatesRange
				SET @Y=1
				WHILE(@Y<=@CNT3)
				BEGIN
					IF(@EXPAIDDAYS>0 AND (SELECT COUNT(*) FROM @VACDatesRange WHERE id=@Y AND FLAG=1 AND count>=1 and isnull(IncExc,'''')='''' )>0)
					BEGIN
						UPDATE @VACDatesRange SET ExcessDays=0 WHERE id=@Y
						SET @EXPAIDDAYS=@EXPAIDDAYS-1
					END

				SET @Y=@Y+1
				END
				
				SET @LDAYS=0
				SELECT @LDAYS=COUNT(EXCESSDAYS) FROM @VACDatesRange WHERE EXCESSDAYS=1 AND DATE1 BETWEEN @MONT1 AND @MONT2


				delete from  @VACDatesRange
				delete from @WEEKOFFCOUNT1

				SET @LOPDAYS=@LOPDAYS+@LDAYS
					END
						
				SET @L=@L+1
				END

			END

			--END--EXCESS DAYS AS LOP


		END--END-CHECKING FROM VACATION LATE REJOIN
		ELSE IF(@CalcLopFromDocsifPayrollNotProcessed=''Yes'')--Calculate Lop from Leaves if payroll is not processed
		BEGIN
			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),CONVERT(FLOAT,d.dcAlpha7)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@Empnode)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@MONT1)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@MONT2)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR
	
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK)
				SET @K=1
				DECLARE @LCNT FLOAT
				WHILE(@K<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@LOPNoOfDays=NoOfDays FROM #TLeaveLOP WITH(NOLOCK) WHERE ID=@K

					SELECT @LCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK) WHERE LeaveID=@LeaveID AND ( CONVERT(Varchar,@MONT1) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(Varchar,@MONT2) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(DATETIME,FROMDATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) OR 
						CONVERT(DATETIME,TODATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) )

					IF(@LOPEXFD>=@MONT1 AND @LOPEXTD<=@MONT2 AND ISNULL(@LCNT,0)<=1)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@LOPNoOfDays
					END
					ELSE
					BEGIN
						IF NOT EXISTS(SELECT * FROM @TAB2 WHERE LEAVETYPEID=@LeaveID AND MONT1=@MONT1 AND MONT2=@MONT2)
						BEGIN
							SET @CurrYearLeavestaken=0
							EXEC spPAY_GetCurrYearLeavesInfo @MONT1,@MONT2,@Empnode,@LeaveID,1,1,@MONT1,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT	
							SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken

							INSERT INTO @TAB2
							SELECT @MONT1,@MONT2,@LeaveID
						END
					END
				SET @K=@K+1
				END
			END
			--END--LOP LEAVES
		END
	END
           
			IF(ISNULL(@DORELIEVE,'''')='''' OR  ISNULL(@DORESIGN,'''')='''' OR @Calculatecreditdayduringnoticeperiod=''Yes'')
			BEGIN
				IF(@CalculateVacDayforVacationPeriod=''Yes'' or @ConsiderCreditDaysforVacationPeriodonNextVacation=''Yes'')
				BEGIN
					IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
					BEGIN
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (DATEDIFF(D,@MONT1, CASE WHEN (DAY(@MONT2)=29) then (DATEADD(d,-1,@MONT2)) else (@MONT2) end)+1-ISNULL(@LOPDAYS,0)) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)) END  ,0)
						--INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (28-ISNULL(@LOPDAYS,0)) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)) END  ,0)
					END
					ELSE
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1, (DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)),0)	
				END
				ELSE
				BEGIN
					IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
					BEGIN
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (DATEDIFF(D,@MONT1, CASE WHEN (DAY(@MONT2)=29) then (DATEADD(d,-1,@MONT2)) else (@MONT2) end)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)) END  ,0)
						--INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (28-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)) END ,0)
					END
					ELSE
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(DATEDIFF(D,@MONT1,@MONT2)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)),0)
				END
			END
			ELSE
			BEGIN
			
				DECLARE @TEMPMONT1 DATETIME,@TEMPMONT2 DATETIME

				SET @TEMPMONT1=@MONT1
				SET @TEMPMONT2=@MONT2

				IF((@MONT1 BETWEEN @DORESIGN AND @DORELIEVE) OR (@MONT2 BETWEEN @DORESIGN AND @DORELIEVE) )
				BEGIN
					IF(@MONT1>=CONVERT(DATETIME,@DORESIGN) AND @MONT2<=CONVERT(DATETIME,@DORELIEVE))
						SET @TEMPMONT2=DATEADD(D,-1,@MONT1)
					ELSE IF(@MONT1<@DORESIGN )
						SET @TEMPMONT2=DATEADD(D,-1,@DORESIGN)
				END

				IF(@CalculateVacDayforVacationPeriod=''Yes'' or @ConsiderCreditDaysforVacationPeriodonNextVacation=''Yes'')
				BEGIN
					IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,(DATEDIFF(D,@TEMPMONT1,@TEMPMONT2)+1-ISNULL(@LOPDAYS,0)),0)
					ELSE
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(DATEDIFF(D,@TEMPMONT1,@TEMPMONT2)+1-ISNULL(@LOPDAYS,0)),0)
				END
				ELSE
				BEGIN
					IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,(DATEDIFF(D,@TEMPMONT1,@TEMPMONT2)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)),0)
					ELSE
						INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(DATEDIFF(D,@TEMPMONT1,@TEMPMONT2)+1-ISNULL(@LOPDAYS,0)-ISNULL(@LEAVESTAKEN,0)),0)
				END
			END
			
		SET @RC1=@RC1+1
		END
		
		
		IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
		BEGIN
			UPDATE M SET Days=T.VacDays FROM  @MonthDays M
			JOIN #VacDayTab T WITH(NOLOCK) ON T.Payrolldate=M.FDATE
		END
		ELSE IF(@CreditDaysCalculation=1)
		BEGIN
			--((VacDaysPerMonth*MonthDaysToConsider)/TotalMonthDays)
			IF(@IsDefineDaysExists=1)
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays SET Days= ROUND((( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)		
				ELSE
					UPDATE @MonthDays SET Days= (( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) )		

			END
			ELSE
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays SET Days= ROUND((( CAST(ACTUALDAYS AS FLOAT)* CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)
				ELSE
					UPDATE @MonthDays SET Days= (( CAST(ACTUALDAYS AS FLOAT)* CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) )
			END
		END
		ELSE  -- IF(@CreditDaysCalculation=2 or 3)
		BEGIN
			--((VacDaysPerYear/365)*MonthDaysToConsider)
			IF(@IsDefineDaysExists=1)
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays SET Days= ROUND((( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1)
				ELSE
					UPDATE @MonthDays SET Days= (( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) )
			END
			ELSE
			BEGIN	
				IF(@RoundOffVacDays=1)	
					UPDATE @MonthDays SET Days= ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
				ELSE
					UPDATE @MonthDays SET Days= ((CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT))
			END
		END
		
		----CHECKING THE PREFERENCE VACATION Days UPTO LAST MONTH
		IF (@CalcVacDaysuptoLastMonth=''False'')
			SELECT  @TotalCreditedDays=SUM(Days) FROM @MonthDays
		ELSE
			SELECT  @TotalCreditedDays=SUM(Days) FROM @MonthDays WHERE CONVERT(DateTime,FDATE)<DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@FromDate)),0)
		--END : CALCULATING PER MONTH Days
	PRINT ''Twh''
	print @FromDate
	print @ToDate
	PRINT @WeeklyOffCount
	PRINT @NoOfHolidays
	print @TotalCreditedDays
	
	--SELECTING THE DAYS BASED ON PREFERENCE
	SELECT @INCREXC=ISNULL(INCLUDEREXCLUDE,'''') FROM COM_CC50054 WITH(NOLOCK) WHERE GRADEID=@Grade AND COMPONENTID=@LeaveType AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade)
	IF(@INCREXC IS NULL)
		SET @INCREXC=''ExcludeBoth''

	IF ISNULL(@INCREXC,'''')=''IncludeWeeklyOffs'' OR ISNULL(@INCREXC,'''')=''ExcludeHolidays''
	BEGIN
		INSERT INTO @TAB 
			SELECT (DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101))-ISNULL(@NoOfHolidays,0))+1 as VacationDays ,CONVERT(DateTime,@FromDate) as FromDate,CONVERT(DateTime,@ToDate) as ToDate,0,0,0,0,0,0,0,(DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101)))+1
	END
	ELSE IF ISNULL(@INCREXC,'''')=''IncludeHolidays'' OR ISNULL(@INCREXC,'''')=''ExcludeWeeklyOffs''
	BEGIN
		INSERT INTO @TAB 
			SELECT (DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101))-ISNULL(@WeeklyOffCount,0))+1 as VacationDays ,CONVERT(DateTime,@FromDate) as FromDate,CONVERT(DateTime,@ToDate) as ToDate,0,0,0,0,0,0,0,(DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101)))+1
	END
	ELSE IF ISNULL(@INCREXC,'''')=''ExcludeBoth''
	BEGIN
		INSERT INTO @TAB 
			SELECT (DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101))-ISNULL(@NoOfHolidays,0)-ISNULL(@WeeklyOffCount,0))+1 as VacationDays ,CONVERT(DateTime,@FromDate) as FromDate,CONVERT(DateTime,@ToDate) as ToDate,0,0,0,0,0,0,0,(DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101)))+1
	END
	ELSE IF ISNULL(@INCREXC,'''')=''IncludeBoth''
	BEGIN
		INSERT INTO @TAB 
			SELECT (DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101)))+1 as VacationDays ,CONVERT(DateTime,@FromDate) as FromDate,CONVERT(DateTime,@ToDate) as ToDate,0,0,0,0,0,0,0,(DATEDIFF("d",convert(Varchar,@FromDate,101),convert(Varchar,@ToDate,101)))+1
	END

	
	-------------------
	IF(@Calculatevacdayforvacationperiod=''Yes'' AND @ConsiderVacationdayforExcessVacationDays=''No'' AND @ParamExcDays>0 AND ISNULL(@CreditDaysBasedOnMP,0)=0)
		BEGIN
			DECLARE @ExDays FLOAT
			SET @ExDays=@ParamExcDays
			IF(@ExDays>0)
			BEGIN
				Declare @RCnt2 INT,@RId2 INT,@Ex2Days FLOAT,@AcDays FLOAT
				SELECT @RCnt2=COUNT(*) FROM @MonthDays
				SET @RId2=@RCnt2
				SET @Ex2Days=@ExDays
				WHILE(@RId2>0 AND @Ex2Days>0)
				BEGIN
					SELECT @AcDays=ActualDays FROM @MOnthDays WHERE ID=@RId2
					IF(@AcDays>@Ex2Days)
					BEGIN
						UPDATE @MonthDays SET ActualDays=ActualDays-@Ex2Days WHERE ID=@RId2
						SET @Ex2Days=0
					END
					ELSE
					BEGIN
						UPDATE @MonthDays SET ActualDays=0 WHERE ID=@RId2
						SET @Ex2Days=@Ex2Days-@AcDays
					END
					SET @RId2=@RId2-1
				END


				IF(@CreditDaysCalculation=1)
				BEGIN
					--((VacDaysPerMonth*MonthDaysToConsider)/TotalMonthDays)
					IF(@IsDefineDaysExists=1)
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays SET Days= ROUND((( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)		
						ELSE
							UPDATE @MonthDays SET Days= (( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) )		
					END
					ELSE
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays SET Days= ROUND((( CAST(ACTUALDAYS AS FLOAT)* CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)
						ELSE
							UPDATE @MonthDays SET Days= (( CAST(ACTUALDAYS AS FLOAT)* CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) )
					END
				END
				ELSE
				BEGIN
					--((VacDaysPerYear/365)*MonthDaysToConsider)
					IF(@IsDefineDaysExists=1)
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays SET Days= ROUND((( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1)
						ELSE
							UPDATE @MonthDays SET Days= (( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) )
					END
					ELSE
					BEGIN
						IF(@RoundOffVacDays=1)			
							UPDATE @MonthDays SET Days= ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1)
						ELSE
							UPDATE @MonthDays SET Days= (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) )
					END
				END
				----CHECKING THE PREFERENCE VACATION Days UPTO LAST MONTH
				IF (@CalcVacDaysuptoLastMonth=''False'')
					SELECT  @TotalCreditedDays=SUM(Days) FROM @MonthDays
				ELSE
					SELECT  @TotalCreditedDays=SUM(Days) FROM @MonthDays WHERE CONVERT(DateTime,FDATE)<DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@FromDate)),0)
			END

		END
	------------------
		--ROUNDUP FOR VACATIONDAYS	
		DECLARE @VACATIONDAYS FLOAT, @decVal FLOAT
		SELECT @VACATIONDAYS=ISNULL(VACATIONDAYS ,0) FROM @TAB

	
	--SELECT CAST(@TotalCreditedDays as FLOAT)
	UPDATE @TAB SET AppliedDays=@VACATIONDAYS,ApprovedDays=@VACATIONDAYS,PaidDays=@VACATIONDAYS,CreditedDays= CAST(@TotalCreditedDays as DECIMAL(18,2))
	--
	
	SET @VacDays=(SELECT VacationDays FROM @TAB)
	SET @SumofOPandTotalCreditDays=ISNULL(@OpBalDays,0)+ISNULL(@TotalCreditedDays,0)

		declare @FSEncashDays float,@CalcEncash FLOAT
	--
	SELECT @FSEncashDays=ISNULL(dcAlpha15,0) FROM INV_DocDetails I WITH(NOLOCK)
JOIN COM_DocCCData CC WITH(NOLOCK) ON CC.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_DocTextData T WITH(NOLOCK) ON T.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_DocNumData N WITH(NOLOCK) ON N.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.Name=dcAlpha12 AND C52.Name IN (@LeaveTypeName)
WHERE T.tCostCenterID=40095 AND dcAlpha1=''2'' AND dcAlpha10=''Partial'' AND CC.dcCCNID51=@EmpNode and ISDATE(dcAlpha3)=1
AND CONVERT(DATETIME,dcAlpha3)<=CONVERT(DATETIME,@FromDate)
AND CONVERT(DATETIME,dcAlpha3)>=CONVERT(DATETIME,@LastReJoinDate)
	--
	
	IF(@CalcCreditFromDOJ=''Yes'' OR isnull(@CreditDaysBasedOnMP,0)>0 OR ISNULL(@Calcdays,0)>0)
	begin
	
	if(ISNULL(@Calcdays,0)>0)
	begin
		SELECT @VacDays=ISNULL(D.dcAlpha14,0)
		FROM INV_DocDetails a WITH(NOLOCK) 
		JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
		JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
		WHERE d.tCostCenterID=40072 and a.StatusID=369  
		AND b.dcCCNID51=@Empnode AND CONVERT(DATETIME,d.dcAlpha2)=@FromDate AND ISNULL(D.dcAlpha16,''No'')=''Yes''
	end		

		SET @SumofOPandTotalCreditDays=@SumofOPandTotalCreditDays-(ISNULL(@LeavesTakenEncashSUM,0)+ISNULL(@LeavesTakenSUM,0))
		UPDATE @TAB SET Totaltaken=ISNULL(@LeavesTakenEncashSUM,0)+ISNULL(@LeavesTakenSUM,0)
	end

	IF ((ISNULL(@SumofOPandTotalCreditDays,0)-ISNULL(@FSEncashDays,0))>=@VacDays )
	BEGIN
		UPDATE @TAB SET RemainingDays=@SumofOPandTotalCreditDays-(ISNULL(@VacDays ,0)+ISNULL(@FSEncashDays,0))
	END
	ELSE
	BEGIN
		UPDATE @TAB SET PaidDays=ISNULL(@SumofOPandTotalCreditDays,0)-ISNULL(@FSEncashDays,0) FROM @TAB
		UPDATE @TAB SET ExcessDays=ISNULL(@VacDays ,0)-(@SumofOPandTotalCreditDays-ISNULL(@FSEncashDays,0))
	END

	
	SELECT VacationDays,AppliedDays,ApprovedDays,PaidDays,isnull(CreditedDays,0) CreditedDays,
	round(ExcessDays,2) ExcessDays,round(RemainingDays,2) RemainingDays,FromDate,ToDate,'''' as VacationDaysMessage,ISNULL(@FSEncashDays,0)  FSEncashDays ,ISNULL(TotalTaken,0) TotalTaken ,ISNULL(VActualDays,0) ActualDays,@INCREXC INCREXC,@Perdaysalarycalculations Perdaysalarycalculations
	FROM @TAB


	END	--END FOR FROM DATE AND TODATE CONDITION CHECKING
	END	--END FOR CHECKING DATES FOR APPLIED VACATION ELSE CONDITION
	
--BELOW CRITERIA EXCEPT FOR POSTING THE LEAVES AS VACATION(DOCID=-100)
IF(@DocID<>-100)
BEGIN
	--For Vacation Amount Calculation
	Declare @TabVacationMgmet Table (ID Int IDENTITY(1,1),SNO Int,SNAME Varchar(20),EMPNODE Int,TYPEID Int,TYPENAME Varchar(100),COMPONENTID Int,COMPONENTNAME Varchar(200),PERCENTAGE Float,AMOUNT Float,ENCASH Float,EXCESSDAYSSALARY Float,FORMULA Varchar(100),ACTUALAMOUNT Float,PERCACTUALAMOUNT Float)
	--START: LOADING VACATION MANAGEMENT EARNING COMPONENTS AND DEDUCTION & LOAN COMPONENTS FROM CUSTOMIZE PAYROLL
		--LOADING EARNING COMPONENTS FROM VACATION MANAGEMENT JOIN WITH CUSTOMIZE PAYROLL
		INSERT INTO @TabVacationMgmet 
				SELECT	 C54.SNO,'''',@EmpNode,C52.PARENTID,'''',TD.dcAlpha17,C52.NAME,CASE WHEN C52.PARENTID IN(3,4) THEN 0 ELSE DN.dcNum1 END,0,0,0,TD.dcAlpha16,0,0
				FROM     COM_CC50052 C52 WITH(NOLOCK),COM_CC50054 C54 WITH(NOLOCK),INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCNUMDATA DN WITH(NOLOCK) ON  ID.INVDOCDETAILSID=DN.INVDOCDETAILSID
						 JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
				WHERE    TD.tCOSTCENTERID=40061 AND ID.StatusID=369 AND C54.GRADEID=CC.DCCCNID53 AND ISNUMERIC(TD.dcAlpha17)=1 AND C52.NODEID=CONVERT(INT,TD.dcAlpha17) AND  CONVERT(INT,TD.dcAlpha17)=C54.COMPONENTID  AND ISNULL(C54.FIELDTYPE,'''')<>''OverTime''
						 AND CC.DCCCNID53=@Grade AND DN.DCNUM1<>0 AND PayrollDate=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade)
		
		IF NOT EXISTS(SELECT	 C52.PARENTID
				FROM     COM_CC50052 C52 WITH(NOLOCK),COM_CC50054 C54 WITH(NOLOCK),INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCNUMDATA DN WITH(NOLOCK) ON  ID.INVDOCDETAILSID=DN.INVDOCDETAILSID
						 JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
				WHERE    TD.tCOSTCENTERID=40061 AND ID.StatusID=369 AND C54.GRADEID=CC.DCCCNID53 AND ISNUMERIC(TD.dcAlpha17)=1 AND C52.NODEID=CONVERT(INT,TD.dcAlpha17) AND  CONVERT(INT,TD.dcAlpha17)=C54.COMPONENTID  AND ISNULL(C54.FIELDTYPE,'''')<>''OverTime'' AND C52.PARENTID IN(3,4)
						 AND CC.DCCCNID53=@Grade  AND PayrollDate=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade))
		BEGIN
		--LOADING DEDUCTION COMPONENTS FROM PAYROLL COMPONENTS JOIN WITH CUSTOMIZE PAYROLL		    
		INSERT INTO @TabVacationMgmet 
				SELECT   A.SNO,'''',@EMPNODE,B.PARENTID,'''',A.COMPONENTID,B.NAME,0,0,0,0,0,0,0
				FROM     COM_CC50054 A WITH(NOLOCK) LEFT JOIN COM_CC50052 B WITH(NOLOCK) ON B.NODEID=A.COMPONENTID
				WHERE    A.GRADEID=@Grade AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade) AND A.TYPE<>4 AND B.PARENTID IN (3,4)
				ORDER BY A.TYPE,A.SNO 
		END
		
		----INSERTING NEW COMPONENT
		--INSERT INTO @TabVacationMgmet 
		--		SELECT   0,'''',@EmpNode,2 ,'''' ,0,''EMPLOYEE_BASIC'',100,0,0,0,0,0,0 
		Declare @Formula nvarchar(100)
		Set @Formula=(SELECT	 Top 1 isnull(dcAlpha16,''(Field/30)'')
				FROM     COM_CC50052 C52 WITH(NOLOCK),COM_CC50054 C54 WITH(NOLOCK),INV_DOCDETAILS ID WITH(NOLOCK) 
						 JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
				WHERE    TD.tCOSTCENTERID=40061 AND C54.GRADEID=CC.DCCCNID53 AND ISNUMERIC(TD.dcAlpha17)=1 AND C52.NODEID=CONVERT(INT,TD.dcAlpha17) AND  CONVERT(INT,TD.dcAlpha17)=C54.COMPONENTID  AND C54.FIELDTYPE<>''OverTime''
						 AND CC.DCCCNID53=@Grade AND PayrollDate=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@PayrollDate) AND GradeID=@Grade))
						 
INSERT INTO @TabVacationMgmet 
				SELECT	 0,'''',@EmpNode,2,'''',0,''EMPLOYEE_BASIC'',DN.dcNum1,0,0,0,TD.dcAlpha16,0,0
				FROM     INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCNUMDATA DN WITH(NOLOCK) ON  ID.INVDOCDETAILSID=DN.INVDOCDETAILSID
						 JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
				WHERE    TD.tCOSTCENTERID=40061 AND ID.StatusID=369 AND ISNUMERIC(TD.dcAlpha17)=1 AND CONVERT(INT,TD.dcAlpha17)=0 
						 AND CC.DCCCNID53=@Grade 
		

		--INSERT INTO @TabVacationMgmet 
		--		SELECT   0,'''',@EmpNode,2 ,'''' ,0,''EMPLOYEE_BASIC'',100,0,0,0,@Formula,0,0 
				
		SELECT * FROM @TabVacationMgmet ORDER BY TYPEID,SNO 
		
		--EMP PAY
		Declare @SQL nVarchar(max)
		SET @SQL=''
		SELECT EmployeeID,MAX(EffectFrom) as EffectFrom INTO #t1LAP FROM PAY_EmpPay WITH(NOLOCK) 
		WHERE EmployeeID IN(''+convert(varchar,@EmpNode)+'') AND CONVERT(DATETIME,EffectFrom)<=CONVERT(DATETIME,''''''+CONVERT(NVARCHAR,@ToDate)+'''''')
		GROUP BY EmployeeID

		SELECT b.EmployeeID as EmpSeqNo,a.*,CONVERT(DATETIME,a.EffectFrom) AS CEffectFrom,CONVERT(DATETIME,a.ApplyFrom) AS CApplyFrom,Convert(DateTime,DOConfirmation) ConfirmationDate
		FROM PAY_EmpPay a WITH(NOLOCK) 
		JOIN Com_CC50051 C WITH(NOLOCK) ON C.NODEID=A.EmployeeID
		JOIN #t1LAP b WITH(NOLOCK) ON b.EmployeeID=a.EmployeeID and b.EffectFrom=a.EffectFrom
		WHERE a.EmployeeID IN(''+convert(varchar,@EmpNode)+'') 

		DROP TABLE #t1LAP ''
		print @SQL
		EXEC sp_executesql @SQL
		
		--LOADING LOAN DETAILS
		SET @LOANFROMDATE=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@FromDate)),0)
		INSERT INTO @TABLOANDETAILS
			SELECT CC.dcCCNID52,CONVERT(DECIMAL,DN.dcNum2)
			FROM   INV_DOCDETAILS ID WITH(NOLOCK) 
			JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
			JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID 
			JOIN COM_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID
			WHERE  TD.tCOSTCENTERID=40056 AND  ID.STATUSID=369 AND CC.DCCCNID51=@EmpNode AND  ISDATE(TD.DCALPHA6)=1 AND CONVERT(DateTime,TD.DCALPHA6) BETWEEN CONVERT(DateTime,@LOANFROMDATE) AND CONVERT(DateTime,@ToDate)
			
		SELECT * FROM @TABLOANDETAILS      
		
		IF (@CalcVacDaysuptoLastMonth=''True'')
			SELECT * FROM @MonthDays WHERE FDATE<@FromDate
		ELSE
			SELECT * FROM @MonthDays
		--

		select * from @DATESCOUNT
END

DROP TABLE #VMDD
DROP TABLE #VacMonthWiseAllotedDays
DROP TABLE #VACDAYTAB


SET NOCOUNT OFF;
END

' 
END
GO
/****** Object:  StoredProcedure [dbo].[spPAY_GetRemainingVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_GetRemainingVacationDays]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'--EXEC [spPAY_GetRemainingVacationDays] ''01-nov-2017'',109
CREATE procedure [dbo].[spPAY_GetRemainingVacationDays]
@Date DateTime,
@Empnode INT,
@Flag INT=0,
@UserID Int=1,
@LangID Int=1
AS
Begin
SET NOCOUNT ON;

DECLARE @RoundOffVacDays BIT
SET @RoundOffVacDays=1

Declare @DimVacDays float,@BelowSixMonthsDays float,@BelowOneYearDays float,@CalculateVacDayforVacationPeriod Varchar(3)
Declare @ConsiderLOPwhilecalculatingCreditdays Varchar(3)
Declare @GradewiseVacationPref Varchar(5),@TotalDays float,@CalcVacdaysuptoLastMonth Varchar(5)
Declare @Grade Int,@OPLeavesAsOn DateTime,@OpVacDays float,@CreditDaysBasedOnMP Int,@PayrollDate DATETIME,@AssingedLeaveType INT,@ActDOJ DateTime 
Declare @COMPONENTID Int,@COMPONENTIDSNO Int,@DCNUMFILED Varchar(10),@SYCOLNAME Varchar(15),@STRQRY Varchar(MAX),@CrDaysUptoLastMonth float
Declare @OPVACATIONDAYS FLOAT,@OPVACATIONSALARY FLOAT,@decVal float,@AccrueVacationDaysPref nvarchar(5)
Declare @DOJ DateTime,@DORJ DateTime,@VacationMonthsDiff float,@VACATIONPERIOD Varchar(20),@VACDAYSPERMONTH float,@VACDAYSPERIOD Varchar(20),@TMONTHS Int,@MonthlyNoofDays float,@VACATIONSTARTMONTH DateTime
Declare @CreditDaysCalculation Int,@ConsiderCreditDaysforVacationPeriodonNextVacation nvarchar(6)
DECLARE @LEAVESTAKEN FLOAT,@LeavesTakenEncash FLOAT,@LeavesTakenEncashSUM FLOAT,@AssingedLeaveTypeName NVARCHAR(500)
DECLARE @K INT,@ACVDAYS FLOAT,@DonotshownegitiveOPvacationdays NVARCHAR(10),@FDate datetime,@TDate datetime,@BDays float,@VTD datetime,@BAL FLOAT
DECLARE @LOPRD DATETIME,@LOPFD DATETIME,@LOPTD DATETIME,@TVacLOPCNT INT ,@I3 INT,@dttmp1 DATETIME,@dttmp DATETIME,@ids FLOAT

DECLARE @CalcLopFromDocsifPayrollNotProcessed NVARCHAR(10),@LOPNoOfDays FLOAT, @ConsiderLOPBasedOn NVARCHAR(500),@CNT INT,@STR NVARCHAR(MAX),@TLeaveLOPCNT INT,@LeaveID INT,@LOPEXFD DATETIME,@LOPEXTD DATETIME,@CurrYearLeavestaken DECIMAL(9,2),@NOOFHOLIDAYS1 INT,@WEEKLYOFFCOUNT1 INT,@EXSTAPPLIEDENCASHDAYS DECIMAL(9,2)
DECLARE @TAB2 TABLE(ID INT IDENTITY(1,1),MONT1 DATETIME,MONT2 DATETIME,LEAVETYPEID BIGINT)

DECLARE @K3 INT,@CalcCreditFromDOJ NVARCHAR(10),@Trc int, @LOPEXRD DATETIME,@TVacEXLOPCNT INT ,@L INT,@EXPAIDDAYS FLOAT,@EXEXCESSDAYS FLOAT,@CNT3 INT,@Y INT,@LDAYS FLOAT,@ExcessDaysAsLOP Varchar(3)

CREATE TABLE #TLeaveLOP(ID INT IDENTITY(1,1),LeaveID BIGINT,FROMDATE DATETIME,TODATE DATETIME,NoOfDays FLOAT)
CREATE TABLE #TVacExcessLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME,PaidDays FLOAT,ExcessDays FLOAT)


SELECT @ConsiderLOPBasedOn=ISNULL(Value,'''') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''ConsiderLOPBasedOn''

--VMDD
DECLARE @VacMgmtDocID INT, @IsDefineDaysExists BIT
CREATE TABLE #VMDD(FromMonth INT,ToMonth INT,DaysPerMonth FLOAT,ApplyToPrevMonths NVARCHAR(50),WEF DATETIME)
CREATE TABLE #VacMonthWiseAllotedDays(ID INT Identity(1,1),VacMonth DateTime,AllotedDays FLOAT,Yearly FLOAT)
--VMDD


SET @LeavesTakenEncashSUM=0.0

Create Table #VACDAYTAB (VACDAYS float,Payrolldate Datetime)
Declare @MonthDays TABLE(ID INT Identity(1,1),FDATE DateTime,TDATE DateTime,TOTALDAYS FLOAT,ACTUALDAYS FLOAT,DAYS float,LEAVESTAKEN FLOAT,LOPDAYS FLOAT,BALANCE FLOAT,DAYSASON float,EncashDays FLOAT)
CREATE TABLE #TVacLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME)

--SET TO FIRST DAY FOR THE GIVEN DATE
SET @PayrollDate=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@Date)),0)

--START:LOADING PREFERENCES
SELECT @DonotshownegitiveOPvacationdays=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''DonotshownegitiveOPvacationdays''
SELECT @GradewiseVacationPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''GradeWiseVacation''
SELECT @CalcVacDaysuptoLastMonth=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''CalcVacDaysuptolastmonth''
SELECT @AccrueVacationDaysPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''AccrueVacationDays''
SELECT @RoundOffVacDays=ISNULL(VALUE,''True'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''RoundOffVacationCreditDays''

IF(@Flag=1 OR @Flag=2)
	SET @CalcVacDaysuptoLastMonth=''False''

IF (@GRADEWISEVACATIONPREF=''True'')
BEGIN
	IF((SELECT COUNT(CostCenterID) FROM ADM_CostCenterDef WITH(NOLOCK) WHERE CostCenterID=50051 and SysColumnName =''CCNID53'' and IsColumnInUse=1 and UserProbableValues=''H'')>0)
		SELECT @GRADE=ISNULL(HistoryNodeID,0) FROM COM_HistoryDetails WITH(NOLOCK) WHERE NodeID=@Empnode AND CostCenterID=50051 AND HistoryCCID=50053 AND (FromDate<=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate))) AND (ToDate>=CONVERT(FLOAT,CONVERT(DATETIME,@PayrollDate)) OR ToDate IS NULL)
	ELSE
		SELECT @GRADE=ISNULL(CCNID53,0) FROM COM_CCCCDATA WITH(NOLOCK) WHERE COSTCENTERID=50051 AND NODEID=@Empnode
END

IF ISNULL(@GRADE,0)=0
	SET @GRADE=1
	
SELECT @BelowSixMonthsDays=ISNULL(TD.DCALPHA3,''0''), @BelowOneYearDays=ISNULL(TD.DCALPHA4,''0''), @CalculateVacDayforVacationPeriod=ISNULL(TD.DCALPHA9,''NO''), 
	   @ConsiderLOPwhilecalculatingCreditdays=ISNULL(TD.DCALPHA8,''NO'') ,@CreditDaysBasedOnMP=ISNULL(dcAlpha5,0),@AssingedLeaveType=ISNULL(dcAlpha1,0),
	   @CreditDaysCalculation=ISNULL(TD.DCALPHA18,''1''),
	   @VacMgmtDocID=ID.DocID,@AssingedLeaveTypeName=C52.Name,@CalcLopFromDocsifPayrollNotProcessed=ISNULL(DCALPHA24,''No''),@ConsiderCreditDaysforVacationPeriodonNextVacation=ISNULL(TD.dcAlpha22,''No'')
FROM   INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.NodeID=TD.dcAlpha1
WHERE  TD.tCOSTCENTERID=40061 AND CC.DCCCNID53=@Grade 
--END:LOADING PREFERENCES BASED ON GRADE

--SET @CreditDaysCalculation=3
--SET @RoundOffVacDays=0

--START :GET DOJ,VACATIONPERIOD AND VACATION DAYS,OPLeavesAsOn,OpVacationDays FROM EMPLOYEE
SELECT @OPLeavesAsOn=CONVERT(DateTime,OPLeavesAsOn),@OpVacDays=isnull(OpVacationDays,0),@DOJ=CONVERT(DateTime,DOJ),@VACATIONPERIOD=VACATIONPERIOD,@VACDAYSPERMONTH=ISNULL(VACDAYSPERMONTH,0),@VACDAYSPERIOD=VACDAYSPERIOD FROM COM_CC50051 WITH(NOLOCK) WHERE NODEID=@EmpNode
SET @ActDOJ=@Doj
IF(CONVERT(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'')
	SET @DOJ=@OPLeavesAsOn

SELECT @OPVACATIONDAYS=ISNULL(OPVACATIONDAYS,0),@OPVACATIONSALARY=0 FROM COM_CC50051 WITH(NOLOCK) WHERE NODEID=@EmpNode

--VMDD
SET @IsDefineDaysExists=0
IF EXISTS (SELECT SeqNo FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID)
BEGIN
	SET @IsDefineDaysExists=1
	INSERT INTO #VMDD
	SELECT FromMonth,ToMonth,DaysPerMonth,ApplyToPrevMonths ,WEF
	FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID

	DECLARE @VacationDefBasedOn INT
	select @VacationDefBasedOn=ISNULL(PrefValue,1) from COM_DocumentPreferences WITH(NOLOCK) WHERE PrefName=''VacationDefBasedOn''

	declare @dtt1 datetime,@dtt2 datetime,@TotMon INT,@AllotedDays FLOAT,@MNo INT,@APM NVARCHAR(50),@YearlyVD FLOAT
	set @dtt1=dateadd(day,-datepart(day,@ActDOJ)+1,@ActDOJ)
	set @dtt2=dateadd(day,-datepart(day,@Date)+1,@Date)
	set @dtt2=DATEADD(year,1,@dtt2) -- adding extra 1 year to know the yearly vacation days
	SET @MNo=0
	WHILE(@dtt1<=@dtt2)
	BEGIN
		SET @MNo=@MNo+1

		IF(ISNULL(@VacationDefBasedOn,1)=1)
			SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WHERE @MNo BETWEEN FromMonth AND ToMonth
		ELSE
			SELECT TOP 1 @AllotedDays=DaysPerMonth/12,@APM=ApplyToPrevMonths FROM #VMDD WHERE WEF<=@dtt1 ORDER BY WEF DESC
			
		SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WITH(NOLOCK) WHERE @MNo BETWEEN FromMonth AND ToMonth
		INSERT INTO #VacMonthWiseAllotedDays
		SELECT @dtt1,@AllotedDays,-1

		IF(@APM=''Yes'')
			UPDATE #VacMonthWiseAllotedDays SET AllotedDays=@AllotedDays

		IF(@MNo%12)=0
		BEGIN
			SELECT @YearlyVD=SUM(AllotedDays) FROM #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE Yearly=-1
				
			IF(@APM=''Yes'')
				UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD
			ELSE
				UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD WHERE Yearly=-1

		END

		SET @dtt1=DATEADD(month,1,@dtt1)
	END

END
--SELECT * FROM #VacMonthWiseAllotedDays
--VMDD


DECLARE @TMP INT
set @TMP=0
--START : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ
IF ((SELECT count(DocID)  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
	 WHERE  TD.tCOSTCENTERID=40072 AND CC.DCCCNID51=@EmpNode AND ISNULL(TD.DCALPHA2,'''')<>'''' AND ISNULL(TD.DCALPHA3,'''')<>'''' AND ISNULL(TD.DCALPHA1,'''')<>'''')>0 AND isnull(@CreditDaysBasedOnMP,0)=0)
BEGIN
	--DATE OF REJOING
	--SELECT @VACATIONSTARTMONTH=CONVERT(DateTime,TD.DCALPHA1) FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
	--WHERE  CC.DCCCNID51=@EmpNode AND ID.COSTCENTERID=40072 AND ISNULL(TD.DCALPHA2,'''')<>'''' AND ISNULL(TD.DCALPHA3,'''')<>'''' AND ISNULL(TD.DCALPHA1,'''')<>'''' ORDER BY CONVERT(DateTime,ID.DOCDATE) DESC
	
	SET   @VACATIONSTARTMONTH=@DOJ
	set @TMP=1
	
	IF (@CalcVacDaysuptoLastMonth=''False'')
		SET @VacationStartMonth=CONVERT(DATETIME,@VacationStartMonth)
	ELSE
		SET @VacationStartMonth=CONVERT(DATETIME,DATEADD(MONTH,DATEDIFF(MONTH,-1,CONVERT(DATETIME,@VacationStartMonth))-2,0))	
	
	--VACATION MONTHS DIFFERENCE
	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))		
	--select @VacationMonthsDiff
	--GET VACDAYS COMPONENT FROM MONTHLY PAYROLL
	select @COMPONENTIDSNO=SNO from COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@CreditDaysBasedOnMP AND GRADEID=@Grade 
	SET @syColName=''dcNum''+convert(Varchar,@COMPONENTIDSNO)


	IF(ISNULL(@SYCOLNAME,'''')<>'''' AND ISNULL(@VACATIONSTARTMONTH,'''')<>'''' AND ISNULL(@DATE,'''')<>'''')
	BEGIN
	SET @STRQRY=''INSERT INTO #VACDAYTAB 
					SELECT  ISNULL(''+ @SYCOLNAME +'',0),CONVERT(DateTime,ID.DUEDATE)  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
					WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@EmpNode) +'' AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DUEDATE) BETWEEN ''''''+ convert(Varchar,@VACATIONSTARTMONTH) +'''''' and ''''''+ convert(Varchar,@DATE)+''''''''
--	PRINT (@STRQRY)
	EXEC (@STRQRY)
	END
	
	SELECT @DimVacDays=ISNULL(VACDAYS,0) FROM #VACDAYTAB WITH(NOLOCK)
	
	
	--
	--IF @DimVacDays>0
	--BEGIN
	--	SET @MonthlyNoofDays= ROUND((CAST(@DimVacDays AS FLOAT)/ CAST(12 AS FLOAT)),2,1)
	--END

	declare @VMD FLOAT,@VSM DATETIME
	SET @VSM=@ActDOJ
	--VACATION MONTHS DIFFERENCE
	SET @VMD=DATEDIFF(MONTH,@VSM,DATEADD(DAY,0,@DATE))

	IF ISNULL(@DimVacDays,0)>0
	BEGIN
		SET @MonthlyNoofDays= ROUND((CAST(@DimVacDays AS FLOAT)/ CAST(12 AS FLOAT)),2,1)
	END
	ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD<=6
	BEGIN
		SET @MonthlyNoofDays=@BelowSixmonthsDays
	END
	ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD>6 And @VMD<=12 
	BEGIN
		SET @MonthlyNoofDays=@BelowOneyearDays
	END
	ELSE
	BEGIN
		IF @VACDAYSPERIOD=''Yearly''
		BEGIN
			SET @TMONTHS=12
		END
		ELSE
		BEGIN
			SET @TMONTHS=1
		END
		SET @MonthlyNoofDays= ROUND((CAST(@VACDAYSPERMONTH AS FLOAT)/CAST(@TMONTHS AS FLOAT)),2,1)
	END							
END
ELSE
BEGIN
	--DATE OF JOINING
	print ''DOJ''
	SET   @VACATIONSTARTMONTH=@ActDOJ
	SET @TMP=0
	--VACATION MONTHS DIFFERENCE
	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))
	
	--GET VACDAYS FROM MONTHLY PAYROLL
	select @COMPONENTIDSNO=SNO from COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@CreditDaysBasedOnMP AND GRADEID=@Grade 
	SET @syColName=''dcNum''+convert(Varchar,@COMPONENTIDSNO)


	
	IF(ISNULL(@SYCOLNAME,'''')<>'''' AND ISNULL(@VACATIONSTARTMONTH,'''')<>'''' AND ISNULL(@DATE,'''')<>'''')
	BEGIN
	SET @STRQRY=''INSERT INTO #VACDAYTAB 
						SELECT  ISNULL(''+ @SYCOLNAME +'',0),CONVERT(DateTime,ID.DUEDATE)  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
						WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@EmpNode) +'' AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DUEDATE) BETWEEN ''''''+ convert(Varchar,@VACATIONSTARTMONTH) +'''''' and ''''''+ convert(Varchar,@DATE)+''''''''
	PRINT (@STRQRY)
	EXEC (@STRQRY)
	END
	
	IF(ISNULL(@CreditDaysBasedOnMP,0)=0)
	BEGIN
		PRINT @VACDAYSPERMONTH
		--PICKING THE PERMONTH VACDAYS FROM PREFERENCES
		IF @DimVacDays>0
	BEGIN
		SET @MonthlyNoofDays= ROUND((CAST(@DimVacDays AS FLOAT)/CAST(12 AS FLOAT)),2,1)
	END
	ELSE IF @VacationMonthsDiff<=6
	BEGIN
		SET @MonthlyNoofDays=@BelowSixMonthsDays
	END
	ELSE IF @VacationMonthsDiff>6 And @VacationMonthsDiff<=12 
	BEGIN
		SET @MonthlyNoofDays=@BelowOneYearDays
	END
	ELSE
	BEGIN
		IF @VACDAYSPERIOD=''Yearly''
		BEGIN
			SET @TMONTHS=12
		END
		ELSE
		BEGIN
			SET @TMONTHS=1
		END
		SET @MonthlyNoofDays=@VACDAYSPERMONTH/@TMONTHS
	END
	END

END							
--END : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ	

	IF(CONVERT(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'' AND @TMP=0 )
		SET @VacationStartMonth=@DOJ

	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))

--START : CALCULATING PER MONTH DAYS
Declare @RC1 Int,@MONT1 DateTime,@MONT2 DateTime,@ActualVacDate DateTime 
--SET @ActualVacDate=(SELECT TOP 1 CONVERT(DATETIME,TD.DCALPHA2) FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
--					WHERE  CC.DCCCNID51=@EmpNode AND ID.COSTCENTERID=40072 AND ID.STATUSID NOT IN (372,376) AND ISDATE(TD.DCALPHA2)=1 AND CONVERT(DATETIME,TD.DCALPHA2)>=CONVERT(DATETIME,@DATE))
--select @ActualVacDate
IF (ISNULL(@ActualVacDate,'''')='''')
	SET @ActualVacDate=DATEADD(D,-1,@DATE)--CONVERT(DATETIME,@DATE)

DECLARE @LOPDAYS FLOAT,@RJLOPDAYS FLOAT
DECLARE @VACPERIODDAYS FLOAT

SELECT d.InvDocDetailsID,d.dcAlpha2,d.dcAlpha3,ISNULL(CONVERT(FLOAT, d.dcAlpha11), 0) as ExcessDays,CASE WHEN d.dcAlpha1 IS NOT NULL AND ISDATE(d.dcAlpha1)=1   THEN CONVERT(DATETIME,d.dcAlpha1) ELSE NULL END as ReJoinDate INTO #T4
FROM INV_DocDetails a WITH(NOLOCK) 
JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
WHERE  d.tCostCenterID=40072 and a.StatusID=369 AND b.dcCCNID51=@Empnode 

SELECT i.InvDocDetailsID,CONVERT(DATETIME,T.dcAlpha3) dcAlpha3 INTO #T5 FROM INV_DocDetails I WITH(NOLOCK)
JOIN COM_DocCCData CC WITH(NOLOCK) ON CC.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_DocTextData T WITH(NOLOCK) ON T.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.Name=dcAlpha12 
WHERE T.tCostCenterID=40095 AND C52.Name IN (@AssingedLeaveTypeName) AND dcAlpha1=''2'' and i.StatusID=369 AND cc.dcCCNID51=@Empnode 

SET @RC1=0
WHILE(@RC1<=@VacationMonthsDiff)
BEGIN
	IF (@RC1=0)
	BEGIN
		SET @MONT1=DATEADD(MONTH,@RC1,@VACATIONSTARTMONTH)
		IF (@AccrueVacationDaysPref=''False'')
		BEGIN
			IF (@VacationMonthsDiff=0)
			BEGIN
				SET @MONT2=DATEADD(D,-1,@VACATIONSTARTMONTH)
				IF(@MONT2<@MONT1)
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@VacationStartMonth)+1,0)))
			END
			ELSE
			BEGIN
				SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@VacationStartMonth)+1,0)))
			END

			IF(@Date<@MONT2)
				SET @MONT2=@Date
		END					
		ELSE
		BEGIN
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
		END

		--select @VACATIONSTARTMONTH,@MONT1,@MONT2

	END
	ELSE IF (@RC1=@VacationMonthsDiff)
	BEGIN
		SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VACATIONSTARTMONTH),0))

		IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
		BEGIN
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
		END
		ELSE IF (@AccrueVacationDaysPref=''False'')
		BEGIN
			IF(CONVERT(DATETIME,@ActualVacDate)<CONVERT(DATETIME,@DATE))
			BEGIN
				IF(@Flag=1 OR @Flag=2)
				SET @MONT2=@DATE
				ELSE
				SET @MONT2=DATEADD(D,-1,@DATE)
			END
			ELSE
			BEGIN
			SET @MONT2=DATEADD(D,-1,@ActualVacDate)
			END
		END
		ELSE
		BEGIN
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ActualVacDate)+1,0)))

		END
	END
	ELSE
	BEGIN

		SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VACATIONSTARTMONTH),0))
		IF (@AccrueVacationDaysPref=''False'')
			SET @MONT2=DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0))
		ELSE
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
			

	END

	
---------------------------------------------------

	IF EXISTS ( 
				SELECT d.InvDocDetailsID FROM #T4 d WITH(NOLOCK)
				WHERE  ISDATE(ISNULL(d.dcAlpha2,''''))=1 AND ISDATE(ISNULL(d.dcAlpha3,''''))=1 
				AND LEN(ISNULL(d.dcAlpha2,''''))<=30 AND LEN(ISNULL(d.dcAlpha3,''''))<=30
				AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
						CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 
					)
				UNION
				SELECT InvDocDetailsID FROM #T5 WITH(NOLOCK) WHERE dcAlpha3 BETWEEN @MONT1 AND  @MONT2
				)
				BEGIN
					--if(MONTH(@MONT1)=2 AND YEAR(@MONT1)=2020)
					--select @MONT1,@MONT2,@Empnode,1,1,0
					EXEC spPAY_GetVacationLeavesInfoNew @MONT1,@MONT2,@Empnode,1,1,0,@LEAVESTAKEN OUTPUT,@LeavesTakenEncash OUTPUT
				END
				ELSE
				BEGIN
					SET @LEAVESTAKEN=0 SET @LeavesTakenEncash=0
				END
				
				SET @LeavesTakenEncashSUM=@LeavesTakenEncashSUM+@LeavesTakenEncash
				
---------------------------------------------------
	SET @LOPDAYS=0
	IF(@ConsiderLOPwhilecalculatingCreditdays=''Yes'')
	BEGIN
	SET @CNT=0

		SELECT @CNT=COUNT(DCCCNID51) 
		 FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID
			JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
			WHERE TD.tCOSTCENTERID=40054 AND ID.VOUCHERTYPE=11 AND CC.DCCCNID51=@Empnode AND ISDATE(DCALPHA17)=1 AND CONVERT(DATETIME,DCALPHA17)=CONVERT(DATETIME,@MONT1) AND ISDATE(DCALPHA18)=1 AND CONVERT(DATETIME,DCALPHA18)=CONVERT(DATETIME,@MONT2) 

		IF(@CNT>0)-- CHECKING FROM MONTHLY PAYROLL
		BEGIN
			SELECT @LOPDAYS=ISNULL(TD.DCALPHA9,''0'')  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID
			JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
			WHERE TD.tCOSTCENTERID=40054 AND ID.VOUCHERTYPE=11 AND CC.DCCCNID51=@Empnode AND ISDATE(DCALPHA17)=1 AND CONVERT(DATETIME,DCALPHA17)=CONVERT(DATETIME,@MONT1) AND ISDATE(DCALPHA18)=1 AND CONVERT(DATETIME,DCALPHA18)=CONVERT(DATETIME,@MONT2)
			
			IF EXISTS(SELECT SeqNo FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EmpNode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0))
			BEGIN
				SELECT @LOPDAYS=ISNULL(@LOPDAYS,0) - ISNULL(Days,0) FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EmpNode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0)
			END
			 
		END
		ELSE IF(@CalcCreditFromDOJ=''Yes'')--START-CHECKING FROM VACATION LATE REJOIN AND LOP LEAVE 
		BEGIN

			--START--VACATION LATE REJOIN LOP
			TRUNCATE TABLE #TVacLOP
			INSERT INTO #TVacLOP
			SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3)
			FROM INV_DocDetails a WITH(NOLOCK) 
			JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
			JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
			WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@Empnode
			AND ISNULL(D.DCALPHA1,'''')<>'''' AND CONVERT(DATETIME,D.DCALPHA1)>DATEADD(D,1,CONVERT(DATETIME,D.dcAlpha3))
			AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
					CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 )
					
			 
			SELECT @TVacLOPCNT=COUNT(*) FROM #TVacLOP WITH (NOLOCK)
			SET @I3=1
			WHILE(@I3<=@TVacLOPCNT)
			BEGIN
				SELECT @LOPRD=REJOIN,@LOPFD=FROMDATE,@LOPTD=TODATE FROM #TVacLOP WITH (NOLOCK) WHERE ID=@I3
				SET @ids=0

				if (@LOPRD >= @MONT1)
                BEGIN
                    if (@LOPTD >= @MONT1 AND @LOPTD <= @MONT2)
                        SET @dttmp = DATEADD(D,1,@LOPTD)
                    else
                        SET @dttmp = @MONT1;

                    if (@LOPRD >= @MONT1 AND @LOPRD <= @MONT2)
                        SET @dttmp1 = @LOPRD;
                    else
                        SET @dttmp1 = DATEADD(D,1,@MONT2)

                    if (@LOPTD < @dttmp1)
                    BEGIN
                        while (@dttmp < @dttmp1)
                        BEGIN
                            SET @ids=@ids+1
                            SET @dttmp = DATEADD(D,1,@dttmp)
                        END
                    END
                END
					
				SET @LOPDAYS=@LOPDAYS+@ids
				SET @I3=@I3+1
			END
			--END--VACATION LATE REJOIN LOP

			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),0
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@Empnode)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@MONT1)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@MONT2)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR

					
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH (NOLOCK)
				SET @K3=1
				WHILE(@K3<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID FROM #TLeaveLOP WITH (NOLOCK) WHERE ID=@K3
					SET @CurrYearLeavestaken=0
					EXEC spPAY_GetCurrYearLeavesInfo @MONT1,@MONT2,@Empnode,@LeaveID,1,1,@MONT1,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT

					
				SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken
				SET @K3=@K3+1
				END
			END
			--END--LOP LEAVES

			--START--EXCESS DAYS AS LOP
			IF(@ExcessDaysAsLOP=''Yes'')
			BEGIN
				TRUNCATE TABLE #TVacExcessLOP
				INSERT INTO #TVacExcessLOP	
				SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3),CONVERT(FLOAT,d.dcAlpha10),CONVERT(FLOAT,d.dcAlpha11)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@Empnode AND CONVERT(FLOAT,ISNULL(d.dcAlpha11,0))>0
				AND ( @MONT1 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						@MONT2 BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
						CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 )

					
				
				SELECT @TVacEXLOPCNT=COUNT(*) FROM #TVacExcessLOP WITH (NOLOCK)
				SET @L=1

				WHILE(@L<=@TVacEXLOPCNT)
				BEGIN
					SELECT @LOPEXRD=REJOIN,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@EXPAIDDAYS=PaidDays,@EXEXCESSDAYS=ExcessDays FROM #TVacExcessLOP WITH (NOLOCK) WHERE ID=@L	

					IF(@LOPEXFD>=@MONT1 AND @LOPEXTD<=@MONT2)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@EXEXCESSDAYS
					END
					ELSE
					BEGIN
						
						
					DECLARE @VACDatesRange TABLE (SNO INT IDENTITY(1,1),ID INT ,DATE1 DATETIME,DAYNAME VARCHAR(50),WEEKNO INT,COUNT INT,NOOFDAYS Float,FLAG INT,IncExc varchar(5),ExcessDays INT)
					Declare @WEEKOFFCOUNT1 Table (ID INT ,WEEKDATE DateTime,DAYNAME Varchar(50),WEEKNO Int,COUNT Int,WEEKNOMANUAL Int)

				;WITH DATERANGE1 AS
				(
				SELECT @LOPEXFD AS DT,1 AS ID
				UNION ALL
				SELECT DATEADD(DD,1,DT),DATERANGE1.ID+1 FROM DATERANGE1 WHERE ID<=DATEDIFF("d",convert(varchar,@LOPEXFD,101),convert(varchar,@LOPEXTD,101))
				)
		
				INSERT INTO @VACDatesRange
				SELECT ROW_NUMBER() OVER (ORDER BY DT) AS ID,DT AS WEEKDATE,DATENAME(DW,DT) AS DAY,0,1,0,1,'''',1 FROM DATERANGE1
			
				--START WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
				INSERT INTO @WEEKOFFCOUNT1
				EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@Empnode,0,1,1

				--select * from @WEEKOFFCOUNT1
				UPDATE DATESCOUNT SET DATESCOUNT.count=3 FROM @WEEKOFFCOUNT1 WEEKOFFCOUNT inner join @VACDatesRange DATESCOUNT on CONVERT(DateTime,DATESCOUNT.date1)= CONVERT(DateTime,WEEKOFFCOUNT.weekdate) and WEEKOFFCOUNT.count=1
			
				--START-- HOLIDAY COUNT
					Declare @HOLIDAYCOUNT1 Table (ID int Identity(1,1),WEEKDATE Nvarchar(max),Remarks nvarchar(max))
					INSERT INTO @HOLIDAYCOUNT1
					EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@Empnode,1,1,1
				--END -- HOLIDAY COUNT

				--START : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
					UPDATE DATESCOUNT SET DATESCOUNT.count=4 FROM @VACDatesRange DATESCOUNT 
					inner join @HOLIDAYCOUNT1 TD on CONVERT(DATETIME,DATESCOUNT.DATE1)=CONVERT(DATETIME,TD.WEEKDATE)
				--END : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
				--END WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
				Declare @IC  Int,@DTT  DateTime,@INCREXC VARCHAR(50)

				SELECT @INCREXC=ISNULL(INCLUDEREXCLUDE,'''') FROM COM_CC50054 WITH(NOLOCK) WHERE GRADEID=@Grade AND COMPONENTID=@AssingedLeaveType AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@MONT1) AND GradeID=@Grade)

				SET @IC=1
				SELECT @TRC=COUNT(*) FROM @VACDatesRange
				WHILE(@IC<=@TRC)
				BEGIN

					SELECT @DTT=DATE1 FROM @VACDatesRange WHERE id=@IC

					IF ISNULL(@INCREXC,'''')=''IncludeHolidays'' OR ISNULL(@INCREXC,'''')=''ExcludeWeeklyOffs''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EW'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=3
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeWeeklyOffs'' OR ISNULL(@INCREXC,'''')=''ExcludeHolidays''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EH'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=4
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeBoth''
						UPDATE @VACDatesRange SET FLAG=1 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) 
					ELSE IF ISNULL(@INCREXC,'''')=''ExcludeBoth''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EB'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) AND COUNT IN (3,4)

				SET @IC=@IC+1
				END
			
				SELECT @CNT3=COUNT(*) FROM @VACDatesRange
				SET @Y=1
				WHILE(@Y<=@CNT3)
				BEGIN
					IF(@EXPAIDDAYS>0 AND (SELECT COUNT(*) FROM @VACDatesRange WHERE id=@Y AND FLAG=1 AND count>=1 and isnull(IncExc,'''')='''' )>0)
					BEGIN
						UPDATE @VACDatesRange SET ExcessDays=0 WHERE id=@Y
						SET @EXPAIDDAYS=@EXPAIDDAYS-1
					END

				SET @Y=@Y+1
				END

				SET @LDAYS=0
				SELECT @LDAYS=COUNT(EXCESSDAYS) FROM @VACDatesRange WHERE EXCESSDAYS=1 AND DATE1 BETWEEN @MONT1 AND @MONT2


				delete from  @VACDatesRange
				delete from @WEEKOFFCOUNT1

				SET @LOPDAYS=@LOPDAYS+@LDAYS
					END
						
				SET @L=@L+1
				END

			END

			--END--EXCESS DAYS AS LOP


		END--END-CHECKING FROM VACATION LATE REJOIN
		ELSE IF(@CalcLopFromDocsifPayrollNotProcessed=''Yes'')--Calculate Lop from Leaves if payroll is not processed
		BEGIN
			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),CONVERT(FLOAT,d.dcAlpha7)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@Empnode)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@MONT1)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@MONT2)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@MONT1)+'''''' AND  ''''''+CONVERT(Varchar,@MONT2)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR
	
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK)
				SET @K=1
				DECLARE @LCNT FLOAT
				WHILE(@K<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@LOPNoOfDays=NoOfDays FROM #TLeaveLOP WITH(NOLOCK) WHERE ID=@K

					SELECT @LCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK) WHERE LeaveID=@LeaveID AND ( CONVERT(Varchar,@MONT1) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(Varchar,@MONT2) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(DATETIME,FROMDATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) OR 
						CONVERT(DATETIME,TODATE) BETWEEN  CONVERT(Varchar,@MONT1) AND  CONVERT(Varchar,@MONT2) )

					IF(@LOPEXFD>=@MONT1 AND @LOPEXTD<=@MONT2 AND ISNULL(@LCNT,0)<=1)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@LOPNoOfDays
					END
					ELSE
					BEGIN
						IF NOT EXISTS(SELECT * FROM @TAB2 WHERE LEAVETYPEID=@LeaveID AND MONT1=@MONT1 AND MONT2=@MONT2)
						BEGIN
							SET @CurrYearLeavestaken=0
							EXEC spPAY_GetCurrYearLeavesInfo @MONT1,@MONT2,@Empnode,@LeaveID,1,1,@MONT1,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT	
							SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken

							INSERT INTO @TAB2
							SELECT @MONT1,@MONT2,@LeaveID
						END
					END
				SET @K=@K+1
				END
			END
			--END--LOP LEAVES
		END
		
	END

	IF(@ConsiderLOPwhilecalculatingcreditdays=''No'' AND ISNULL(@CreditDaysBasedOnMP,0)=0)
	BEGIN
	SET @RJLOPDAYS=0
	--START--VACATION LATE REJOIN LOP
			TRUNCATE TABLE #TVacLOP

			INSERT INTO #TVacLOP
			SELECT DISTINCT ReJoinDate,dcAlpha2,dcAlpha3
			FROM #T4 a WITH(NOLOCK) 
			WHERE ReJoinDate>DATEADD(D,1,dcAlpha3)
			AND ( @MONT1 BETWEEN DATEADD(D,1,dcAlpha3) AND ReJoinDate OR 
					@MONT2 BETWEEN DATEADD(D,1,dcAlpha3) AND ReJoinDate OR 
					DATEADD(D,1,dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 OR 
					ReJoinDate BETWEEN  @MONT1 AND  @MONT2 )
			 
			SELECT @TVacLOPCNT=COUNT(*) FROM #TVacLOP WITH (NOLOCK)
		
			SET @I3=1
			WHILE(@I3<=@TVacLOPCNT)
			BEGIN
				SELECT @LOPRD=REJOIN,@LOPFD=FROMDATE,@LOPTD=TODATE FROM #TVacLOP WITH (NOLOCK) WHERE ID=@I3
				SET @ids=0
				
				if (@LOPRD >= @MONT1)
                BEGIN
				
                    if (@LOPTD >= @MONT1 AND @LOPTD <= @MONT2)
                        SET @dttmp = DATEADD(D,1,@LOPTD)
                    else
                        SET @dttmp = @MONT1;

                    if (@LOPRD >= @MONT1 AND @LOPRD <= @MONT2)
                        SET @dttmp1 = @LOPRD;
                    else
                        SET @dttmp1 = DATEADD(D,1,@MONT2)
						
                    if (@LOPTD < @dttmp1)
                    BEGIN
					--SELECT @LOPRD LOPRD,@LOPFD LOPFD,@LOPTD LOPTD,@TMONTH TMONTH,@FMONTH FMONTH,@dttmp dttmp,@dttmp1 dttmp1
                        while (@dttmp < @dttmp1)
                        BEGIN
                            SET @ids=@ids+1
                            SET @dttmp = DATEADD(D,1,@dttmp)
                        END
                    END
                END
					
				SET @RJLOPDAYS=@RJLOPDAYS+@ids
				SET @I3=@I3+1
			END
	--END--VACATION LATE REJOIN LOP

	END
 
	IF(@CalculateVacDayforVacationPeriod=''Yes'' or @ConsiderCreditDaysforVacationPeriodonNextVacation=''Yes'')
	BEGIN
		IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
			--INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (28-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))) END
			--,0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
			INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 AND DATEDIFF(D,@MONT1,@MONT2)+1=29 THEN (28-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))) WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 AND DAY(@MONT2)=29 THEN (DATEDIFF(D,@MONT1,@MONT2)-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))) END
			,0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
		ELSE
			INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0))),0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
	END
	ELSE
	BEGIN
		IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
			--INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN (28-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0))) ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0))) END
			--,0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
			INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 AND DATEDIFF(D,@MONT1,@MONT2)+1=29 THEN (28-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0)))WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 AND DAY(@MONT2)=29 THEN (DATEDIFF(D,@MONT1,@MONT2)-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0)))  ELSE (DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0))) END
			,0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
		ELSE
			INSERT INTO @MonthDays VALUES(@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(DATEDIFF(D,@MONT1,@MONT2)+1-(ISNULL(@LOPDAYS,0) + ISNULL(@RJLOPDAYS,0)+ISNULL(@LEAVESTAKEN,0))),0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),0,0,ISNULL(@LeavesTakenEncash,0))
	END
		
IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
BEGIN
	UPDATE M SET Days=T.VacDays FROM  @MonthDays M
	JOIN #VacDayTab T WITH(NOLOCK) ON T.Payrolldate=M.FDATE
END
ELSE IF(@CreditDaysCalculation=1)
BEGIN
	--((VacDaysPerMonth*MonthDaysToConsider)/TotalMonthDays)
	IF(@IsDefineDaysExists=1)
	BEGIN
		IF(@RoundOffVacDays=1)
			UPDATE @MonthDays 
			SET Days= ROUND((( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)		
			WHERE TOTALDAYS>0
		ELSE
			UPDATE @MonthDays 
			SET Days= (( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) )		
			WHERE TOTALDAYS>0
	END
	ELSE
	BEGIN
		IF(@RoundOffVacDays=1)		
			UPDATE @MonthDays SET Days= ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1) where TOTALDAYS>0
		ELSE
			UPDATE @MonthDays SET Days= (( CAST(ACTUALDAYS AS FLOAT) * CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ) where TOTALDAYS>0
	END
END
ELSE
BEGIN
	--((VacDaysPerYear/365)*MonthDaysToConsider)
	IF(@IsDefineDaysExists=1)
	BEGIN
		IF(@RoundOffVacDays=1)
			UPDATE @MonthDays SET Days= ROUND((( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1)
		ELSE
			UPDATE @MonthDays SET Days= (( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 

	END
	ELSE
	BEGIN
		IF(@RoundOffVacDays=1)
			UPDATE @MonthDays SET Days=ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
		ELSE
			UPDATE @MonthDays SET Days= (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
	END
END

-- START DonotshownegitiveOPvacationdays ****************************

SET @K=0
SET @ACVDAYS=0
SET @BDays=0
select @k=id from @MonthDays where FDATE=@MONT1 and TDATE=@MONT2

SELECT @ACVDAYS = BALANCE
	FROM @MonthDays
	WHERE ID = @K - 1
IF(@K=1)
	UPDATE @MonthDays SET BALANCE = ISNULL(@ACVDAYS,0)+Days+ISNULL(@OPVACATIONDAYS,0) WHERE ID=@K
ELSE
	UPDATE @MonthDays SET BALANCE = ISNULL(@ACVDAYS,0)+Days WHERE ID=@K


	select @FDate=FDate,@TDate=TDate,@BDays=(BALANCE - (LEAVESTAKEN+EncashDays)) FROM @MonthDays WHERE ID = @K

	IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #T4 WITH (NOLOCK) WHERE convert(datetime,dcAlpha3) BETWEEN @FDate AND @TDate AND ExcessDays>0 AND @BDays<0 ) )

	BEGIN
		declare @RDays FLOAT
		SET @RDays=1
		
		Select @VTD=convert(datetime,dcAlpha3) FROM #T4 WITH (NOLOCK) WHERE convert(datetime,dcAlpha3) BETWEEN @FDate AND @TDate AND ExcessDays>0

		IF(@VTD<@TDate)
		BEGIN
			IF(@RoundOffVacDays=1)
				SELECT @RDays= ROUND((( ((CAST(TOTALDAYS AS FLOAT)-CAST(LEAVESTAKEN AS FLOAT))) * CAST(Days AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1) FROM @MonthDays  WHERE ID = @K
			ELSE
				SELECT @RDays= (( ((CAST(TOTALDAYS AS FLOAT)-CAST(LEAVESTAKEN AS FLOAT))) * CAST(Days AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)) FROM @MonthDays  WHERE ID = @K
		END
			

		UPDATE @MonthDays
		SET BALANCE = @RDays
		WHERE ID = @K
	END
	ELSE IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #T4 WITH (NOLOCK) WHERE ((convert(datetime,dcAlpha2) BETWEEN @FDate AND @TDate) or (convert(datetime,dcAlpha2)<@FDate and convert(datetime,dcAlpha3)>@TDate)) AND ExcessDays>0 AND @BDays<0 ) )
	BEGIN
		UPDATE @MonthDays
		SET BALANCE = 0
		WHERE ID = @K
	END
	ELSE
	BEGIN
		UPDATE @MonthDays
		SET BALANCE = (BALANCE - (LEAVESTAKEN+EncashDays))
		WHERE ID = @K
	END


-- END DonotshownegitiveOPvacationdays ****************************
	
SET @RC1=@RC1+1
END

--CHECKING PREFERENCE VACATION DAYS UPTO LAST MONTH
IF (@CALCVACDAYSUPTOLASTMONTH=''False'')
	SELECT  @TotalDays=SUM(Days-LeavesTaken) FROM @MonthDays
ELSE
BEGIN
	SELECT  @TotalDays=SUM(Days-LeavesTaken) FROM @MonthDays WHERE CONVERT(DateTime,FDATE)<DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@DATE)),0)--CONVERT(DateTime,FDATE)<>CONVERT(DateTime,@DATE)
END

SELECT  @CrDaysUptoLastMonth=SUM(Days-LeavesTaken) FROM @MonthDays WHERE CONVERT(DateTime,FDATE)<DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@DATE)),0)
--END : CALCULATING PER MONTH DAYS


SELECT @BAL=BALANCE FROM @MonthDays WHERE TDATE=@Date


--END:CHECKING FOR VACATION APPLIED DAYS AND RETURN FROM VACATION

--SELECT LeaveTypeNode as LeaveType,0 as CreditedDays,0 as OPBalOrRemainingDays,0 as EncashedDays,AvlblLeaves as AvlblDays,0 as VacDaysUptoLastMonth from @TabLeaveTypes
--UNION
SELECT @AssingedLeaveType as LeaveType,Round(isnull(@TotalDays,0),2) CreditedDays,ISNULL(@OPVACATIONDAYS,0) as OPBalOrRemainingDays,@LeavesTakenEncashSUM as EncashedDays, CASE WHEN @DonotshownegitiveOPvacationdays=''TRUE'' THEN ROUND(ISNULL(@BAL,0),2) ELSE Round(ISNULL(@OPVACATIONDAYS,0)+isnull(@TotalDays,0)-isnull(@LeavesTakenEncashSUM,0),2) END AS AvlblDays,Round(ISNULL(@OPVACATIONDAYS,0)+isnull(@CrDaysUptoLastMonth,0),2) as VacDaysUptoLastMonth

SELECT * FROM @MONTHDAYS		

DROP TABLE #T4
DROP TABLE #VMDD
DROP TABLE #VacMonthWiseAllotedDays
DROP TABLE #VACDAYTAB

SET NOCOUNT OFF;
END
' 
END
GO
/****** Object:  StoredProcedure [dbo].[spPAY_RptGetVacationLedger]    Script Date: 22-01-2026 15:28:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptGetVacationLedger]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE procedure [dbo].[spPAY_RptGetVacationLedger]
(
	@EmpWhere NVARCHAR(MAX)=NULL,
	@FromDate DATETIME,
	@ToDate DATETIME,
	@CCWhere NVARCHAR(MAX)=NULL
)
AS
SET NOCOUNT ON

DECLARE @RoundOffVacDays BIT
SET @RoundOffVacDays=1

DECLARE @STARTDATE DATETIME
	,@ENDDATE DATETIME
	,@VFD DATETIME
	,@VTD DATETIME
	,@DOJ DATETIME
	,@LASON DATETIME
	,@MONT1 DATETIME
	,@MONT2 DATETIME
	,@DOJ1 DATETIME,
	@Calculatevacdayforvacationperiod Varchar(3),
	@ExcessDaysAsLOP Varchar(3),
	@FDate Datetime,@TDate Datetime,@BDays FLOAT,
	@VacTaken FLOAT,@EnDays FLOAT,@DonotshownegitiveOPvacationdays NVARCHAR(6),@ConsiderLOPwhilecalculatingcreditdays NVARCHAR(6),@DJ datetime
	DECLARE @LOPDAYS FLOAT, @CreditDaysCalculation Int,@FSEncashDays FLOAT,@DORELIEVE FLOAT,@DR DATETIME,@DESIGNATION NVARCHAR(500),@RJLOPDAYS FLOAT


	SET @VacTaken=0 SET @EnDays=0

DECLARE @EMPNAME NVARCHAR(MAX)
	,@EMPCODE NVARCHAR(MAX)
	,@STRFROMDATERANGE NVARCHAR(MAX)
	,@STRTODATERANGE NVARCHAR(MAX)
	,@FMONTH DATETIME
	,@TMONTH DATETIME
DECLARE @EncashDays FLOAT
	,@RC1 INT
	,@VDays FLOAT
	,@VacationMonthsDiff FLOAT
	,@OPB FLOAT
	,@GRADE INT
	,@I INT
	,@TRC INT
	,@OPENINGBAL FLOAT
	,@VACDAYSPERIOD NVARCHAR(10)
	,@VACDAYSPERMONTH FLOAT
DECLARE @J INT
	,@RC INT
	,@NODEID INT
	,@STRVACDAYS FLOAT,@VT FLOAT
	,@STRVACDAYS1 FLOAT
	,@K INT
	,@KK INT
	,@EID INT
	,@ACVDAYS FLOAT
DECLARE @TAB TABLE (
	ID INT IDENTITY(1, 1)
	,NODEID INT
	,EMPCODE NVARCHAR(MAX)
	,EMPNAME NVARCHAR(MAX)
	,DOJ DATETIME
	,GRADE INT
	,SERVICEDAYS FLOAT
	,MONTHDIFF FLOAT
	,OPENING FLOAT
	,OPENINGBAL FLOAT
	,LEAVEASONDATE DATETIME
	,DOJ1 DATETIME
	,VACDAYSPERIOD NVARCHAR(10)
	,VACDAYSPERMONTH FLOAT
	,DORELIEVE FLOAT
	,DESIGNATION NVARCHAR(500)
	)

CREATE TABLE #TABVAC (
	ID INT IDENTITY(1, 1)
	,FROMDATE DATETIME
	,TODATE DATETIME
	,VACDAYS FLOAT
	)

DECLARE @MonthDays TABLE (
	ID INT Identity(1, 1)
	,EMPNODE INT
	,EMPCODE NVARCHAR(MAX)
	,EMPNAME NVARCHAR(MAX)
	,DATEOFJ DATETIME
	,DESIGNATION NVARCHAR(500)
	,FDATE DATETIME
	,TDATE DATETIME
	,TOTALDAYS FLOAT
	,ACTUALDAYS FLOAT
	,Days FLOAT
	,DAYSASON FLOAT
	,VACDAYS FLOAT
	,VACSTARTDATE NVARCHAR(MAX)
	,VACENDDATE NVARCHAR(MAX)
	,BALANCE FLOAT
	,OPENINGBAL FLOAT
	,OPBDATE DATETIME
	)

CREATE TABLE #TVacLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME)
CREATE TABLE #TLeaveLOP(ID INT IDENTITY(1,1),LeaveID BIGINT,FROMDATE DATETIME,TODATE DATETIME,NoOfDays FLOAT)
CREATE TABLE #TVacExcessLOP(ID INT IDENTITY(1,1),REJOIN DATETIME,FROMDATE DATETIME,TODATE DATETIME,PaidDays FLOAT,ExcessDays FLOAT)
Create Table #VacDayTab (VacDays Float,Payrolldate Datetime)--VDAYS
DECLARE @TAB2 TABLE(ID INT IDENTITY(1,1),MONT1 DATETIME,MONT2 DATETIME,LEAVETYPEID BIGINT)

DECLARE @CNT INT,@CalcCreditFromDOJ NVARCHAR(10),@ConsiderExcessdaysasLOP NVARCHAR(10),@VacationLeaveType INT
DECLARE @LOPRD DATETIME,@LOPFD DATETIME,@LOPTD DATETIME,@TVacLOPCNT INT ,@I3 INT,@dttmp1 DATETIME,@dttmp DATETIME,@ids FLOAT, @ConsiderLOPBasedOn NVARCHAR(500)
DECLARE @TLeaveLOPCNT INT,@K3 INT,@LeaveID INT,@CurrYearLeavestaken DECIMAL(9,2),@NOOFHOLIDAYS1 INT,@WEEKLYOFFCOUNT1 INT,@EXSTAPPLIEDENCASHDAYS DECIMAL(9,2),@STR NVARCHAR(MAX)
DECLARE @LOPEXRD DATETIME,@LOPEXFD DATETIME,@LOPEXTD DATETIME,@TVacEXLOPCNT INT ,@L INT,@EXPAIDDAYS FLOAT,@EXEXCESSDAYS FLOAT,@CNT3 INT,@Y INT,@LDAYS FLOAT
DECLARE @COMPONENTIDSNO Int,@syColName Varchar(15),@CreditDaysBasedOnMP Int,@strQry NVarchar(max),@CalcLopFromDocsifPayrollNotProcessed NVARCHAR(10),@LOPNoOfDays FLOAT,@ConsiderCreditDaysforVacationPeriodonNextVacation nvarchar(6)

SELECT @ConsiderLOPBasedOn=ISNULL(Value,'''') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''ConsiderLOPBasedOn''

SET @STARTDATE = @FromDate
SET @ENDDATE = @ToDate

SELECT @DonotshownegitiveOPvacationdays=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''DonotshownegitiveOPvacationdays''
SELECT @RoundOffVacDays=ISNULL(VALUE,''True'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''RoundOffVacationCreditDays''

DECLARE @GrWiseVac BIT
SELECT @GrWiseVac=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''GradeWiseVacation''
--select @GrWiseVac

DECLARE @S1 NVARCHAR(MAX)
SET @S1=''''

SET @S1=''
SELECT C51.NODEID,C51.CODE,C51.NAME,CASE WHEN convert(DATETIME, OPLeavesAsOn) <> ''''01 Jan 1900'''' THEN convert(DATETIME, OPLeavesAsOn) ELSE CONVERT(DATETIME, C51.DOJ) END
	,CC.CCNID53
	,DATEDIFF(D, CONVERT(DATETIME, C51.DOJ), CONVERT(DATETIME, ''''''+CONVERT(NVARCHAR,@STARTDATE,106)+''''''))
	,DATEDIFF(MONTH, CONVERT(DATETIME, CASE 
				WHEN convert(DATETIME, OPLeavesAsOn) <> ''''01 Jan 1900''''
					THEN convert(DATETIME, OPLeavesAsOn)
				ELSE CONVERT(DATETIME, C51.DOJ)
				END),CASE WHEN ISNULL(DORELIEVE,'''''''')<>'''''''' AND  CONVERT(DATETIME,DORELIEVE)< CONVERT(DATETIME, ''''''+CONVERT(NVARCHAR,@ENDDATE,106)+'''''') THEN CONVERT(DATETIME,DORELIEVE) ELSE CONVERT(DATETIME, ''''''+CONVERT(NVARCHAR,@ENDDATE,106)+'''''') END )
	,0 
	,ISNULL(C51.OpVacationDays, 0)
	,convert(DATETIME, OPLeavesAsOn)
	,CONVERT(DATETIME, C51.DOJ)
	,C51.VACDAYSPERIOD
	,C51.VACDAYSPERMONTH,C51.DORELIEVE,CCD.Name DESIGNATION
FROM COM_CC50051 C51 WITH (NOLOCK)
	,COM_CCCCDATA CC WITH (NOLOCK),COM_CC50069 CCD WITH (NOLOCK)
WHERE CC.NODEID = C51.NODEID
	AND CC.COSTCENTERID = 50051 AND CC.CCNID69=CCD.NodeID
	AND C51.IsGroup=0 AND C51.NODEID > 2 ''

IF(LEN(@EmpWhere)>0)
SET @S1=@S1 +'' AND C51.NodeID IN('' +@EmpWhere+'') ''

IF(LEN(@CCWhere)>0)
SET @S1=@S1 +@CCWhere

print @S1

INSERT INTO @TAB
EXEC sp_executesql @S1

--SELECT * FROM @TAB

 --AND C51.NODEID IN (10)
-- AND CC.CCNID2 IN (5)


SET @STRVACDAYS1 = 0
SET @I = 1

SELECT @TRC = COUNT(*)
FROM @TAB

--VMDD
	DECLARE @VacMgmtDocID INT, @IsDefineDaysExists BIT
	CREATE TABLE #VMDD(FromMonth INT,ToMonth INT,DaysPerMonth FLOAT,ApplyToPrevMonths NVARCHAR(50),WEF DATETIME)
	CREATE TABLE #VacMonthWiseAllotedDays(ID INT Identity(1,1),VacMonth DateTime,AllotedDays FLOAT,Yearly FLOAT)
--VMDD

-- ALL EMPLOYEES VACATIAON DATA
SELECT a.InvDocDetailsID,a.DocSeqNo, b.dcCCNID51 as EmpSeqNo,
CASE WHEN d.dcAlpha1 IS NOT NULL AND ISDATE(d.dcAlpha1)=1   THEN CONVERT(DATETIME,d.dcAlpha1) ELSE NULL END as ReJoinDate,
CASE WHEN ISDATE(d.dcAlpha2) = 1 THEN CONVERT(DATETIME,d.dcAlpha2) ELSE NULL END as FromDate,
CASE WHEN ISDATE(d.dcAlpha3) = 1 THEN CONVERT(DATETIME,d.dcAlpha3) ELSE NULL END as ToDate,
CASE WHEN  d.dcAlpha4 iS NOT NULL AND ISNUMERIC( d.dcAlpha4)=1 THEN ISNULL(CONVERT(FLOAT, d.dcAlpha4), 0) ELSE 0 END as NoOfDays,
ISNULL(CONVERT(FLOAT, d.dcAlpha11), 0) as ExcessDays,ISNULL(CONVERT(FLOAT, d.dcAlpha14), 0) as EncashDays
INTO #ALLEMPVACDATA

	FROM INV_DocDetails a WITH (NOLOCK)
	JOIN COM_DocCCData b WITH (NOLOCK) ON b.INVDOCDETAILSID = a.INVDOCDETAILSID
	JOIN COM_DocTextData d WITH (NOLOCK) ON d.INVDOCDETAILSID = a.INVDOCDETAILSID
	WHERE d.tCostCenterID = 40072 AND a.StatusID = 369 AND DocSeqNo=1
		AND b.dcCCNID51 IN (SELECT NODEID FROM @TAB )
		AND LEN(d.dcAlpha2) = 11
		AND LEN(d.dcAlpha3) = 11
		AND ISDATE(d.dcAlpha2) = 1
		AND ISDATE(d.dcAlpha3) = 1
		AND ISNUMERIC(d.dcAlpha4) = 1
		AND ISNUMERIC(d.dcAlpha11) = 1
	ORDER BY CONVERT(DATETIME, d.dcAlpha2)
-- ALL VACATAION MANAGEMENT DATA
SELECT a.InvDocDetailsID,a.DocSeqNo,a.DocID, b.dcCCNID53 as GradeSeqNo,
ISNULL(d.DCALPHA3, ''0'') as dcAlpha3,ISNULL(d.DCALPHA4, ''0'') as dcAlpha4,
ISNULL(d.DCALPHA8,''NO'') as dcAlpha8 ,ISNULL(d.DCALPHA9,''NO'') as dcAlpha9 ,ISNULL(d.dcAlpha15,''NO'') as dcAlpha15 ,ISNULL(d.DCALPHA18,''1'') as dcAlpha18,C52.Name VacFieldName,ISNULL(d.dcAlpha23,''No'') dcAlpha23 ,dcAlpha1,ISNULL(dcAlpha5,0) dcAlpha5,ISNULL(dcAlpha22,''No'') dcAlpha22,ISNULL(DCALPHA24,''No'') DCALPHA24
INTO #ALLVACMGTDATA

	FROM INV_DocDetails a WITH (NOLOCK)
	JOIN COM_DocCCData b WITH (NOLOCK) ON b.INVDOCDETAILSID = a.INVDOCDETAILSID
	JOIN COM_DocTextData d WITH (NOLOCK) ON d.INVDOCDETAILSID = a.INVDOCDETAILSID
	JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.NodeID=CONVERT(BIGINT,d.dcAlpha1)
	WHERE d.tCostCenterID=40061 AND DocSeqNo=1 AND A.StatusID=369
	

--ALL EMPS MONTHLY PAYROLL DATA
SELECT dcCCNID51 as EmpSeqNo,CONVERT(FLOAT,TD.DCALPHA9) DCALPHA9,CONVERT(DATETIME,ID.DUEDATE) DUEDATE
INTO #ALLEMPMONDATA
FROM INV_DOCDETAILS ID WITH (NOLOCK)
JOIN COM_DOCTEXTDATA TD WITH (NOLOCK) ON TD.INVDOCDETAILSID=ID.INVDOCDETAILSID 
Join com_DocccData cc WITH (NOLOCK) on cc.invDocdetailsid=ID.invDocdetailsid
Where TD.tCostcenterID=40054 and cc.dcCCNID51 IN (SELECT NODEID FROM @TAB) 
AND ISNUMERIC(TD.DCALPHA9)=1

--ALL EMPS FSENCASH DAYS
SELECT CC.dcCCNID51 as EmpSeqNo,ISNULL(CONVERT(FLOAT, t.dcAlpha15), 0) FSEncashDays,CONVERT(DATETIME,dcAlpha3) ResgDate 
INTO #ALLEMPFSENCASHDATA
FROM INV_DocDetails I WITH(NOLOCK)
JOIN COM_DocCCData CC WITH(NOLOCK) ON CC.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_DocTextData T WITH(NOLOCK) ON T.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_DocNumData N WITH(NOLOCK) ON N.InvDocDetailsID=I.InvDocDetailsID
JOIN COM_CC50052 C52 WITH(NOLOCK) ON C52.Name=dcAlpha12 AND C52.Name IN (SELECT TOP 1 VacFieldName FROM #ALLVACMGTDATA WITH(NOLOCK))
WHERE T.tCostCenterID=40095 AND dcAlpha1=''2'' AND dcAlpha10=''Partial'' AND ISDATE(dcAlpha3)=1 and cc.dcCCNID51 IN (SELECT NODEID FROM @TAB)




Declare @VCnt INT
SET @VCnt=0

WHILE (@I <= @TRC)
BEGIN
	SET @STRVACDAYS = 0
	SET @STRVACDAYS1 = 0
	SET @VT=0
	SET @VacationMonthsDiff = 0
	SET @VACDAYSPERIOD = ''''
	SET @VACDAYSPERMONTH = 0

	SELECT @NODEID = NODEID
		,@EMPNAME = EMPNAME
		,@EMPCODE = EMPCODE
		,@GRADE = CASE WHEN @GrWiseVac=1 THEN GRADE ELSE 1 END
		,@VACDAYSPERIOD = VACDAYSPERIOD
		,@VACDAYSPERMONTH = VACDAYSPERMONTH
		,@VacationMonthsDiff = MONTHDIFF
		,@DOJ = DOJ
		,@DOJ1 = DOJ1
		,@OPENINGBAL = OPENINGBAL
		,@LASON = LEAVEASONDATE
		,@DORELIEVE=DORELIEVE
		,@DESIGNATION=DESIGNATION
	FROM @TAB
	WHERE ID = @I

	--VMDD
	SET @VacMgmtDocID=0 

	TRUNCATE TABLE #VMDD
	TRUNCATE TABLE #VacMonthWiseAllotedDays
	TRUNCATE TABLE #VacDayTab
	--VMDD


	SELECT @ConsiderLOPwhilecalculatingcreditdays=DCALPHA8,@Calculatevacdayforvacationperiod=DCALPHA9,@ExcessDaysAsLOP=dcAlpha15,
	@VacMgmtDocID=DocID ,@CreditDaysCalculation=DCALPHA18,@CalcCreditFromDOJ=DCALPHA23,@VacationLeaveType=isnull(dcAlpha1,0),@CreditDaysBasedOnMP=ISNULL(dcAlpha5,0),@ConsiderCreditDaysforVacationPeriodonNextVacation=DCALPHa22,@CalcLopFromDocsifPayrollNotProcessed=ISNULL(DCALPHA24,''No'')
	FROM #ALLVACMGTDATA  WITH (NOLOCK)
	WHERE GradeSeqNo = ( CASE WHEN @GrWiseVac=1 THEN  (SELECT GRADE FROM @TAB WHERE NODEID=@NODEID) ELSE 1 END )

--SET @CreditDaysCalculation=3
--SET @RoundOffVacDays=0

---------------------------------------------------------------------------------
--VMDD
	SET @IsDefineDaysExists=0
	IF EXISTS (SELECT SeqNo FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID)
	BEGIN
		SET @IsDefineDaysExists=1
		INSERT INTO #VMDD
		SELECT FromMonth,ToMonth,DaysPerMonth,ApplyToPrevMonths ,WEF
		FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID

		DECLARE @VacationDefBasedOn INT
		select @VacationDefBasedOn=ISNULL(PrefValue,1) from COM_DocumentPreferences WITH(NOLOCK) WHERE PrefName=''VacationDefBasedOn''

		declare @dtt1 datetime,@dtt2 datetime,@TotMon INT,@AllotedDays FLOAT,@MNo INT,@APM NVARCHAR(50),@YearlyVD FLOAT
		set @dtt1=dateadd(day,-datepart(day,@DOJ1)+1,@DOJ1)
		set @dtt2=dateadd(day,-datepart(day,@ENDDATE)+1,@ENDDATE)
		set @dtt2=DATEADD(year,1,@dtt2) -- adding extra 1 year to know the yearly vacation days
		SET @MNo=0
		WHILE(@dtt1<=@dtt2)
		BEGIN
			SET @MNo=@MNo+1

			IF(ISNULL(@VacationDefBasedOn,1)=1)
				SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WHERE @MNo BETWEEN FromMonth AND ToMonth
			ELSE
				SELECT TOP 1 @AllotedDays=DaysPerMonth/12,@APM=ApplyToPrevMonths FROM #VMDD WHERE WEF<=@dtt1 ORDER BY WEF DESC
			
			SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WHERE @MNo BETWEEN FromMonth AND ToMonth
			INSERT INTO #VacMonthWiseAllotedDays
			SELECT @dtt1,@AllotedDays,-1

			IF(@APM=''Yes'')
				UPDATE #VacMonthWiseAllotedDays SET AllotedDays=@AllotedDays

			IF(@MNo%12)=0
			BEGIN
				SELECT @YearlyVD=SUM(AllotedDays) FROM #VacMonthWiseAllotedDays WHERE Yearly=-1
				
				IF(@APM=''Yes'')
					UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD
				ELSE
					UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD WHERE Yearly=-1

			END

		 SET @dtt1=DATEADD(month,1,@dtt1)
		END

	END
	--SELECT * FROM #VacMonthWiseAllotedDays
--VMDD
---------------------------------------------------------------------------------

--START: GET VACDAYS FIELD FROM MONTHLY PAYROLL
SELECT @COMPONENTIDSNO=SNO FROM COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@CreditDaysBasedOnMP AND GRADEID=@Grade AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE  GradeID=@Grade)
SET @syColName=''dcNum''+convert(Varchar,@COMPONENTIDSNO)
	
IF(ISNULL(@syColName,'''')<>'''' AND ISNULL(@Doj,'''')<>'''' AND ISNULL(@ToDate,'''')<>'''')
BEGIN
	
	SET @strQry=''INSERT INTO #VacDayTab 
					SELECT  ISNULL(''+ @syColName +'',0),CONVERT(DateTime,ID.DUEDATE)  FROM INV_DOCDETAILS ID WITH(NOLOCK) 
					JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID 
					JOIN COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
					WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@NODEID) +'' AND ID.Vouchertype=11
							AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DUEDATE) BETWEEN CONVERT(DATETIME,''''''+ convert(Varchar,@Doj) +'''''') and CONVERT(DATETIME,''''''+ convert(Varchar,@ToDate)+'''''')''
PRINT (@strQry)
	EXEC sp_executesql @STRQRY
		
END
--END: GET VACDAYS FIELD FROM MONTHLY PAYROLL	

	INSERT INTO @MonthDays VALUES (@NODEID,@EMPCODE,''Opening'',NULL,NULL,NULL,NULL,0,0,0,0,0,'''','''',0,0,@LASON)

	SET @RC1 = 0
	WHILE (@RC1 <= @VacationMonthsDiff)
	BEGIN
		IF (@RC1 = 0)
		BEGIN
			SET @MONT1 = DATEADD(MONTH, @RC1, @DOJ)
			SET @MONT2 = DATEADD(D, 0, DATEADD(D, - 1, DATEADD(MM, DATEDIFF(M, 0, @DOJ) + 1, 0)))
		END
		ELSE IF (@RC1 = @VacationMonthsDiff)
		BEGIN
			SET @MONT1 = DATEADD(MONTH, @RC1, DATEADD(M, DATEDIFF(M, 0, @DOJ), 0))
			SET @MONT2 = DATEADD(D, - 1, DATEADD(MM, DATEDIFF(M, 0, @MONT1) + 1, 0))
		END
		ELSE
		BEGIN
			SET @MONT1 = DATEADD(MONTH, @RC1, DATEADD(M, DATEDIFF(M, 0, @DOJ), 0))
			SET @MONT2 = DATEADD(D, - 1, DATEADD(MM, DATEDIFF(M, 0, @MONT1) + 1, 0))
		END

		IF(ISNULL(@DORELIEVE,'''')<>'''')
		BEGIN
			IF(CONVERT(DATETIME,@DORELIEVE)<@MONT2)
				SET @MONT2=CONVERT(DATETIME,@DORELIEVE)

		END

		IF(@CreditDaysCalculation=3 AND MONTH(@MONT1)=2)
		BEGIN
			INSERT INTO @MonthDays VALUES ( @NODEID,@EMPCODE,@EMPNAME,@DOJ1,@DESIGNATION,@MONT1,@MONT2,28,CASE WHEN ISDATE(CAST(YEAR(@MONT1) AS CHAR(4))+''0229'')=1 THEN 28 ELSE (DATEDIFF(D, @MONT1, @MONT2) + 1) END,0
			,CASE WHEN DATEADD(M, 6, CONVERT(DATETIME, @DOJ1)) > CONVERT(DATETIME, @ENDDATE)
					THEN ISNULL((
									SELECT DCALPHA3 FROM #ALLVACMGTDATA WHERE GradeSeqNo=@GRADE
								), 0)
				WHEN DATEADD(M, 12, CONVERT(DATETIME, @DOJ1)) > CONVERT(DATETIME, @ENDDATE)
					THEN ISNULL((
								SELECT DCALPHA4 FROM #ALLVACMGTDATA WHERE GradeSeqNo=@GRADE
								), ''0'')
				ELSE (
						CASE @VACDAYSPERIOD
							WHEN ''Yearly''
								THEN ROUND((CAST(@VACDAYSPERMONTH AS FLOAT) / CAST (12 AS FLOAT)),2,1)
							ELSE @VACDAYSPERMONTH
							END
						)
				END
			,0,'''','''',0,0,NULL)
		END
		ELSE
		BEGIN
			INSERT INTO @MonthDays VALUES ( @NODEID,@EMPCODE,@EMPNAME,@DOJ1,@DESIGNATION,@MONT1,@MONT2,DATEDIFF(D, DATEADD(MONTH, 0, DATEADD(M, DATEDIFF(M, 0, @MONT1), 0)), DATEADD(D, - 1, DATEADD(MM, DATEDIFF(M, 0, @MONT2) + 1, 0))) + 1,DATEDIFF(D, @MONT1, @MONT2) + 1,0
			,CASE WHEN DATEADD(M, 6, CONVERT(DATETIME, @DOJ1)) > CONVERT(DATETIME, @ENDDATE)
					THEN ISNULL((
									SELECT DCALPHA3 FROM #ALLVACMGTDATA WHERE GradeSeqNo=@GRADE
								), 0)
				WHEN DATEADD(M, 12, CONVERT(DATETIME, @DOJ1)) > CONVERT(DATETIME, @ENDDATE)
					THEN ISNULL((
								SELECT DCALPHA4 FROM #ALLVACMGTDATA WHERE GradeSeqNo=@GRADE
								), ''0'')
				ELSE (
						CASE @VACDAYSPERIOD 
							WHEN ''Yearly''
								THEN ROUND((CAST(@VACDAYSPERMONTH AS FLOAT) / CAST (12 AS FLOAT)),2,1)
							ELSE @VACDAYSPERMONTH
							END
						)
				END
			,0,'''','''',0,0,NULL)
		END

			
--VMDD
IF(@IsDefineDaysExists=1)
BEGIN
	Update @MonthDays
	SET DAYSASON=b.AllotedDays
	FROM @MonthDays a
	JOIN #VacMonthWiseAllotedDays b ON MONTH(b.VacMonth)=MONTH(a.FDATE) AND YEAR(b.VacMonth)=YEAR(a.FDATE)
	WHERE EMPNODE=@NODEID
END

--VMDD

SET @VacTaken=0 SET @EnDays=0
SET @VCnt=0

SELECT @VCnt=EmpSeqNo FRom #ALLEMPVACDATA WITH (NOLOCK)
WHERE EmpSeqNo=@NODEID AND ( (FromDate BETWEEN @MONT1 AND @MONT2) OR 
							(ToDate BETWEEN @MONT1 AND @MONT2) OR
							(@MONT1 BETWEEN FromDate AND ToDate) OR
							(@MONT2 BETWEEN FromDate AND ToDate) 
							)
			IF(@VCnt>0)
			BEGIN
				EXEC spPAY_GetVacationLeavesInfo @MONT1
							,@MONT2
							,@NODEID
							,1
							,1
							,1,@VacTaken OUTPUT,@EnDays OUTPUT
			END
			SET @VT=@VacTaken

			IF(ISNULL(@Calculatevacdayforvacationperiod,''NO'')=''NO'' and @ConsiderCreditDaysforVacationPeriodonNextVacation<>''Yes'' AND @VT IS NOT NULL AND @VT>0 )
				BEGIN
					--SELECT @VT,@MONT1,@MONT2
					UPDATE @MonthDays
					SET ACTUALDAYS= CASE WHEN SUBSTRING(CONVERT(VARCHAR(12), @DOJ, 106), 4, 8)<>SUBSTRING(CONVERT(VARCHAR(12), @MONT1, 106), 4, 8) THEN TOTALDAYS-@VT ELSE ACTUALDAYS-@VT END
					WHERE EMPNODE = @NODEID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @MONT1, 106), 4, 8)
				END

		UPDATE @MONTHDAYS
		SET OPENINGBAL = @OPENINGBAL
		WHERE @LASON <> ''Jan  1 1900 12:00AM''
			AND EMPNODE = @NODEID
			AND EMPNAME = ''OPENING''

		SET @RC1 = @RC1 + 1
	END

	IF(ISNULL(@CreditDaysBasedOnMP,0)>0)
	BEGIN
		UPDATE M SET Days=T.VacDays FROM  @MonthDays M
		JOIN #VacDayTab T WITH(NOLOCK) ON T.Payrolldate=M.FDATE
	END
	ELSE IF(@CreditDaysCalculation=1)
	BEGIN
		IF(@RoundOffVacDays=1)
			UPDATE @MonthDays SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
			WHERE EMPNODE = @NODEID
			AND EMPNAME <> ''OPENING''
		ELSE
			UPDATE @MonthDays SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
			WHERE EMPNODE = @NODEID
			AND EMPNAME <> ''OPENING''


	END
	ELSE
	BEGIN
		IF(@RoundOffVacDays=1)
			UPDATE @MonthDays
			SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
			WHERE EMPNODE = @NODEID AND EMPNAME <> ''OPENING''
		ELSE
			UPDATE @MonthDays
			SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
			WHERE EMPNODE = @NODEID AND EMPNAME <> ''OPENING''

	END

	SET @I = @I + 1
END

--SELECT * FROM @MonthDays
DECLARE @C int
SET @C=0
SET @K = 1

SELECT @KK = COUNT(*)
FROM @MonthDays

DECLARE CUR1 CURSOR FAST_FORWARD FOR
SELECT ID,FDATE,TDATE,EMPNODE
FROM @MONTHDAYS
OPEN CUR1
FETCH NEXT FROM CUR1 INTO @K,@FMONTH,@TMONTH,@EID
WHILE @@FETCH_STATUS=0
BEGIN

--------------------
	SET @C+=1
	SET @ACVDAYS = 0
	SET @STRVACDAYS = 0
	SET @VT=0
	SET @STRFROMDATERANGE = ''''
	SET @STRTODATERANGE = ''''
	

	SELECT @DJ=DOJ,@DR=CONVERT(DATETIME,DORELIEVE) FROM @TAB WHERE NODEID=@EID

	SELECT @ConsiderLOPwhilecalculatingcreditdays=DCALPHA8,@Calculatevacdayforvacationperiod=DCALPHA9,@ExcessDaysAsLOP=dcAlpha15,@CreditDaysCalculation=DCALPHA18
	FROM #ALLVACMGTDATA WITH (NOLOCK)
	WHERE GradeSeqNo = (CASE WHEN @GrWiseVac=1 THEN ( SELECT GRADE FROM @TAB WHERE NODEID=@EID) ELSE 1 END )

	SET @LOPDAYS=0

	IF(@ConsiderLOPwhilecalculatingcreditdays=''Yes'' AND ISNULL(@CreditDaysBasedOnMP,0)=0)
	BEGIN

		SET @CNT=0

		SELECT @CNT=COUNT(EmpSeqNo) 
		FROM #ALLEMPMONDATA WITH (NOLOCK)
		Where EmpSeqNo=@EID AND CONVERT(DATETIME,DUEDATE) BETWEEN 	@FMONTH AND @TMONTH

		IF(@CNT>0)-- CHECKING FROM MONTHLY PAYROLL
		BEGIN
			SELECT @LOPDAYS=CONVERT(FLOAT,DCALPHA9) 
			FROM #ALLEMPMONDATA WITH (NOLOCK)
			Where EmpSeqNo=@EID AND CONVERT(DATETIME,DUEDATE) BETWEEN 	@FMONTH AND @TMONTH

			IF EXISTS(SELECT SeqNo FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EID AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@FMONTH)),0))
			BEGIN
				SELECT @LOPDAYS=ISNULL(@LOPDAYS,0) - ISNULL(Days,0) FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@EID AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@FMONTH)),0)
			END

		END
		ELSE IF(@CalcCreditFromDOJ=''Yes'')--START-CHECKING FROM VACATION LATE REJOIN AND LOP LEAVE 
		BEGIN

			--START--VACATION LATE REJOIN LOP
			TRUNCATE TABLE #TVacLOP
			INSERT INTO #TVacLOP
			SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3)
			FROM INV_DocDetails a WITH(NOLOCK) 
			JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
			JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
			WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@EID
			AND ISNULL(D.DCALPHA1,'''')<>'''' AND CONVERT(DATETIME,D.DCALPHA1)>DATEADD(D,1,CONVERT(DATETIME,D.dcAlpha3))
			AND ( @FMONTH BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					@TMONTH BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
					CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @FMONTH AND  @TMONTH OR 
					CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @FMONTH AND  @TMONTH )
					
			 
			SELECT @TVacLOPCNT=COUNT(*) FROM #TVacLOP WITH (NOLOCK)
			SET @I3=1
			WHILE(@I3<=@TVacLOPCNT)
			BEGIN
				SELECT @LOPRD=REJOIN,@LOPFD=FROMDATE,@LOPTD=TODATE FROM #TVacLOP WITH (NOLOCK) WHERE ID=@I3
				SET @ids=0

				if (@LOPRD >= @FMONTH)
                BEGIN
                    if (@LOPTD >= @FMONTH AND @LOPTD <= @TMONTH)
                        SET @dttmp = DATEADD(D,1,@LOPTD)
                    else
                        SET @dttmp = @FMONTH;

                    if (@LOPRD >= @FMONTH AND @LOPRD <= @TMONTH)
                        SET @dttmp1 = @LOPRD;
                    else
                        SET @dttmp1 = DATEADD(D,1,@TMONTH)

                    if (@LOPTD < @dttmp1)
                    BEGIN
                        while (@dttmp < @dttmp1)
                        BEGIN
                            SET @ids=@ids+1
                            SET @dttmp = DATEADD(D,1,@dttmp)
                        END
                    END
                END
					
				SET @LOPDAYS=@LOPDAYS+@ids
				SET @I3=@I3+1
			END
			--END--VACATION LATE REJOIN LOP

			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),CONVERT(FLOAT,d.dcAlpha7)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@EID)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@FMONTH)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@TMONTH)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@FMONTH)+'''''' AND  ''''''+CONVERT(Varchar,@TMONTH)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@FMONTH)+'''''' AND  ''''''+CONVERT(Varchar,@TMONTH)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR

					
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH (NOLOCK)
				SET @K3=1
				WHILE(@K3<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID FROM #TLeaveLOP WITH (NOLOCK) WHERE ID=@K3
					SET @CurrYearLeavestaken=0
					EXEC spPAY_GetCurrYearLeavesInfo @FMONTH,@TMONTH,@EID,@LeaveID,1,1,@MONT1,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT

					
				SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken
				SET @K3=@K3+1
				END
			END
			--END--LOP LEAVES

			--START--EXCESS DAYS AS LOP
			IF(@ExcessDaysAsLOP=''Yes'')
			BEGIN
				TRUNCATE TABLE #TVacExcessLOP
				INSERT INTO #TVacExcessLOP	
				SELECT DISTINCT CONVERT(DATETIME,D.DCALPHA1),CONVERT(DATETIME,D.DCALPHA2),CONVERT(DATETIME,D.DCALPHA3),CONVERT(FLOAT,d.dcAlpha10),CONVERT(FLOAT,d.dcAlpha11)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tCostCenterID=40072 and a.StatusID=369  AND b.dcCCNID51=@EID AND CONVERT(FLOAT,ISNULL(d.dcAlpha11,0))>0
				AND ( @FMONTH BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						@TMONTH BETWEEN CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,d.dcAlpha3) OR 
						CONVERT(DATETIME,d.dcAlpha2) BETWEEN  @FMONTH AND  @TMONTH OR 
						CONVERT(DATETIME,d.dcAlpha3) BETWEEN  @FMONTH AND  @TMONTH )

					
				
				SELECT @TVacEXLOPCNT=COUNT(*) FROM #TVacExcessLOP WITH (NOLOCK)
				SET @L=1

				WHILE(@L<=@TVacEXLOPCNT)
				BEGIN
					SELECT @LOPEXRD=REJOIN,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@EXPAIDDAYS=PaidDays,@EXEXCESSDAYS=ExcessDays FROM #TVacExcessLOP WITH (NOLOCK) WHERE ID=@L	

					IF(@LOPEXFD>=@FMONTH AND @LOPEXTD<=@TMONTH)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@EXEXCESSDAYS
					END
					ELSE
					BEGIN
						
						
					DECLARE @VACDatesRange TABLE (SNO INT IDENTITY(1,1),ID INT ,DATE1 DATETIME,DAYNAME VARCHAR(50),WEEKNO INT,COUNT INT,NOOFDAYS Float,FLAG INT,IncExc varchar(5),ExcessDays INT)
					Declare @WEEKOFFCOUNT1 Table (ID INT ,WEEKDATE DateTime,DAYNAME Varchar(50),WEEKNO Int,COUNT Int,WEEKNOMANUAL Int)

				;WITH DATERANGE1 AS
				(
				SELECT @LOPEXFD AS DT,1 AS ID
				UNION ALL
				SELECT DATEADD(DD,1,DT),DATERANGE1.ID+1 FROM DATERANGE1 WHERE ID<=DATEDIFF("d",convert(varchar,@LOPEXFD,101),convert(varchar,@LOPEXTD,101))
				)
		
				INSERT INTO @VACDatesRange
				SELECT ROW_NUMBER() OVER (ORDER BY DT) AS ID,DT AS WEEKDATE,DATENAME(DW,DT) AS DAY,0,1,0,1,'''',1 FROM DATERANGE1
			
				--START WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
				INSERT INTO @WEEKOFFCOUNT1
				EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@EID,0,1,1

				--select * from @WEEKOFFCOUNT1
				UPDATE DATESCOUNT SET DATESCOUNT.count=3 FROM @WEEKOFFCOUNT1 WEEKOFFCOUNT inner join @VACDatesRange DATESCOUNT on CONVERT(DateTime,DATESCOUNT.date1)= CONVERT(DateTime,WEEKOFFCOUNT.weekdate) and WEEKOFFCOUNT.count=1
			
				--START-- HOLIDAY COUNT
					Declare @HOLIDAYCOUNT1 Table (ID int Identity(1,1),WEEKDATE Nvarchar(max),Remarks nvarchar(max))
					INSERT INTO @HOLIDAYCOUNT1
					EXEC spPAY_GetVacationWeekoff @LOPEXFD,@LOPEXTD,@EID,1,1,1
				--END -- HOLIDAY COUNT

				--START : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
					UPDATE DATESCOUNT SET DATESCOUNT.count=4 FROM @VACDatesRange DATESCOUNT 
					inner join @HOLIDAYCOUNT1 TD on CONVERT(DATETIME,DATESCOUNT.DATE1)=CONVERT(DATETIME,TD.WEEKDATE)
				--END : UPDATING @DATESAPPLIEDCOUNT Table ''COUNT'' COLUMN TO  ''4- FOR HOLIDAY''
				--END WEEKOFF AND HOLIDAY UPDATEING IN @VACDatesRange
				Declare @IC  Int,@DTT  DateTime,@INCREXC VARCHAR(50)

				SELECT @INCREXC=ISNULL(INCLUDEREXCLUDE,'''') FROM COM_CC50054 WITH(NOLOCK) WHERE GRADEID=@Grade AND COMPONENTID=@VacationLeaveType AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@FMONTH) AND GradeID=@Grade)

				SET @IC=1
				SELECT @TRC=COUNT(*) FROM @VACDatesRange
				WHILE(@IC<=@TRC)
				BEGIN

					SELECT @DTT=DATE1 FROM @VACDatesRange WHERE id=@IC

					IF ISNULL(@INCREXC,'''')=''IncludeHolidays'' OR ISNULL(@INCREXC,'''')=''ExcludeWeeklyOffs''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EW'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=3
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeWeeklyOffs'' OR ISNULL(@INCREXC,'''')=''ExcludeHolidays''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EH'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT)  AND COUNT=4
					ELSE IF ISNULL(@INCREXC,'''')=''IncludeBoth''
						UPDATE @VACDatesRange SET FLAG=1 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) 
					ELSE IF ISNULL(@INCREXC,'''')=''ExcludeBoth''
						UPDATE @VACDatesRange SET FLAG=0,IncExc=''EB'',ExcessDays=0 WHERE CONVERT(DATETIME,DATE1)=CONVERT(DATETIME,@DTT) AND COUNT IN (3,4)

				SET @IC=@IC+1
				END
			
				SELECT @CNT3=COUNT(*) FROM @VACDatesRange
				SET @Y=1
				WHILE(@Y<=@CNT3)
				BEGIN
					IF(@EXPAIDDAYS>0 AND (SELECT COUNT(*) FROM @VACDatesRange WHERE id=@Y AND FLAG=1 AND count>=1 and isnull(IncExc,'''')='''' )>0)
					BEGIN
						UPDATE @VACDatesRange SET ExcessDays=0 WHERE id=@Y
						SET @EXPAIDDAYS=@EXPAIDDAYS-1
					END

				SET @Y=@Y+1
				END

				SET @LDAYS=0
				SELECT @LDAYS=COUNT(EXCESSDAYS) FROM @VACDatesRange WHERE EXCESSDAYS=1 AND DATE1 BETWEEN @FMONTH AND @TMONTH


				delete from  @VACDatesRange
				delete from @WEEKOFFCOUNT1

				SET @LOPDAYS=@LOPDAYS+@LDAYS
					END
						
				SET @L=@L+1
				END

			END

			--END--EXCESS DAYS AS LOP


		END--END-CHECKING FROM VACATION LATE REJOIN
		ELSE IF(@CalcLopFromDocsifPayrollNotProcessed=''Yes'')--Calculate Lop from Leaves if payroll is not processed
		BEGIN
			--START--LOP LEAVES 	
			IF(ISNULL(@ConsiderLOPBasedOn,'''')<>'''')
			BEGIN
				TRUNCATE TABLE #TLeaveLOP
					
				SET @STR=''INSERT INTO #TLeaveLOP	
				SELECT b.dcCCNID52,CONVERT(DATETIME,d.dcAlpha4),CONVERT(DATETIME,d.dcAlpha5),CONVERT(FLOAT,d.dcAlpha7)
				FROM INV_DocDetails a WITH(NOLOCK) 
				JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
				JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
				WHERE d.tDocumentType=62 and a.StatusID=369  AND b.dcCCNID51=''+CONVERT(Varchar,@EID)+'' AND b.dcCCNID52 IN (''+@ConsiderLOPBasedOn+'')
				AND ( ''''''+CONVERT(Varchar,@FMONTH)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						''''''+CONVERT(Varchar,@TMONTH)+'''''' BETWEEN CONVERT(DATETIME,d.dcAlpha4) AND CONVERT(DATETIME,d.dcAlpha5) OR 
						CONVERT(DATETIME,d.dcAlpha4) BETWEEN  ''''''+CONVERT(Varchar,@FMONTH)+'''''' AND  ''''''+CONVERT(Varchar,@TMONTH)+'''''' OR 
						CONVERT(DATETIME,d.dcAlpha5) BETWEEN  ''''''+CONVERT(Varchar,@FMONTH)+'''''' AND  ''''''+CONVERT(Varchar,@TMONTH)+'''''' )''
				--PRINT @STR
				EXEC sp_executesql @STR
	
				SELECT @TLeaveLOPCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK)
				SET @K=1
				DECLARE @LCNT FLOAT
				WHILE(@K<=@TLeaveLOPCNT)
				BEGIN
					SELECT @LeaveID=LeaveID,@LOPEXFD=FROMDATE,@LOPEXTD=TODATE,@LOPNoOfDays=NoOfDays FROM #TLeaveLOP WITH(NOLOCK) WHERE ID=@K

					SELECT @LCNT=COUNT(*) FROM #TLeaveLOP WITH(NOLOCK) WHERE LeaveID=@LeaveID AND ( CONVERT(Varchar,@FMONTH) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(Varchar,@TMONTH) BETWEEN CONVERT(DATETIME,FROMDATE) AND CONVERT(DATETIME,TODATE) OR 
						CONVERT(DATETIME,FROMDATE) BETWEEN  CONVERT(Varchar,@FMONTH) AND  CONVERT(Varchar,@TMONTH) OR 
						CONVERT(DATETIME,TODATE) BETWEEN  CONVERT(Varchar,@FMONTH) AND  CONVERT(Varchar,@TMONTH) )

					IF(@LOPEXFD>=@FMONTH AND @LOPEXTD<=@MONT2 AND ISNULL(@LCNT,0)<=1)
					BEGIN
						SET @LOPDAYS=@LOPDAYS+@LOPNoOfDays
					END
					ELSE
					BEGIN
						IF NOT EXISTS(SELECT * FROM @TAB2 WHERE LEAVETYPEID=@LeaveID AND MONT1=@FMONTH AND MONT2=@TMONTH)
						BEGIN
							SET @CurrYearLeavestaken=0
							EXEC spPAY_GetCurrYearLeavesInfo @FMONTH,@TMONTH,@EID,@LeaveID,1,1,@FMONTH,0,@CurrYearLeavestaken OUTPUT,@NOOFHOLIDAYS1 OUTPUT,@WEEKLYOFFCOUNT1 OUTPUT,@EXSTAPPLIEDENCASHDAYS OUTPUT	
							SET @LOPDAYS=@LOPDAYS+@CurrYearLeavestaken

							INSERT INTO @TAB2
							SELECT @FMONTH,@TMONTH,@LeaveID
						END
					END
				SET @K=@K+1
				END
			END
			--END--LOP LEAVES
		END

		IF ((SUBSTRING(CONVERT(VARCHAR(12), @FMONTH, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @DJ, 106), 4, 8))
					AND
		(SUBSTRING(CONVERT(VARCHAR(12), @TMONTH, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @DR, 106), 4, 8)) )
		begin
			UPDATE @MonthDays
			SET ACTUALDAYS=ACTUALDAYS-ISNULL(@LOPDAYS,0)
			WHERE EMPNODE = @EID
			and fdate=@FMONTH and Tdate=@TMONTH
			AND ID = @K
			
			IF(@CreditDaysCalculation=1)
			BEGIN
				IF(@RoundOffVacDays=1)				
					UPDATE @MonthDays
					SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
			ELSE
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
		end
		ELSE
		begin
		UPDATE @MonthDays
			SET ACTUALDAYS=ACTUALDAYS-ISNULL(@LOPDAYS,0)
			WHERE EMPNODE = @EID
			and fdate=@FMONTH and Tdate=@TMONTH
			AND ID = @K
			
			IF(@CreditDaysCalculation=1)
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
			ELSE
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K

			END
		end
	END

	IF(@ConsiderLOPwhilecalculatingcreditdays=''No'' AND ISNULL(@CreditDaysBasedOnMP,0)=0)
	BEGIN
	SET @RJLOPDAYS=0
	--START--VACATION LATE REJOIN LOP
			TRUNCATE TABLE #TVacLOP

			INSERT INTO #TVacLOP
			SELECT DISTINCT ReJoinDate,FromDate,ToDate
			FROM #ALLEMPVACDATA a WITH(NOLOCK) 
			WHERE EmpSeqNo=@EID
			AND ReJoinDate>DATEADD(D,1,ToDate)
			AND ( @FMONTH BETWEEN DATEADD(D,1,ToDate) AND ReJoinDate OR 
					@TMONTH BETWEEN DATEADD(D,1,ToDate) AND ReJoinDate OR 
					DATEADD(D,1,ToDate) BETWEEN  @FMONTH AND  @TMONTH OR 
					ReJoinDate BETWEEN  @FMONTH AND  @TMONTH )
			 
			SELECT @TVacLOPCNT=COUNT(*) FROM #TVacLOP WITH (NOLOCK)
		
			SET @I3=1
			WHILE(@I3<=@TVacLOPCNT)
			BEGIN
				SELECT @LOPRD=REJOIN,@LOPFD=FROMDATE,@LOPTD=TODATE FROM #TVacLOP WITH (NOLOCK) WHERE ID=@I3
				SET @ids=0
				
				if (@LOPRD >= @FMONTH)
                BEGIN
				
                    if (@LOPTD >= @FMONTH AND @LOPTD <= @TMONTH)
                        SET @dttmp = DATEADD(D,1,@LOPTD)
                    else
                        SET @dttmp = @FMONTH;

                    if (@LOPRD >= @FMONTH AND @LOPRD <= @TMONTH)
                        SET @dttmp1 = @LOPRD;
                    else
                        SET @dttmp1 = DATEADD(D,1,@TMONTH)
						
                    if (@LOPTD < @dttmp1)
                    BEGIN
					--SELECT @LOPRD LOPRD,@LOPFD LOPFD,@LOPTD LOPTD,@TMONTH TMONTH,@FMONTH FMONTH,@dttmp dttmp,@dttmp1 dttmp1
                        while (@dttmp < @dttmp1)
                        BEGIN
                            SET @ids=@ids+1
                            SET @dttmp = DATEADD(D,1,@dttmp)
                        END
                    END
                END
					
				SET @RJLOPDAYS=@RJLOPDAYS+@ids
				SET @I3=@I3+1
			END
	--END--VACATION LATE REJOIN LOP

	IF ((SUBSTRING(CONVERT(VARCHAR(12), @FMONTH, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @DJ, 106), 4, 8))
					AND
		(SUBSTRING(CONVERT(VARCHAR(12), @TMONTH, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @DR, 106), 4, 8)) )
		begin
			UPDATE @MonthDays
			SET ACTUALDAYS=ACTUALDAYS-ISNULL(@RJLOPDAYS,0)
			WHERE EMPNODE = @EID
			and fdate=@FMONTH and Tdate=@TMONTH
			AND ID = @K
			
			IF(@CreditDaysCalculation=1)
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE 
					UPDATE @MonthDays
					SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
			ELSE
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K

			END
		end
		ELSE
		begin
			UPDATE @MonthDays SET ACTUALDAYS=ACTUALDAYS-ISNULL(@RJLOPDAYS,0)
			WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			
			IF(@CreditDaysCalculation=1)
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
			ELSE
			BEGIN
				IF(@RoundOffVacDays=1)
					UPDATE @MonthDays
					SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1)  
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
				ELSE
					UPDATE @MonthDays
					SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
					WHERE EMPNODE = @EID and fdate=@FMONTH and Tdate=@TMONTH AND ID = @K
			END
		end
	END

	SELECT @OPB = OPENINGBAL
	FROM @MonthDays
	WHERE EMPNODE = @EID AND ID = @K

	SELECT @ACVDAYS = BALANCE
	FROM @MonthDays
	WHERE ID = @K - 1 AND EMPNODE = @EID

	SELECT @ACVDAYS = CASE WHEN @RoundOffVacDays=1 OR @C=@KK THEN ROUND((ISNULL(@ACVDAYS, 0) + DAYS + @OPB),2) ELSE (ISNULL(@ACVDAYS, 0) + DAYS + @OPB) END
	FROM @MonthDays
	WHERE ID = @K AND EMPNODE = @EID

	UPDATE @MonthDays
	SET BALANCE = CASE WHEN @RoundOffVacDays=1 OR @C=@KK THEN ROUND(@ACVDAYS, 2) ELSE @ACVDAYS END
	WHERE ID = @K AND EMPNODE = @EID

	TRUNCATE TABLE #TABVAC

	INSERT INTO #TABVAC

	SELECT FromDate,
	CASE WHEN ISNULL(ReJoinDate,'''')='''' THEN ToDate WHEN ReJoinDate < ToDate THEN CONVERT(DateTime,DATEADD(D,-1,ReJoinDate)) ELSE ToDate END AS ToDate,
	CASE WHEN ISNULL(ReJoinDate,'''')='''' THEN NoOfDays WHEN ReJoinDate < ToDate then DATEDIFF(D,CONVERT(DATETIME, FromDate),CONVERT(DateTime,DATEADD(D,-1,ReJoinDate)))+1 else NoOfDays END AS NoOfDays
	FROM #ALLEMPVACDATA WITH (NOLOCK)
	WHERE EmpSeqNo=@EID
	AND (
			(
				FromDate BETWEEN CONVERT(DATETIME, CONVERT(NVARCHAR, @FMONTH))
					AND CONVERT(DATETIME, CONVERT(NVARCHAR, @TMONTH))
				)
			OR (
				ToDate BETWEEN CONVERT(DATETIME, CONVERT(NVARCHAR, @FMONTH))
					AND CONVERT(DATETIME, CONVERT(NVARCHAR, @TMONTH))	
				)
			OR (
				CONVERT(DATETIME, CONVERT(NVARCHAR, @FMONTH)) BETWEEN FromDate AND ToDate
				)
			OR (
				CONVERT(DATETIME, CONVERT(NVARCHAR, @TMONTH)) BETWEEN FromDate AND ToDate
				)
			)
	ORDER BY FromDate

	--select * from #TABVAC

	SELECT @RC = COUNT(*)
	FROM #TABVAC
	
	SET @J = 1

	
	DECLARE CUR2 CURSOR FAST_FORWARD FOR
	SELECT ID,FROMDATE,TODATE,vacdays
	FROM #TABVAC
	OPEN CUR2
	FETCH NEXT FROM CUR2 INTO @J,@VFD,@VTD,@VDays
	WHILE @@FETCH_STATUS=0
	BEGIN
		 
		IF (@VFD >= @FMONTH)
		BEGIN
			IF (@VTD <= @TMONTH)
			BEGIN
		
				IF (SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @VTD, 106), 4, 8))
				BEGIN
					SET @VacTaken=0 SET @EnDays=0

					EXEC spPAY_GetVacationLeavesInfo @VFD
						,@VTD
						,@EID
						,1
						,1
						,1,@VacTaken OUTPUT,@EnDays OUTPUT

						SET @STRVACDAYS=@VacTaken
				END
				ELSE
					SET @STRVACDAYS = @VDays
				
			
				IF(ISNULL(@Calculatevacdayforvacationperiod,''NO'')=''NO'' AND ISNULL(@CreditDaysBasedOnMP,0)=0)
				BEGIN
					SET @VT=@STRVACDAYS

					IF(@CreditDaysCalculation=1)
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays
							SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K
						ELSE
							UPDATE @MonthDays
							SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K

					END
					ELSE
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays
							SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K
						ELSE
							UPDATE @MonthDays
							SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K

					END

					
				END

				SET @EncashDays = 0

				Select @EncashDays = SUM(EncashDays)
				From #ALLEMPVACDATA WITH (NOLOCK)
				WHERE EmpSeqNo= @EID 
				AND FromDate BETWEEN @VFD AND @VTD

				SET @STRVACDAYS = @STRVACDAYS + @EncashDays

				SELECT @STRFROMDATERANGE = ISNULL(@STRFROMDATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @VFD), 106)
					,@STRTODATERANGE = ISNULL(@STRTODATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @VTD), 106)
				FROM #TABVAC
				WHERE ID = @J

				SET @STRFROMDATERANGE = @STRFROMDATERANGE + CHAR(10)
				SET @STRTODATERANGE = @STRTODATERANGE + CHAR(10)

				UPDATE @MonthDays
				SET VACSTARTDATE = @STRFROMDATERANGE
					,VACENDDATE = @STRTODATERANGE
					,VACDAYS = isnull(VACDAYS, 0) + @STRVACDAYS
				WHERE EMPNODE = @EID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @FMONTH, 106), 4, 8)
					AND ID = @K
			END
			ELSE
			BEGIN
				IF (SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @VTD, 106), 4, 8))
				BEGIN
					SET @VacTaken=0 SET @EnDays=0
					EXEC spPAY_GetVacationLeavesInfo @VFD
						,@TMONTH
						,@EID
						,1
						,1
						,1,@VacTaken OUTPUT,@EnDays OUTPUT

						SET @STRVACDAYS=@VacTaken
				END
				ELSE
					SET @STRVACDAYS = @VDays

				SET @VT=@STRVACDAYS
				
				IF(ISNULL(@Calculatevacdayforvacationperiod,''NO'')=''NO''  AND ISNULL(@CreditDaysBasedOnMP,0)=0)
				BEGIN
					SET @VT=@STRVACDAYS
					
					--UPDATE @MonthDays
					--SET ACTUALDAYS=TOTALDAYS-@VT-ISNULL(@LOPDAYS,0)
					--WHERE EMPNODE = @EID
					--AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8)
					--AND ID = @K

					IF(@CreditDaysCalculation=1)
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays
							SET Days = ROUND((( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1)
							WHERE EMPNODE = @EID
							AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8)
							AND ID = @K
						ELSE
							UPDATE @MonthDays
							SET Days = (( CAST(ACTUALDAYS AS FLOAT) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT))
							WHERE EMPNODE = @EID
							AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8)
							AND ID = @K

					END
					ELSE
					BEGIN
						IF(@RoundOffVacDays=1)
							UPDATE @MonthDays
							SET Days =  ROUND((( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ),2,1) 
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K
						ELSE
							UPDATE @MonthDays
							SET Days =  (( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) 
							WHERE EMPNODE = @EID AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) AND ID = @K
					END
				END

				SET @EncashDays = 0

				Select @EncashDays = SUM(EncashDays)
				From #ALLEMPVACDATA WITH (NOLOCK)
				WHERE EmpSeqNo= @EID 
				AND FromDate BETWEEN @VFD AND @VTD


				SET @STRVACDAYS = @STRVACDAYS + @EncashDays


				SELECT @STRFROMDATERANGE = ISNULL(@STRFROMDATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @VFD), 106)
					,@STRTODATERANGE = ISNULL(@STRTODATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @TMONTH), 106)
				FROM #TABVAC
				WHERE ID = @J

				SET @STRFROMDATERANGE = @STRFROMDATERANGE + CHAR(10)
				SET @STRTODATERANGE = @STRTODATERANGE + CHAR(10)
				
				UPDATE @MonthDays
				SET VACSTARTDATE = @STRFROMDATERANGE
					,VACENDDATE = @STRTODATERANGE
					,VACDAYS = isnull(VACDAYS, 0) + @STRVACDAYS
				WHERE EMPNODE = @EID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8)
					AND ID = @K
			END
		END
		ELSE
		BEGIN
			IF (@VTD <= @TMONTH)
			BEGIN
				IF (SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @VTD, 106), 4, 8))
				BEGIN
					SET @VacTaken=0 SET @EnDays=0
					EXEC spPAY_GetVacationLeavesInfo @FMONTH
						,@VTD
						,@EID
						,1
						,1
						,1,@VacTaken OUTPUT,@EnDays OUTPUT

						SET @STRVACDAYS=@VacTaken
				END
				ELSE
					SET @STRVACDAYS = @VDays
				
				SET @VT=@STRVACDAYS

				SELECT @STRFROMDATERANGE = ISNULL(@STRFROMDATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @FMONTH), 106)
					,@STRTODATERANGE = ISNULL(@STRTODATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @VTD), 106)
				FROM #TABVAC
				WHERE ID = @J

				SET @STRFROMDATERANGE = @STRFROMDATERANGE + CHAR(10)
				SET @STRTODATERANGE = @STRTODATERANGE + CHAR(10)

				UPDATE @MonthDays
				SET VACSTARTDATE = @STRFROMDATERANGE
					,VACENDDATE = @STRTODATERANGE
					,VACDAYS = isnull(VACDAYS, 0) + @STRVACDAYS
				WHERE EMPNODE = @EID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @VTD, 106), 4, 8)
					AND ID = @K
			END
			ELSE
			BEGIN
			
				IF (SUBSTRING(CONVERT(VARCHAR(12), @VFD, 106), 4, 8) <> SUBSTRING(CONVERT(VARCHAR(12), @VTD, 106), 4, 8))
				BEGIN
					SET @VacTaken=0 SET @EnDays=0
					EXEC spPAY_GetVacationLeavesInfo @FMONTH
						,@TMONTH
						,@EID
						,1
						,1
						,1,@VacTaken OUTPUT,@EnDays OUTPUT

						SET @STRVACDAYS=@VacTaken
						
				END
				ELSE
					SET @STRVACDAYS = @VDays

				SET @VT=@STRVACDAYS

				SELECT @STRFROMDATERANGE = ISNULL(@STRFROMDATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @FMONTH), 106)
					,@STRTODATERANGE = ISNULL(@STRTODATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, @TMONTH), 106)
				FROM #TABVAC
				WHERE ID = @J

				SET @STRFROMDATERANGE = @STRFROMDATERANGE + CHAR(10)
				SET @STRTODATERANGE = @STRTODATERANGE + CHAR(10)

				UPDATE @MonthDays
				SET VACSTARTDATE = @STRFROMDATERANGE
					,VACENDDATE = @STRTODATERANGE
					,VACDAYS = isnull(VACDAYS, 0) + @STRVACDAYS
				WHERE EMPNODE = @EID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @FMONTH, 106), 4, 8)
					AND ID = @K
			END
		END
		
		FETCH NEXT FROM CUR2 INTO @J,@VFD,@VTD,@VDays
	END
	CLOSE CUR2
	DEALLOCATE CUR2
	
	--START-- FINAL SETTLEMENT ENCASH DAYS
		SET @FSENCASHDAYS=0
				SELECT @FSENCASHDAYS=ISNULL(SUM(FSEncashDays),0) 
				FROM #ALLEMPFSENCASHDATA WITH (NOLOCK)
				WHERE EmpSeqNo= @EID 
				AND ResgDate BETWEEN @FMONTH AND @TMONTH

				SELECT @STRFROMDATERANGE = ISNULL(@STRFROMDATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, ResgDate), 106)
					,@STRTODATERANGE = ISNULL(@STRTODATERANGE, '''') + CONVERT(NVARCHAR, CONVERT(DATETIME, ResgDate), 106)
					FROM #ALLEMPFSENCASHDATA WITH (NOLOCK)
					WHERE EmpSeqNo= @EID 
					AND ResgDate BETWEEN @FMONTH AND @TMONTH

				SET @STRFROMDATERANGE = @STRFROMDATERANGE + CHAR(10)
				SET @STRTODATERANGE = @STRTODATERANGE + CHAR(10)
				

				UPDATE @MonthDays
				SET VACSTARTDATE = @STRFROMDATERANGE
					,VACENDDATE = @STRTODATERANGE 
					,VACDAYS = isnull(VACDAYS, 0) + @FSENCASHDAYS
					WHERE EMPNODE = @EID
					AND SUBSTRING(CONVERT(VARCHAR(12), FDATE, 106), 4, 8) = SUBSTRING(CONVERT(VARCHAR(12), @FMONTH, 106), 4, 8)
					AND ID = @K
	--END-- FINAL SETTLEMENT ENCASH DAYS


	--if(@k=44)
	--SELECT @ACVDAYS,VACDAYS FROM @MonthDays WHERE ID = @K

	select @FDate=FDate,@TDate=TDate,@BDays=(BALANCE - VACDAYS) FROM @MonthDays WHERE ID = @K AND EMPNODE = @EID

IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #ALLEMPVACDATA WITH (NOLOCK) WHERE EmpSeqNo=@EID AND ToDate BETWEEN @FDate AND @TDate AND ExcessDays>0 AND @BDays<0 ) AND ISNULL(@CreditDaysBasedOnMP,0)=0)
	BEGIN
		declare @RDays FLOAT
		SET @RDays=0
		IF(@VTD<@TDate)
		BEGIN
			IF(@RoundOffVacDays=1)
				SELECT @RDays= ROUND((( ((CAST(TOTALDAYS AS FLOAT)-CAST(DATEPART(d,@VTD) AS FLOAT))) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1) 
				FROM @MonthDays  WHERE ID = @K AND VACENDDATE<>''''
			ELSE
				SELECT @RDays= (( ((CAST(TOTALDAYS AS FLOAT)-CAST(DATEPART(d,@VTD) AS FLOAT))) * CAST(DAYSASON AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)) 
				FROM @MonthDays  WHERE ID = @K AND VACENDDATE<>''''
		END
		UPDATE @MonthDays
		SET BALANCE = @RDays
		WHERE ID = @K
		AND EMPNODE = @EID
	END
	ELSE IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #ALLEMPVACDATA WITH (NOLOCK) WHERE EmpSeqNo=@EID AND ((FROMDATE BETWEEN @FDate AND @TDate) or (FromDate<@FDate and TODATE>@TDate)) AND ExcessDays>0 AND @BDays<0 ) AND ISNULL(@CreditDaysBasedOnMP,0)=0 )
	BEGIN
		UPDATE @MonthDays
		SET BALANCE = 0
		WHERE ID = @K
		AND EMPNODE = @EID
	END
	ELSE
	BEGIN
		UPDATE @MonthDays
		SET BALANCE = (BALANCE - VACDAYS)
		WHERE ID = @K
		AND EMPNODE = @EID
	END
-----------------
FETCH NEXT FROM CUR1 INTO @K,@FMONTH,@TMONTH,@EID
END
CLOSE CUR1
DEALLOCATE CUR1
	
UPDATE T
SET T.OPENINGBAL = T.OPENINGBAL + (T1.DAYS)
	,T.BALANCE = T.BALANCE + T1.DAYS
FROM @MonthDays T1
	,@MonthDays T
WHERE T.EMPNODE = T1.EMPNODE
	AND T1.FDATE = T.OPBDATE
	AND T1.FDATE < @STARTDATE

UPDATE T
SET T.DAYS = T.DAYS + (
		SELECT SUM(DAYS)
		FROM @MONTHDAYS T1
		WHERE T1.EMPNAME <> ''OPENING''
			AND T1.EMPNODE = T.EMPNODE
			AND T1.FDATE < @STARTDATE
			AND T1.FDATE <> isnull(T.OPBDATE,0)
		)
	,T.BALANCE = T.BALANCE + (
		SELECT SUM(DAYS)
		FROM @MONTHDAYS T1
		WHERE T1.EMPNAME <> ''OPENING''
			AND T1.EMPNODE = T.EMPNODE
			AND T1.FDATE < @STARTDATE
			AND T1.FDATE <> isnull(T.OPBDATE,0)
		)
FROM @MONTHDAYS T
WHERE T.EMPNAME = ''OPENING''

UPDATE T
SET T.DAYS = T.DAYS - (
		SELECT SUM(VACDAYS)
		FROM @MONTHDAYS T1
		WHERE T1.EMPNAME <> ''OPENING''
			AND T1.EMPNODE = T.EMPNODE
			AND T1.FDATE < @STARTDATE
			AND T1.FDATE <> isnull(T.OPBDATE,0)
		)
	,T.BALANCE = T.BALANCE - (
		SELECT SUM(VACDAYS)
		FROM @MONTHDAYS T1
		WHERE T1.EMPNAME <> ''OPENING''
			AND T1.EMPNODE = T.EMPNODE
			AND T1.FDATE < @STARTDATE
			AND T1.FDATE <> isnull(T.OPBDATE,0)
		)
FROM @MONTHDAYS T
WHERE T.EMPNAME = ''OPENING''

UPDATE @MonthDays
SET Days = isnull(Days, 0) + OPENINGBAL
	,Balance = isnull(Days, 0) + OPENINGBAL
FROM @MonthDays
WHERE EMPNAME = ''OPENING''

SELECT *
FROM @MonthDays
WHERE EMPNAME = ''OPENING''

UNION

SELECT *
FROM @MonthDays
WHERE EMPNAME <> ''OPENING''
	AND FDATE >= @STARTDATE

DROP TABLE #TABVAC

DROP TABLE #VMDD
DROP TABLE #VacMonthWiseAllotedDays

DROP TABLE #ALLEMPVACDATA
DROP TABLE #ALLVACMGTDATA
DROP TABLE #ALLEMPMONDATA
DROP TABLE #ALLEMPFSENCASHDATA


SET NOCOUNT OFF


' 
END
GO
/****** Object:  StoredProcedure [dbo].[spPAY_RptVacationDays]    Script Date: 22-01-2026 15:28:11 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptVacationDays]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE procedure [dbo].[spPAY_RptVacationDays]
@Date DateTime,
@EmpWhere NVARCHAR(MAX),
@Flag INT=0,
@Type INT=1,
@ToDate DATETIME,
@UserID Int=1,
@LangID Int=1
AS
Begin
SET NOCOUNT ON;

--START-- Variable Declaration
DECLARE @I INT,@CNT INT,@EmpNode INT,@Grade Int,@AssingedDimVacDays Int,@AssingedLeaveType INT,@COMPONENTIDSNO Int,@TMONTHS Int,@CreditDaysCalculation Int,@TMP INT,@RC1 Int
Declare @DimVacDays float,@BelowSixMonthsDays float,@BelowOneYearDays float,@TotalDays float,@OPVACATIONDAYS FLOAT,@OPVACATIONSALARY FLOAT,@VacationMonthsDiff float,@VACDAYSPERMONTH float,@MonthlyNoofDays float,@LEAVESTAKEN FLOAT,@LeavesTakenEncash FLOAT,@LeavesTakenEncashSUM FLOAT,@LOPDAYS FLOAT,@PaidDays FLOAT,@ExcessDays FLOAT

DECLARE @sQ NVARCHAR(MAX),@CalculateVacDayforVacationPeriod Varchar(3),@ConsiderLOPwhilecalculatingCreditdays Varchar(3),@ConsiderExcessdaysasLOP Varchar(3),@Perdaysalarycalculations Varchar(50),@GradewiseVacationPref Varchar(5),@CalcVacdaysuptoLastMonth Varchar(5),@DCNUMFILED Varchar(10),@SYCOLNAME Varchar(15),@STRQRY Varchar(MAX),@AccrueVacationDaysPref nvarchar(5),@VACDAYSPERIOD Varchar(20)

DECLARE @OPLeavesAsOn DateTime,@PayrollDate DATETIME,@ActDOJ DateTime ,@DocMonth DateTime,@DOJ DateTime,@VACATIONSTARTMONTH DateTime,@MONT1 DateTime,@MONT2 DateTime,@ActualVacDate DateTime
DECLARE @K INT,@ACVDAYS FLOAT,@DonotshownegitiveOPvacationdays NVARCHAR(10),@FDate datetime,@TDate datetime,@BDays float,@VTD datetime,@BAL FLOAT,@MaxCarryForwardDays FLOAT
--END-- Variable Declaration

--START-- TEMP TABLES
DECLARE @EMPDETAILS TABLE(ID INT IDENTITY,NodeID INT,Code NVARCHAR(MAX),Name NVARCHAR(MAX),OPLeavesAsOn DATETIME,OPVacationDays FLOAT,DOJ DATETIME,VacationPeriod VARCHAR(20),VacDaysPerMonth FLOAT,VacDaysPeriod VARCHAR(20),Grade INT,CDOJ DATETIME)
Declare @GetAvlblLeaves TABLE(Id Int Identity(1,1),AssignedLeaves INT,AvailableLeaves DECIMAL(9,2),FDate DateTime,TDate DateTime,MaxEncashLeaves Float,MaxLeaves Float,ActualAvailableLeaves float)
Declare @MonthDays TABLE(ID INT Identity(1,1),EMPNODE INT,FDATE DateTime,TDATE DateTime,TOTALDAYS FLOAT,ACTUALDAYS FLOAT,DAYS float,LEAVESTAKEN FLOAT,LOPDAYS FLOAT,EncashDays FLOAT,BALANCE FLOAT,DAYSASON float)
DECLARE @VACTABLE TABLE(ID INT IDENTITY,EmployeeID INT,OpeningDays FLOAT,CreditedDays FLOAT,LeavesTaken FLOAT,EncashDays FLOAT,Balance Float,PaidDays FLOAT,ExcessDays FLOAT,MaxCarryForwardDays FLOAT)
--END-- TEMP TABLES
--VMDD
DECLARE @VacMgmtDocID INT, @IsDefineDaysExists BIT
CREATE TABLE #VMDD(FromMonth INT,ToMonth INT,DaysPerMonth FLOAT,ApplyToPrevMonths NVARCHAR(50),WEF DATETIME)
CREATE TABLE #VacMonthWiseAllotedDays(ID INT Identity(1,1),VacMonth DateTime,AllotedDays FLOAT,Yearly FLOAT)
--VMDD

--SET TO FIRST DAY FOR THE GIVEN DATE
SET @PayrollDate=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@Date)),0)

--START:LOADING PREFERENCES
SELECT @DonotshownegitiveOPvacationdays=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''DonotshownegitiveOPvacationdays''
SELECT @GradewiseVacationPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE NAME=''GradeWiseVacation''
SELECT @CalcVacDaysuptoLastMonth=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''CalcVacDaysuptolastmonth''
SELECT @AccrueVacationDaysPref=ISNULL(VALUE,''False'') FROM ADM_GlobalPreferences WITH(NOLOCK) WHERE Name=''AccrueVacationDays''

IF(@Flag=1 OR @Flag=2)
	SET @CalcVacDaysuptoLastMonth=''False''
-- END:LOADING PREFERENCES

--START-- DOCUMENTS DATA
SELECT a.voucherno,a.InvDocDetailsID,d.dcAlpha1,d.dcAlpha2,d.dcAlpha3,b.dcCCNID51,ISNULL(CONVERT(FLOAT, d.dcAlpha11), 0) as ExcessDays,CONVERT(FLOAT,ISNULL(d.dcAlpha10,0)) as PaidDays 
INTO #TBL3
FROM INV_DocDetails a WITH(NOLOCK) 
JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
WHERE  d.tCostCenterID=40072 and a.StatusID=369

SELECT CC.DCCCNID53,ISNULL(TD.DCALPHA3,''0'') DCALPHA3, ISNULL(TD.DCALPHA4,''0'') DCALPHA4,ISNULL(TD.DCALPHA9,''NO'') DCALPHA9, ISNULL(TD.DCALPHA8,''NO'') DCALPHA8,ISNULL(TD.DCALPHA15,''NO'') DCALPHA15,ISNULL(TD.DCALPHA16,''(FIELD/30)'') DCALPHA16,ISNULL(dcAlpha5,0) dcAlpha5,ISNULL(dcAlpha1,0) dcAlpha1,ISNULL(TD.DCALPHA18,''1'') DCALPHA18,ID.DocID INTO #TVM
FROM INV_DOCDETAILS ID WITH(NOLOCK) 
JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID 
JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
WHERE TD.tCOSTCENTERID=40061

--END-- DOCUMENTS DATA
if(@Type=1)
BEGIN
IF((SELECT COUNT(*) FROM ADM_CostCenterDef WITH(NOLOCK) WHERE CostCenterID=50051 and SysColumnName =''CCNID53'' and IsColumnInUse=1 and UserProbableValues=''H'')>0)
BEGIN
	SET @sQ=''SELECT C51.NodeID,C51.Code,C51.Name,CONVERT(DateTime,OPLeavesAsOn) OPLeavesAsOn,isnull(OpVacationDays,0) OpVacationDays,CONVERT(DateTime,DOJ) DOJ,VACATIONPERIOD,ISNULL(VACDAYSPERMONTH,0) VACDAYSPERMONTH,VACDAYSPERIOD,ISNULL(H.HistoryNodeID,0),CONVERT(DateTime,DOJ)  FROM COM_CC50051 C51 WITH(NOLOCK)
	LEFT JOIN COM_HistoryDetails H WITH(NOLOCK) ON H.NodeID=C51.NodeID AND CostCenterID=50051 AND HistoryCCID=50053 AND (CONVERT(DATETIME,FromDate)<=CONVERT(DATETIME,''''''+ CONVERT(VARCHAR,@PayrollDate) +'''''')) AND (CONVERT(DATETIME,ToDate)>=CONVERT(DATETIME,''''''+ CONVERT(VARCHAR,@PayrollDate) +'''''') OR ToDate IS NULL)
	WHERE C51.IsGroup=0 AND C51.NODEID>1 AND C51.NODEID IN (''+@EmpWhere+'')''
END
ELSE
BEGIN
	SET @sQ=''SELECT C51.NodeID,C51.Code,C51.Name,CONVERT(DateTime,OPLeavesAsOn) OPLeavesAsOn,isnull(OpVacationDays,0) OpVacationDays,CONVERT(DateTime,DOJ) DOJ,VACATIONPERIOD,ISNULL			(VACDAYSPERMONTH,0) VACDAYSPERMONTH,VACDAYSPERIOD,ISNULL(CC.CCNID53,0) ,CONVERT(DateTime,DOJ) FROM COM_CC50051 C51 WITH(NOLOCK)
	JOIN COM_CCCCDATA CC WITH(NOLOCK) ON CC.NodeID=C51.NodeID AND CostCenterID=50051
	WHERE C51.IsGroup=0 AND C51.NODEID>1 AND C51.NODEID IN (''+@EmpWhere+'')''
END
END
ELSE IF(@Type=100)
BEGIN
	SET @sQ=''SELECT C51.NodeID,C51.Code,C51.Name,CONVERT(DateTime,OPLeavesAsOn) OPLeavesAsOn,isnull(OpVacationDays,0) OpVacationDays,CONVERT(DateTime,DOJ) DOJ,VACATIONPERIOD,ISNULL			(VACDAYSPERMONTH,0) VACDAYSPERMONTH,VACDAYSPERIOD,ISNULL(CC.CCNID53,0) CCNID53,DATEADD(YEAR,YEAR(CONVERT(DATETIME,''''''+CONVERT(VARCHAR,@DATE)+''''''))-YEAR(CONVERT(DATETIME,DOJ)),CONVERT(DATETIME,DOJ)) CDOJ   FROM COM_CC50051 C51 WITH(NOLOCK)
	JOIN COM_CCCCDATA CC WITH(NOLOCK) ON CC.NodeID=C51.NodeID AND CostCenterID=50051
	WHERE C51.IsGroup=0 AND C51.NODEID>1 AND DATEADD(YEAR,YEAR(CONVERT(DATETIME,''''''+CONVERT(VARCHAR,@DATE)+''''''))-YEAR(CONVERT(DATETIME,DOJ)),CONVERT(DATETIME,DOJ)) BETWEEN CONVERT(DATETIME,''''''+CONVERT(VARCHAR,@DATE)+'''''') AND CONVERT(DATETIME,''''''+CONVERT(VARCHAR,@ToDate)+'''''') AND C51.NODEID IN (''+@EmpWhere+'')''
END

print @sQ
INSERT INTO @EMPDETAILS
EXEC sp_executesql @sQ

SELECT @CNT=COUNT(*) FROM @EMPDETAILS
SET @I=1
WHILE(@I<=@CNT)--START--EMPLOYEE LOOP
BEGIN


BEGIN
SET @GRADE=0 SET @DimVacDays=0 SET @LeavesTakenEncashSUM=0.0 SET @LEAVESTAKEN=0 SET @LeavesTakenEncash=0 SET @PaidDays=0 SET @ExcessDays=0
Create Table #VACDAYTAB (VACDAYS float)

TRUNCATE TABLE #VMDD
TRUNCATE TABLE #VacMonthWiseAllotedDays
END  

SELECT @EmpNode=NODEID,@Date=CASE WHEN @TYPE=100 THEN CDOJ ELSE @Date END FROM @EMPDETAILS WHERE ID=@I

IF (@GRADEWISEVACATIONPREF=''True'')
BEGIN
SELECT @Grade=GRADE FROM @EMPDETAILS WHERE ID=@I
END

IF ISNULL(@GRADE,0)=0
	SET @GRADE=1
	
SELECT @BelowSixMonthsDays=ISNULL(DCALPHA3,''0''), @BelowOneYearDays=ISNULL(DCALPHA4,''0''), @CalculateVacDayforVacationPeriod=ISNULL(DCALPHA9,''NO''), 
	   @ConsiderLOPwhilecalculatingCreditdays=ISNULL(DCALPHA8,''NO''),@ConsiderExcessdaysasLOP=ISNULL(DCALPHA15,''NO''),@PERDAYSALARYCALCULATIONS=ISNULL(DCALPHA16,''(FIELD/30)'') ,@AssingedDimVacDays=ISNULL(dcAlpha5,0),@AssingedLeaveType=ISNULL(dcAlpha1,0),
	   @CreditDaysCalculation=ISNULL(DCALPHA18,''1''),
	   @VacMgmtDocID=DocID
FROM   #TVM  WITH(NOLOCK) WHERE  DCCCNID53=@Grade	

IF(@TYPE=100)
BEGIN
 SELECT @MaxCarryForwardDays=ISNULL(MaxCarryForwardDays,0) FROM COM_CC50054 WITH(NOLOCK) WHERE GRADEID=@Grade AND COMPONENTID=@AssingedLeaveType	AND PAYROLLDATE=(SELECT MAX(PAYROLLDATE) FROM COM_CC50054  WITH(NOLOCK) WHERE CONVERT(DATETIME,PAYROLLDATE)<=CONVERT(DATETIME,@Date) AND GradeID=@Grade)
END

--START :GET DOJ,VACATIONPERIOD AND VACATION DAYS,OPLeavesAsOn,OpVacationDays FROM EMPLOYEE
SELECT @OPLeavesAsOn=CONVERT(DateTime,OPLeavesAsOn),@OPVACATIONDAYS=isnull(OpVacationDays,0),@DOJ=CONVERT(DateTime,DOJ),@VACDAYSPERMONTH=ISNULL(VACDAYSPERMONTH,0),@VACDAYSPERIOD=VACDAYSPERIOD FROM @EMPDETAILS WHERE NODEID=@EmpNode
SET @ActDOJ=@Doj
IF(CONVERT(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'')
	SET @DOJ=@OPLeavesAsOn
--END :GET DOJ,VACATIONPERIOD AND VACATION DAYS,OPLeavesAsOn,OpVacationDays FROM EMPLOYEE

--VMDD
SET @IsDefineDaysExists=0
IF EXISTS (SELECT SeqNo FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID)
BEGIN
	SET @IsDefineDaysExists=1
	INSERT INTO #VMDD
	SELECT FromMonth,ToMonth,DaysPerMonth,ApplyToPrevMonths,WEF 
	FROM PAY_VacManageDefineDays WITH(NOLOCK) WHERE VMDocID=@VacMgmtDocID

	DECLARE @VacationDefBasedOn INT
	select @VacationDefBasedOn=ISNULL(PrefValue,1) from COM_DocumentPreferences WITH(NOLOCK) WHERE PrefName=''VacationDefBasedOn''

	declare @dtt1 datetime,@dtt2 datetime,@TotMon INT,@AllotedDays FLOAT,@MNo INT,@APM NVARCHAR(50),@YearlyVD FLOAT
	set @dtt1=dateadd(day,-datepart(day,@ActDOJ)+1,@ActDOJ)
	set @dtt2=dateadd(day,-datepart(day,@Date)+1,@Date)
	set @dtt2=DATEADD(year,1,@dtt2) -- adding extra 1 year to know the yearly vacation days
	SET @MNo=0
	WHILE(@dtt1<=@dtt2)
	BEGIN
		SET @MNo=@MNo+1

		IF(ISNULL(@VacationDefBasedOn,1)=1)
			SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WITH(NOLOCK) WHERE @MNo BETWEEN FromMonth AND ToMonth
		ELSE
			SELECT TOP 1 @AllotedDays=DaysPerMonth/12,@APM=ApplyToPrevMonths FROM #VMDD WITH(NOLOCK) WHERE WEF<=@dtt1 ORDER BY WEF DESC
			
		SELECT @AllotedDays=DaysPerMonth,@APM=ApplyToPrevMonths FROM #VMDD WITH(NOLOCK) WHERE @MNo BETWEEN FromMonth AND ToMonth
		INSERT INTO #VacMonthWiseAllotedDays
		SELECT @dtt1,@AllotedDays,-1

		IF(@APM=''Yes'')
			UPDATE #VacMonthWiseAllotedDays SET AllotedDays=@AllotedDays

		IF(@MNo%12)=0
		BEGIN
			SELECT @YearlyVD=SUM(AllotedDays) FROM #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE Yearly=-1
				
			IF(@APM=''Yes'')
				UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD
			ELSE
				UPDATE #VacMonthWiseAllotedDays SET Yearly=@YearlyVD WHERE Yearly=-1

		END

		SET @dtt1=DATEADD(month,1,@dtt1)
	END

END
--SELECT * FROM #VacMonthWiseAllotedDays
--VMDD

SET @TMP=0
--START : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ
IF ((SELECT count(*)  FROM #TBL3 WITH(NOLOCK)
	 WHERE  DCCCNID51=@EmpNode AND ISNULL(DCALPHA2,'''')<>'''' AND ISNULL(DCALPHA3,'''')<>'''' AND ISNULL(DCALPHA1,'''')<>'''')>0)
BEGIN
	--DATE OF REJOING
	
	SET   @VACATIONSTARTMONTH=@DOJ
	SET @TMP=1
	
	IF (@CalcVacDaysuptoLastMonth=''False'')
		SET @VacationStartMonth=CONVERT(DATETIME,@VacationStartMonth)
	ELSE
		SET @VacationStartMonth=CONVERT(DATETIME,DATEADD(MONTH,DATEDIFF(MONTH,-1,CONVERT(DATETIME,@VacationStartMonth))-2,0))	
	
	--VACATION MONTHS DIFFERENCE
	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))		
	--select @VacationMonthsDiff
	--GET VACDAYS COMPONENT FROM MONTHLY PAYROLL
	select @COMPONENTIDSNO=SNO from COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@AssingedDimVacDays AND GRADEID=@Grade 
	SET @DCNUMFILED=''dcNum''+convert(Varchar,@COMPONENTIDSNO)
	
	SELECT @SYCOLNAME=SYSCOLUMNNAME FROM  adm_costcenterdef WITH(NOLOCK) where costcenterid=40054 AND USERCOLUMNNAME =@DCNUMFILED
	SET @SYCOLNAME=REPLACE(@SYCOLNAME,''dcNum'',''dcCalcNum'')
	
	IF(ISNULL(@SYCOLNAME,'''')<>'''' AND ISNULL(@VACATIONSTARTMONTH,'''')<>'''' AND ISNULL(@DATE,'''')<>'''')
	BEGIN
		SET @STRQRY=''INSERT INTO #VACDAYTAB 
		SELECT  SUM(''+ @SYCOLNAME +'')  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID JOIN							COM_DOCCCDATA CC  WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
		WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@EmpNode) +'' AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DOCDATE) BETWEEN ''''''+ convert											(Varchar,@VACATIONSTARTMONTH) +'''''' and ''''''+ convert(Varchar,@DATE)+''''''''
		--	PRINT (@STRQRY)
		EXEC (@STRQRY)
	END
	
	SELECT @DimVacDays=ISNULL(VACDAYS,0) FROM #VACDAYTAB WITH(NOLOCK)
	DROP TABLE #VACDAYTAB

	declare @VMD FLOAT,@VSM DATETIME
	SET @VSM=@ActDOJ
	--VACATION MONTHS DIFFERENCE
	SET @VMD=DATEDIFF(MONTH,@VSM,DATEADD(DAY,0,@DATE))

	IF ISNULL(@DimVacDays,0)>0
	BEGIN
		SET @MonthlyNoofDays= ROUND((CAST(@DimVacDays AS FLOAT)/ CAST(12 AS FLOAT)),2,1)
	END
	ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD<=6
	BEGIN
		SET @MonthlyNoofDays=@BelowSixmonthsDays
	END
	ELSE IF ISNULL(@DimVacDays,0)=0 AND @VMD>6 And @VMD<=12 
	BEGIN
		SET @MonthlyNoofDays=@BelowOneyearDays
	END
	ELSE
	BEGIN
		IF @VACDAYSPERIOD=''Yearly''
		BEGIN
			SET @TMONTHS=12
		END
		ELSE
		BEGIN
			SET @TMONTHS=1
		END
		SET @MonthlyNoofDays= ROUND((CAST(@VACDAYSPERMONTH AS FLOAT)/CAST(@TMONTHS AS FLOAT)),2,1)
	END							
END
ELSE
BEGIN
	--DATE OF JOINING
	
	print ''DOJ''
	SET   @VACATIONSTARTMONTH=@ActDOJ
	SET @TMP=0
	--VACATION MONTHS DIFFERENCE
	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))
	
	--GET VACDAYS FROM MONTHLY PAYROLL
	select @COMPONENTIDSNO=SNO from COM_CC50054 WITH(NOLOCK) WHERE COMPONENTID=@AssingedDimVacDays AND GRADEID=@Grade 
	SET @DCNUMFILED=''dcNum''+convert(Varchar,@COMPONENTIDSNO)

	SELECT @SYCOLNAME=SYSCOLUMNNAME FROM  adm_costcenterdef WITH(NOLOCK) where costcenterid=40054 AND USERCOLUMNNAME =@DCNUMFILED
	SET @SYCOLNAME=REPLACE(@SYCOLNAME,''dcNum'',''dcCalcNum'')

	IF(ISNULL(@SYCOLNAME,'''')<>'''' AND ISNULL(@VACATIONSTARTMONTH,'''')<>'''' AND ISNULL(@DATE,'''')<>'''')
	BEGIN
		SET @STRQRY=''INSERT INTO #VACDAYTAB 
		SELECT  SUM(''+ @SYCOLNAME +'')  FROM INV_DOCDETAILS ID WITH(NOLOCK) JOIN PAY_DOCNUMDATA DN WITH(NOLOCK) ON ID.INVDOCDETAILSID=DN.INVDOCDETAILSID JOIN COM_DOCCCDATA CC  WITH		(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
		WHERE   CC.DCCCNID51=''+ CONVERT(Varchar,@EmpNode) +'' AND ID.COSTCENTERID=40054 AND CONVERT(DateTime,ID.DOCDATE) BETWEEN ''''''+ convert(Varchar,@VACATIONSTARTMONTH) +'''''' and		''''''+ convert(Varchar,@DATE)+''''''''
		PRINT (@STRQRY)
		EXEC (@STRQRY)
	END
	SELECT @DimVacDays=ISNULL(VACDAYS,0) FROM #VACDAYTAB WITH(NOLOCK)
	DROP TABLE #VACDAYTAB

	--PICKING THE PERMONTH VACDAYS FROM PREFERENCES
	IF @DimVacDays>0
	BEGIN
		SET @MonthlyNoofDays= ROUND((CAST(@DimVacDays AS FLOAT)/CAST(12 AS FLOAT)),2,1)
	END
	ELSE IF @VacationMonthsDiff<=6
	BEGIN
		SET @MonthlyNoofDays=@BelowSixMonthsDays
	END
	ELSE IF @VacationMonthsDiff>6 And @VacationMonthsDiff<=12 
	BEGIN
		SET @MonthlyNoofDays=@BelowOneYearDays
	END
	ELSE
	BEGIN
		IF @VACDAYSPERIOD=''Yearly''
		BEGIN
			SET @TMONTHS=12
		END
		ELSE
		BEGIN
			SET @TMONTHS=1
		END
		SET @MonthlyNoofDays=@VACDAYSPERMONTH/@TMONTHS
	END
END							
--END : CHECKING THE PREVIOUS VACATION DETAILS OF EMPLOYEE IF NO RECORD FOUND THEN SELECT DOJ

	IF(CONVERT(DateTime,@OPLeavesAsOn)<>''Jan  1 1900 12:00AM'' AND @TMP=0 )
		SET @VacationStartMonth=@DOJ

	SET @VacationMonthsDiff=DATEDIFF(MONTH,@VACATIONSTARTMONTH,DATEADD(DAY,0,@DATE))

--IF (ISNULL(@ActualVacDate,'''')='''')
	SET @ActualVacDate=DATEADD(D,-1,@DATE)--CONVERT(DATETIME,@DATE)


PRINT ''AD''
PRINT @ActualVacDate
PRINT @VACATIONSTARTMONTH
PRINT @VacationMonthsDiff
SET @LOPDAYS =0
SET @RC1=0
WHILE(@RC1<=@VacationMonthsDiff)
BEGIN
	IF (@RC1=0)
	BEGIN
		SET @MONT1=DATEADD(MONTH,@RC1,@VACATIONSTARTMONTH)
		IF (@AccrueVacationDaysPref=''False'')
		BEGIN
			IF (@VacationMonthsDiff=0)
			BEGIN
				SET @MONT2=DATEADD(D,-1,@VACATIONSTARTMONTH)
				IF(@MONT2<@MONT1)
					SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@VacationStartMonth)+1,0)))
			END
			ELSE
				SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@VacationStartMonth)+1,0)))
		END					
		ELSE
		BEGIN
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
		END

		--select @VACATIONSTARTMONTH,@MONT1,@MONT2

	END
	ELSE IF (@RC1=@VacationMonthsDiff)
	BEGIN
		SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VACATIONSTARTMONTH),0))
		IF (@AccrueVacationDaysPref=''False'')
		BEGIN
			IF(CONVERT(DATETIME,@ActualVacDate)<CONVERT(DATETIME,@DATE))
			BEGIN
				IF(@Flag=1 OR @Flag=2)
				SET @MONT2=@DATE
				ELSE
				SET @MONT2=DATEADD(D,-1,@DATE)
			END
			ELSE
			BEGIN
			SET @MONT2=DATEADD(D,-1,@ActualVacDate)
			END
		END
		ELSE
		BEGIN
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@ActualVacDate)+1,0)))

		END
		
	END
	ELSE
	BEGIN

		SET @MONT1=DATEADD(MONTH,@RC1,DATEADD(M,DATEDIFF(M,0,@VACATIONSTARTMONTH),0))
		IF (@AccrueVacationDaysPref=''False'')
			SET @MONT2=DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0))
		ELSE
			SET @MONT2=DATEADD(D,0,DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT1)+1,0)))
			

	END

	
---------------------------------------------------

	IF EXISTS ( 
				SELECT InvDocDetailsID
				FROM #TBL3 WITH(NOLOCK)
				WHERE  dcCCNID51=@Empnode 
				AND ( @MONT1 BETWEEN CONVERT(DATETIME,dcAlpha2) AND CONVERT(DATETIME,dcAlpha3) OR 
						@MONT2 BETWEEN CONVERT(DATETIME,dcAlpha2) AND CONVERT(DATETIME,dcAlpha3) OR 
						CONVERT(DATETIME,dcAlpha2) BETWEEN  @MONT1 AND  @MONT2 OR 
						CONVERT(DATETIME,dcAlpha3) BETWEEN  @MONT1 AND  @MONT2 
					)
				)
				BEGIN
					EXEC spPAY_GetVacationLeavesInfoNew @MONT1,@MONT2,@Empnode,1,1,0,@LEAVESTAKEN OUTPUT,@LeavesTakenEncash OUTPUT
				END
				ELSE
				BEGIN
					SET @LEAVESTAKEN=0 SET @LeavesTakenEncash=0
				END
				
				SET @LeavesTakenEncashSUM=@LeavesTakenEncashSUM+@LeavesTakenEncash
				
---------------------------------------------------
	SET @LOPDAYS=0
	IF(@ConsiderLOPwhilecalculatingCreditdays=''Yes'')
	BEGIN
		SELECT @LOPDAYS=ISNULL(TD.DCALPHA9,''0'')  FROM INV_DOCDETAILS ID WITH(NOLOCK) 
		JOIN COM_DOCTEXTDATA TD WITH(NOLOCK) ON ID.INVDOCDETAILSID=TD.INVDOCDETAILSID
			JOIN COM_DOCCCDATA CC WITH(NOLOCK) ON ID.INVDOCDETAILSID=CC.INVDOCDETAILSID
			WHERE TD.tCOSTCENTERID=40054 AND ID.VOUCHERTYPE=11 AND CC.DCCCNID51=@Empnode AND ISDATE(DCALPHA17)=1 AND CONVERT(DATETIME,DCALPHA17)=CONVERT(DATETIME,@MONT1) AND ISDATE(DCALPHA18)=1 AND CONVERT(DATETIME,DCALPHA18)=CONVERT(DATETIME,@MONT2)
			
			IF EXISTS(SELECT SeqNo FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@Empnode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0))
			BEGIN
				SELECT @LOPDAYS=ISNULL(@LOPDAYS,0) - ISNULL(Days,0) FROM PAY_EmpMonthlyAdjustments WITH(NOLOCK) WHERE DAYS<0 AND EmpSeqNo=@Empnode AND AdjMonth=DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DATETIME,@MONT1)),0)
			END  
	END
 
	IF(@CalculateVacDayforVacationPeriod=''Yes'')
		INSERT INTO @MonthDays VALUES(@Empnode,@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,((DATEDIFF(D,@MONT1,@MONT2)+1)-ISNULL(@LOPDAYS,0)),0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),isnull(@LeavesTakenEncash,0),0,0)
	ELSE
		INSERT INTO @MonthDays VALUES(@Empnode,@MONT1,@MONT2,DATEDIFF(D,DATEADD(MONTH,0,DATEADD(M,DATEDIFF(M,0,@MONT1),0)),DATEADD(D,-1,DATEADD(MM,DATEDIFF(M,0,@MONT2)+1,0)))+1,(((DATEDIFF(D,@MONT1,@MONT2)+1)-ISNULL(@LOPDAYS,0))-ISNULL(@LEAVESTAKEN,0)),0,ISNULL(@LEAVESTAKEN,0),ISNULL(@LOPDAYS,0),isnull(@LeavesTakenEncash,0),0,0)
	
	IF(@CreditDaysCalculation=1)
BEGIN
	--((VacDaysPerMonth*MonthDaysToConsider)/TotalMonthDays)
	IF(@IsDefineDaysExists=1)
	BEGIN
		UPDATE @MonthDays 
		SET Days= ROUND((( CAST((Select ISNULL(AllotedDays,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) * CAST(ACTUALDAYS AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ),2,1)		
		WHERE EMPNODE=@Empnode AND TOTALDAYS>0 
	END
	ELSE
	BEGIN		
		UPDATE @MonthDays SET Days= (( CAST(ACTUALDAYS AS FLOAT) * CAST(@MonthlyNoofDays AS FLOAT) )/ CAST(TOTALDAYS AS FLOAT) ) where EMPNODE=@Empnode AND TOTALDAYS>0
	END
END
ELSE
BEGIN
	--((VacDaysPerYear/365)*MonthDaysToConsider)
	IF(@IsDefineDaysExists=1)
	BEGIN
		UPDATE @MonthDays SET Days=(( CAST((Select ISNULL(Yearly,0) From #VacMonthWiseAllotedDays WITH(NOLOCK) WHERE MONTH(VacMonth)=MONTH(FDATE) AND YEAR(VacMonth)=YEAR(FDATE)) AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) WHERE EMPNODE=@Empnode
	END
	ELSE
	BEGIN
		UPDATE @MonthDays SET Days=(( CAST(@VacDaysPerMonth AS FLOAT) / CAST(365 AS FLOAT) )* CAST(ACTUALDAYS AS FLOAT) ) WHERE EMPNODE=@Empnode
	END
END

	-- START DonotshownegitiveOPvacationdays ****************************

SET @K=0
SET @ACVDAYS=0
SET @BDays=0
select @k=id from @MonthDays where EMPNODE=@Empnode AND FDATE=@MONT1 and TDATE=@MONT2
declare @kmin int
select @kmin=min(id) from @MonthDays where EMPNODE=@Empnode

SELECT @ACVDAYS = BALANCE
	FROM @MonthDays
	WHERE EMPNODE=@Empnode AND ID = @K - 1

IF(@K=@kmin)
	UPDATE @MonthDays SET BALANCE = ISNULL(@ACVDAYS,0)+Days+ISNULL(@OPVACATIONDAYS,0) WHERE EMPNODE=@Empnode AND ID=@K
ELSE
	UPDATE @MonthDays SET BALANCE = ISNULL(@ACVDAYS,0)+Days WHERE EMPNODE=@Empnode AND ID=@K


	select @FDate=FDate,@TDate=TDate,@BDays=(BALANCE - LEAVESTAKEN) FROM @MonthDays WHERE EMPNODE=@Empnode AND ID = @K
	
	IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #TBL3 WITH (NOLOCK) WHERE DCCCNID51=@Empnode and convert(datetime,dcAlpha3) BETWEEN @FDate AND @TDate AND ExcessDays>0 AND @BDays<0 ) )

	BEGIN
		declare @RDays FLOAT
		SET @RDays=1
		
		Select @VTD=convert(datetime,dcAlpha3) FROM #TBL3 WITH (NOLOCK) WHERE DCCCNID51=@Empnode and convert(datetime,dcAlpha3) BETWEEN @FDate AND @TDate AND ExcessDays>0

		IF(@VTD<@TDate)
			SELECT @RDays= ROUND((( ((CAST(TOTALDAYS AS FLOAT)-CAST(DATEPART(d,@VTD) AS FLOAT))) * CAST(DAYS AS FLOAT) ) / CAST(TOTALDAYS AS FLOAT)),2,1) FROM @MonthDays  WHERE EMPNODE=@Empnode AND ID = @K
			
			
			
		UPDATE @MonthDays
		SET BALANCE = @RDays
		WHERE EMPNODE=@Empnode AND ID = @K
	END
	else IF( @DonotshownegitiveOPvacationdays=''True'' AND EXISTS (
	Select ExcessDays FROM #TBL3 WITH (NOLOCK) WHERE DCCCNID51=@Empnode AND ((convert(datetime,dcAlpha2) BETWEEN @FDate AND @TDate) or (convert(datetime,dcAlpha2)<@FDate and convert(datetime,dcAlpha3)>@TDate)) AND ExcessDays>0 AND @BDays<0 ) )
	begin
	UPDATE @MonthDays
		SET BALANCE = 0
		WHERE ID = @K
		AND EMPNODE = @Empnode
	end
	ELSE
	BEGIN
		UPDATE @MonthDays
		SET BALANCE = (BALANCE - LEAVESTAKEN-@LeavesTakenEncash)
		WHERE EMPNODE=@Empnode AND ID = @K
	END


-- END DonotshownegitiveOPvacationdays ****************************	
SET @RC1=@RC1+1
END

select @PaidDays=SUM(a.PaidDays),@ExcessDays=SUM(a.ExcessDays) from (
SELECT  PaidDays,ExcessDays
		FROM #TBL3 WITH(NOLOCK)
		WHERE dcCCNID51=@Empnode   
		AND CONVERT(DATETIME,dcAlpha2) <= CONVERT(DATETIME,@DATE)	
		group by voucherno,PaidDays,ExcessDays ) as a

--select * from @MonthDays
--CHECKING PREFERENCE VACATION DAYS UPTO LAST MONTH
IF (@CALCVACDAYSUPTOLASTMONTH=''False'')
	SELECT  @TotalDays=SUM(Days-LeavesTaken) FROM @MonthDays WHERE EMPNODE=@Empnode
ELSE
	SELECT  @TotalDays=SUM(Days-LeavesTaken) FROM @MonthDays WHERE EMPNODE=@Empnode AND CONVERT(DateTime,FDATE)<DATEADD(MONTH,DATEDIFF(MONTH,0,CONVERT(DateTime,@DATE)),0)
--END : CALCULATING PER MONTH DAYS
set @BAL=0
SELECT @BAL=BALANCE FROM @MonthDays WHERE EMPNODE=@Empnode and TDATE=@Date


INSERT INTO @VACTABLE
SELECT @Empnode,@OPVACATIONDAYS,SUM(DAYS),sum(LEAVESTAKEN),@LeavesTakenEncashSUM,
CASE WHEN @DonotshownegitiveOPvacationdays=''TRUE'' THEN ROUND(ISNULL(@BAL,0),2) ELSE Round(ISNULL(@OPVACATIONDAYS,0)+isnull(@TotalDays,0)-isnull(@LeavesTakenEncashSUM,0),2) END
,@PaidDays,@ExcessDays,ISNULL(@MAXCarryForwarddays,0)
--@OPVACATIONDAYS+SUM(DAYS)-sum(LEAVESTAKEN)-@LeavesTakenEncashSUM 
FROM @MonthDays WHERE EMPNODE=@EmpNode

SET @I=@I+1
END--END--EMPLOYEE LOOP
 
 if(@TYPE=100)
SELECT a.*,CASE WHEN @TYPE=100 AND MAXCarryForwarddays>0 AND BALANCE>MAXCarryForwarddays then BALANCE-MAXCarryForwarddays ELSE 0 END ElapseDays,''Yes'' IsVacationElapse,@Date VacFromDate,@Date VacToDate,c51.Code,c51.Name,A.EmployeeID Code_ID FROM @VACTABLE a
join com_cc50051 c51 with(nolock) on  a.EmployeeID=c51.nodeid
else
SELECT * FROM @VACTABLE

DROP TABLE #VMDD
DROP TABLE #VacMonthWiseAllotedDays
DROP TABLE #TBL3
DROP TABLE #TVM

SET NOCOUNT OFF;
END

' 
END
GO
