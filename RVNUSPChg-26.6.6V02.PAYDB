--Nikhil


GO
/****** Object:  StoredProcedure [dbo].[spPAY_RptGetLeaveReports]    Script Date: 14-10-2025 18:16:38 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptGetLeaveReports]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[spPAY_RptGetLeaveReports]
GO
/****** Object:  StoredProcedure [dbo].[spPAY_RptGetLeaveReports]    Script Date: 14-10-2025 18:16:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[spPAY_RptGetLeaveReports]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'

CREATE procedure [dbo].[spPAY_RptGetLeaveReports]
(
	@EmpWhere NVARCHAR(MAX)=NULL,
	@FromDate DATETIME,
	@ToDate DATETIME,
	@Select NVARCHAR(MAX)=null,
	@Group NVARCHAR(MAX)=null,
	@SelectAlias NVARCHAR(MAX)=null,
	@strCCJoin NVARCHAR(MAX)=null,
	@CCWhere NVARCHAR(MAX)=NULL,
	@ReportId INT
	
)
AS
SET NOCOUNT ON

DECLARE @DT1 DATETIME,@DT2 DATETIME
DECLARE @CNT INT,@I INT,@NODEID INT,@TDATYPE NVARCHAR(100),@StartTime NVARCHAR(100),@EndTime NVARCHAR(100),@OT1 FLOAT,@OT2 FLOAT,@OT3 FLOAT,@OT4 FLOAT,@OT5 FLOAT,@GRADE NVARCHAR(500),@LeaveType INT,@EMPNODE INT,@ALStartMonthYear DATETIME,@ALEndMonthYear DATETIME

CREATE TABLE #TAB(ID INT IDENTITY(1,1),NODEID INT,CODE NVARCHAR(500),NAME NVARCHAR(500),Grade NVARCHAR(500),LEAVETYPE NVARCHAR(500),LEAVEYEAR DATETIME,LEAVETYPEID INT,BALANCELEAVES FLOAT,CARRYFORWARD NVARCHAR(200),AVAILABLELEAVES FLOAT,ShowInESS NVARCHAR(50),Gender nvarchar(100),GenderApplicable nvarchar(100))

DECLARE @SysColName NVARCHAR(100),@FType NVARCHAR(100),@AsOnDate DATETIME,@SQL nvarchar(max),@EmpIDs nvarchar(max)

DECLARE @IsGradeWiseMP BIT,@CARRYFORWARD NVARCHAR(100),@AvailInProbation NVARCHAR(50),@ShowInESS NVARCHAR(50),@ShowVacation nvarchar(50),@VacationName nvarchar(500),@vCompID bigint,@Gender nvarchar(100),@GenderBasedOn nvarchar(100),@GenderApplicable NVARCHAR(50)

DECLARE @T1 TABLE(AssignedLeaves FLOAT,AvailableLeaves FLOAT,FromDate DATETIME,ToDate DATETIME,MaxEncashLeaves FLOAT,MaxLeaves FLOAT,ActualAvailableLeaves FLOAT,ThresholdLimit FLOAT)


SET @ASONDATE=GETDATE()

SET @DT1=@FromDate
SET @DT2=@ToDate

	IF(@ReportId=342)
	BEGIN
		
		SET @SQL=''
		SELECT B.CODE AS EMPCODE,B.NAME AS EMPNAME,max(LOC.Name) Location,max(DEP.Name) Department,max(C69.Name) Designation,max(C53.Name) Grade,C.NAME AS LEAVETYPE,SUM(A.ASSIGNEDLEAVES) Allotted,SUM(A.DEDUCTEDLEAVES) Consumed,  CASE CONVERT(FLOAT,SUM(A.OPENINGBALANCE))+CONVERT(FLOAT,SUM(A.ASSIGNEDLEAVES)) WHEN 0 THEN 0 ELSE SUM(A.BALANCELEAVES)  END AS Balance,ROUND(CASE WHEN MAX(ASSIGNEDLEAVES)=0 THEN 0 ELSE (max(DEDUCTEDLEAVES)*100)/max(ASSIGNEDLEAVES) END,2) AS ConsumedPercent,A.LEAVEYEAR ''+@Select+''
FROM PAY_EMPLOYEELEAVEDETAILS A WITH(NOLOCK)  
JOIN COM_CC50051 B WITH(NOLOCK) ON B.NODEID=A.EMPLOYEEID  
JOIN COM_CC50052 C WITH(NOLOCK) ON C.NODEID=A.LEAVETYPEID 
JOIN COM_CCCCData CC WITH(NOLOCK) ON CC.NodeID=B.NodeID AND CC.CostCenterID=50051 ''+@strCCJoin+''
LEFT JOIN COM_Location LOC WITH(NOLOCK) ON LOC.NODEID=CC.CCNID2
LEFT JOIN COM_department DEP with(nolock) on CC.CCNID4=DEP.nodeid
LEFT JOIN COM_CC50069 C69 with(nolock) on CC.CCNID69=C69.nodeid
LEFT JOIN COM_CC50053 C53 with(nolock) on CC.CCNID53=C53.nodeid
WHERE 1=1  AND CC.CCNID51 IN (''+@EmpWhere+'') ''+@CCWhere+''
AND A.LEAVEYEAR BETWEEN ''''''+CONVERT(NVARCHAR,@FromDate)+'''''' AND ''''''+CONVERT(NVARCHAR,@ToDate)+''''''
GROUP BY   B.NODEID,B.CODE,B.NAME,C.NAME,A.LEAVEYEAR''+@Group+''''

		print @SQL
		EXEC(@SQL)


	END

	IF(@ReportId=343)
	BEGIN
		SET @SQL='' 
		SELECT C51.NODEID EmpSeqNo,C51.CODE Code,C51.NAME Name,LOC.NAME Location,DEP.NAME Department,C69.NAME Designation,C53.NAME Grade,CONVERT(DATETIME,dcAlpha4) FromDate,
CASE WHEN dcAlpha15 is not null AND CONVERT(DATETIME,dcAlpha15)<=CONVERT(DATETIME,dcAlpha5) and isnull(dcAlpha6,''''Both'''')=''''Both'''' then  DATEADD(D,-1,CONVERT(DATETIME,dcAlpha15)) else
CONVERT(DATETIME,dcAlpha5)  END ToDate,B.dcCCNID51 EmpSeqNo,dcAlpha6 SESS,B.dcCCNID52 ComponentID,C.NAME AS LEAVETYPE ''+@Select+''
FROM INV_DocDetails a WITH(NOLOCK) 
JOIN COM_DocCCData b WITH(NOLOCK) ON b.InvDocDetailsID=a.InvDocDetailsID
JOIN COM_CC50051 C51 WITH(NOLOCK) ON b.DCCCNID51=C51.NODEID 
JOIN COM_CC50052 C WITH(NOLOCK) ON C.NODEID=b.DCCCNID52 
JOIN COM_CCCCDATA DCC WITH (NOLOCK) ON DCC.NodeID=C51.NodeID AND DCC.CostCenterID=50051 ''+@strCCJoin+''
LEFT JOIN COM_Location LOC WITH(NOLOCK) ON LOC.NODEID=DCC.CCNID2
LEFT JOIN COM_department DEP with(nolock) on DCC.CCNID4=DEP.nodeid
LEFT JOIN COM_CC50069 C69 with(nolock) on DCC.CCNID69=C69.nodeid
LEFT JOIN COM_CC50053 C53 with(nolock) on DCC.CCNID53=C53.nodeid
JOIN COM_DocTextData d WITH(NOLOCK) ON d.InvDocDetailsID=a.InvDocDetailsID
WHERE D.tDocumentType=62 and a.StatusID=369 AND LEN(dcAlpha4)=11 AND LEN(dcAlpha5)=11 AND ISDATE(ISNULL(dcAlpha4,''''''''))=1 AND ISDATE(ISNULL(dcAlpha5,''''''''))=1 
AND DCC.CCNID51 IN (''+@EmpWhere+'') ''+@CCWhere+'' AND (  CONVERT(DateTime,D.DCALPHA4) between CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@FromDate)+'''''') and CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@ToDate)+'''''')
				   or CONVERT(DateTime,D.DCALPHA5) between CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@FromDate)+'''''') and CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@ToDate)+'''''')
				   or CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@FromDate)+'''''') between CONVERT(DateTime,D.DCALPHA4) and CONVERT(DateTime,D.DCALPHA5)
				   or CONVERT(DateTime,''''''+CONVERT(NVARCHAR,@ToDate)+'''''') between CONVERT(DateTime,D.DCALPHA4) and CONVERT(DateTime,D.DCALPHA5)) ''
	
	print @SQL
	EXEC(@SQL)

	END

	IF(@ReportId=344)
	BEGIN
	--START:FOR START DATE AND END DATE OF LEAVE YEAR
	EXEC [spPAY_EXTGetLeaveyearDates] @ToDate,@ALStartMonthYear OUTPUT,@ALEndMonthYear OUTPUT,1

		INSERT INTO #TAB
		SELECT B.NodeID NODEID,B.CODE AS CODE,B.NAME AS NAME,max(C53.Name) Grade,C.NAME AS LEAVETYPE,A.LEAVEYEAR LEAVEYEAR,A.LEAVETYPEID LEAVETYPEID,CASE CONVERT(FLOAT,SUM(A.OPENINGBALANCE))+CONVERT(FLOAT,SUM(A.ASSIGNEDLEAVES)) WHEN 0 THEN 0 ELSE SUM(A.BALANCELEAVES)  END AS BALANCELEAVES,'''',0,'''',max(b.Gender) Gender,''YES'' 
FROM PAY_EMPLOYEELEAVEDETAILS A WITH(NOLOCK)  
JOIN COM_CC50051 B WITH(NOLOCK) ON B.NODEID=A.EMPLOYEEID  
JOIN COM_CC50052 C WITH(NOLOCK) ON C.NODEID=A.LEAVETYPEID 
JOIN COM_CCCCData CC ON CC.NodeID=B.NodeID AND CC.CostCenterID=50051
LEFT JOIN COM_CC50053 C53 with(nolock) on CC.CCNID53=C53.nodeid
where CONVERT(datetime,LEAVEYEAR)=convert(datetime,@ALStartMonthYear)
GROUP BY   B.NODEID,B.CODE,B.NAME,C.NAME,A.LEAVEYEAR,A.LEAVETYPEID

		--EXEC(@SQL)
	
SET @I=1
SELECT @CNT=COUNT(*) FROM #TAB

WHILE(@I<=@CNT)
BEGIN
SELECT @GRADE=GRADE,@LeaveType=LEAVETYPEID,@EMPNODE=NODEID,@Gender=Gender FROM #TAB WHERE ID=@I

SET @CARRYFORWARD=''''
set @GenderApplicable=''No''


	IF (ISNULL(@CARRYFORWARD,'''')=''Monthly'' OR ISNULL(@CARRYFORWARD,'''')=''MonthlyYearly''  OR @AvailInProbation=''No'')
	BEGIN
		INSERT INTO @T1
		EXEC spPAY_ExtGetAssignedLeaves @EMPNODE,@LeaveType,@todate,0,1,1

		IF EXISTS(SELECT * FROM @T1)
		UPDATE #TAB SET CARRYFORWARD=@CARRYFORWARD,AVAILABLELEAVES=(SELECT AvailableLeaves FROM @T1),ShowInESS=UPPER(@ShowInESS),GenderApplicable=UPPER(@GenderApplicable) WHERE ID=@I
	END
	ELSE 
	BEGIN
		UPDATE #TAB SET CARRYFORWARD=@CARRYFORWARD,AVAILABLELEAVES=BALANCELEAVES,ShowInESS=UPPER(@ShowInESS),GenderApplicable=UPPER(@GenderApplicable) WHERE ID=@I
	END

	DELETE FROM @T1
	SET @I=@I+1
END

SET @SQL=''
SELECT T.CODE EMPCODE,T.Name EMPNAME,MAX(LOC.Name) Location,Max(DEP.Name) Department,Max(C69.Name) Designation,Max(Grade) Grade,T.LEAVETYPE,ROUND(SUM(AVAILABLELEAVES),2) AVAILABLELEAVES,T.LEAVEYEAR ''+@Select+'' 
FROM  #TAB T
JOIN COM_CCCCData CC ON CC.NodeID=T.NodeID AND CC.CostCenterID=50051 ''+@strCCJoin+''
LEFT JOIN COM_Location LOC ON LOC.NODEID=CC.CCNID2
LEFT JOIN COM_department DEP on CC.CCNID4=DEP.nodeid
LEFT JOIN COM_CC50069 C69 on CC.CCNID69=C69.nodeid
WHERE 1=1  AND CC.CCNID51 IN (''+@EmpWhere+'') ''+@CCWhere+''
AND T.LEAVEYEAR BETWEEN ''''''+CONVERT(NVARCHAR,@FromDate)+'''''' AND ''''''+CONVERT(NVARCHAR,@ToDate)+''''''
GROUP BY T.CODE,T.Name,T.LEAVETYPE,T.LEAVEYEAR''+@Group+''''
       print @SQL
		EXEC(@SQL)

	END

	IF(@ReportId=345)
	BEGIN
		
		SET @SQL=''
		SELECT B.CODE AS EMPCODE,B.NAME AS EMPNAME,max(LOC.Name) Location,max(DEP.Name) Department,max(C69.Name) Designation,max(C53.Name) Grade,C.NAME AS LEAVETYPE ''+@Select+''
FROM PAY_EMPLOYEELEAVEDETAILS A WITH(NOLOCK)  
JOIN COM_CC50051 B WITH(NOLOCK) ON B.NODEID=A.EMPLOYEEID  
JOIN COM_CC50052 C WITH(NOLOCK) ON C.NODEID=A.LEAVETYPEID 
JOIN COM_CCCCData CC WITH(NOLOCK) ON CC.NodeID=B.NodeID AND CC.CostCenterID=50051 ''+@strCCJoin+''
LEFT JOIN COM_Location LOC WITH(NOLOCK) ON LOC.NODEID=CC.CCNID2
LEFT JOIN COM_department DEP with(nolock) on CC.CCNID4=DEP.nodeid
LEFT JOIN COM_CC50069 C69 with(nolock) on CC.CCNID69=C69.nodeid
LEFT JOIN COM_CC50053 C53 with(nolock) on CC.CCNID53=C53.nodeid
WHERE 1=1  AND CC.CCNID51 IN (''+@EmpWhere+'') ''+@CCWhere+''
AND A.LEAVEYEAR BETWEEN ''''''+CONVERT(NVARCHAR,@FromDate)+'''''' AND ''''''+CONVERT(NVARCHAR,@ToDate)+''''''
GROUP BY   B.NODEID,B.CODE,B.NAME,C.NAME,A.LEAVEYEAR''+@Group+''''

		print @SQL
		EXEC(@SQL)


	END



SET NOCOUNT OFF


' 
END
GO
